# PLAN — P0.1 Реальный чат endpoint в `apps/api`
Дата: 2026-03-01  
Статус: active  

## Результат (какой артефакт получим)
- Новый модуль `rai-chat` в `apps/api` с контроллером `POST /api/rai/chat`.
- Переключенный UI чата в `apps/web` на реальный бэкенд.
- Удаленная или замененная мок-логика в `apps/web/app/api/ai-chat/route.ts`.
- Unit-тест для нового контроллера в API.

## Границы (что входит / что НЕ входит)
- **Входит**: Создание NestJS модуля, контроллера, DTO, интеграция в `AppModule`, переключение `ai-chat-store.ts`, фикс `route.ts` в вебе.
- **Не входит**: Интеграция с LLM, сложная бизнес-логика ответов, новые визуальные виджеты (кроме 1 заглушки).

## Риски (что может пойти не так)
- **Next Route перехват**: `apps/web/app/api/ai-chat/route.ts` может перехватывать `/api/ai-chat` внутри Next и запрос вообще не попадёт в `apps/api`.
- **CORS/Proxy**: ошибки проксирования запроса от `apps/web` к `apps/api:4000`.
- **Tenant Context**: tenant-контекст (`companyId`) может быть не установлен (нет валидной auth-сессии / JWT), и endpoint обязан корректно отказать, а не “подставить дефолт”.
- **Breaking UI**: можно сломать отображение сообщений, если формат ответа backend не совпадёт с тем, что ожидает web-store.

## План работ (коротко, исполнимо)
1. **[API]** Создать `rai-chat.module.ts`, `rai-chat.controller.ts` и `rai-chat.dto.ts`.
2. **[API]** Реализовать `POST /api/rai/chat` детерминированно (без LLM) и **без ручного выбора tenant**:
   - endpoint использует **уже установленный** security/tenant context (из auth middleware/guard),
   - при отсутствии контекста — не 200 (ошибка/401/403), никаких дефолтных `companyId`.
3. **[API]** Подключить `RaiChatModule` в `AppModule`.
4. **[WEB]** Зафиксировать канонический URL для web: **`POST /api/rai/chat`**.
5. **[WEB]** В `ai-chat-store.ts` переключить отправку сообщений на `POST /api/rai/chat` (через существующий proxy `/api/*`).
6. **[WEB]** Разрулить старый путь `/api/ai-chat` так, чтобы он не был источником истины:
   - либо `apps/web/app/api/ai-chat/route.ts` становится **тонким proxy** в `apps/api` (без бизнес-логики),
   - либо web перестаёт его вызывать (и путь считается deprecated).
7. **[CONTRACT]** Сверить/зафиксировать контракт ответа, чтобы web не упал:
   - либо backend отдаёт формат, который web уже умеет читать,
   - либо web делает адаптацию ответа строго в одном месте (store).
8. **[TEST]** Добавить unit/integration тесты для `RaiChatController`:
   - message обязателен (валидация),
   - ответ содержит `text` и `widgets[]`,
   - без auth/tenant контекста endpoint не отдаёт 200.

## DoD
- [ ] Запрос из веб-чата доходит до `apps/api` и возвращается с виджетом.
- [ ] Endpoint не “угадывает” tenant: `companyId` берётся только из доверенного контекста; при отсутствии контекста нет 200.
- [ ] Формат ответа совместим с web-чатом (нет поломки UI).
- [ ] Тесты `npm run test` в `apps/api` проходят успешно.
- [ ] Индекс `interagency/INDEX.md` обновлен.
