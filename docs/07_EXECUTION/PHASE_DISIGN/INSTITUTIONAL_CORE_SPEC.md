# Institutional Core Specification (Phase 4)

## 1. Каноническое Хеширование (Invariant-4.3)

Для обеспечения неизменности (Immutability) всех институциональных действий используется детерминированное хеширование.

### Алгоритм:
1. **Канонизация (RFC8785)**:
   - Все ключи объекта сортируются лексикографически (Unicode).
   - Удаляются все необязательные пробелы и переносы строк.
   - Числа представляются в каноническом формате JSON (без экспонент, если возможно).
   - **Transient Exception**: Ключ `immutableHash` ИСКЛЮЧАЕТСЯ из процесса канонизации перед вычислением нового хеша.
2. **Hashing**:
   - Применяется SHA-256 к полученной UTF-8 строке.
   - Результат представляется в lowercase hex.

```typescript
// Формула:
Hash = SHA256(RFC8785(Effect - {immutableHash}))
```

## 2. Детерминированный Граф (Invariant-4.5)

Пути эскалации вычисляются на основе графа доменов по алгоритму BFS с фиксированным порядком выбора соседей.

### Алгоритм:
1. **Построение списка смежности**:
   - Все рёбра (`DependencyEdge`) группируются по исходному узлу.
   - Для каждого узла список исходящих рёбер **сортируется** по ID целевого узла (`edge.to.localeCompare(edge.to)`).
2. **Поиск пути (Lexicographical BFS)**:
   - Используется очередь (FIFO).
   - При извлечении узла его соседи добавляются в очередь строго в отсортированном порядке.
   - При наличии нескольких кратчайших путей до `STRATEGY`, выбирается тот, который был обнаружен первым (детерминировано порядком сортировки).

## 3. Causal Loops (Recursive Analysis)

Система гарантирует полное перестроение графа эффектов при любом изменении параметров:
1. `RESOLVE_CONFLICT` вызывает переход FSM в состояние `initiated`.
2. Контекст `effects` очищается.
3. Переход в `pending` НЕВОЗМОЖЕН без повторного вызова `ANALYZE_EFFECTS`.
4. Это предотвращает возникновение латентных конфликтов после разрешения первичных противоречий.

---
**Status**: Formal Specification Confirmed.
**Compliance**: Institutional Grade 10/10.
