# Единый Реестр Технического Долга По Кнопкам

## Правило заполнения

Все новые долги добавляются только в этот файл в формате чеклиста.

## Индексация и типизация долга

Каждый пункт долга получает индекс и тип, чтобы задачи выполнялись группами.

Формат индекса:

- `TD-<BUTTON>-<TYPE>-<NNN>`
- Пример: `TD-FARMS-UX-001`

Типы (`TYPE`):

- `UX` — интерфейс, навигация, сценарии, состояния
- `API` — endpoint, DTO, контракты, контроллеры, сервисы
- `DATA` — Prisma/миграции/модели/связи/backfill
- `AI` — индексируемый контекст, теги, классификация, retrieval
- `QA` — e2e/integration/regression тесты
- `PERF` — производительность, пагинация, кеш, дебаунс, профилирование

Правило группового выполнения:

- Сначала закрываем блок одного типа для выбранной кнопки (например, весь `UX` по `Реестр хозяйств`).
- После закрытия блока ставим `[x]` у всех его пунктов и фиксируем дату.
- Только затем переходим к следующему типу.

Обязательный шаблон каждой записи:

- [ ] `[TD-<BUTTON>-<TYPE>-<NNN>]` `Название кнопки` -> `Функция/доработка`  
  Описание: что именно не доделано и где проявляется.  
  Техническое исполнение: какие файлы/модули/endpoint нужно изменить.  
  Приоритет: `High | Medium | Low`.  
  Следующее действие: один конкретный шаг выполнения.  
  Ожидаемый эффект: что улучшится для пользователя/продукта/кода.

## Общий чеклист (по кнопкам)

- [ ] `[TD-FARMS-DATA-001]` `Реестр хозяйств` -> `Выделенная backend-сущность Farm`  
  Описание: текущий контур опирается на `Account/HarvestPlan`, нет отдельной доменной модели хозяйства.  
  Техническое исполнение: добавить модель `Farm` + связи в Prisma; реализовать `/crm/farms` и `/crm/farms/:farmId` на новой сущности; миграции и адаптация frontend-контрактов.  
  Приоритет: `High`.  
  Следующее действие: спроектировать Prisma-модель `Farm` и контракт DTO для `GET /crm/farms/:farmId`.  
  Ожидаемый эффект: корректная бизнес-модель (хозяйство != юрлицо), устойчивый рост функционала карты хозяйства.

- [ ] `[TD-FARMS-AI-001]` `Реестр хозяйств` -> `Централизованный AI-контекст`  
  Описание: теги/кастомные ячейки/заметки пока хранятся локально (localStorage) и не индексируются сервером.  
  Техническое исполнение: добавить backend endpoint `POST/GET /crm/farms/:farmId/context`, хранение в БД, индексатор для AI-поиска.  
  Приоритет: `High`.  
  Следующее действие: создать backend-контракт `farmContext` (tags, cells, note, updatedBy, updatedAt).  
  Ожидаемый эффект: общий контекст доступен всей команде и AI, не теряется между устройствами.

- [ ] `[TD-FARMS-API-001]` `Реестр хозяйств` -> `Блоки “Техника/Ресурсы/Риски/Пост-анализ”`  
  Описание: в карте хозяйства нет полноценных доменных блоков для операционного управления.  
  Техническое исполнение: добавить backend агрегаты и frontend-секции для техники, материалов, риск-триггеров и пост-анализа.  
  Приоритет: `High`.  
  Следующее действие: определить минимальные DTO по 4 блокам и вывести их в read-only режиме на карту хозяйства.  
  Ожидаемый эффект: карта хозяйства становится полноценной рабочей областью “под микроскопом”.

- [ ] `[TD-FARMS-UX-001]` `Реестр хозяйств` -> `Детализация Карты хозяйства (микроскоп-режим)`  
  Описание: текущая карта хозяйства отображает базовые агрегаты, но не покрывает полный рабочий контекст по этапам техкарты и связям сущностей.  
  Техническое исполнение: расширить `/crm/farms/:farmId/map/:companyId` и UI карты секциями: история поля/агрохимия/NDVI, этапы техкарты, ресурсы, риски с триггерами, пост-анализ с отклонениями.  
  Приоритет: `High`.  
  Следующее действие: добавить в API контракт `farmMap.details` (diagnostics, operations, risks, postAnalysis) и отрисовать блоки на странице `/consulting/crm/farms/:farmId`.  
  Ожидаемый эффект: менеджер получает целостную карту хозяйства для управленческих решений без переходов по разным экранам.

- [ ] `[TD-FARMS-QA-001]` `Реестр хозяйств` -> `E2E ключевого потока`  
  Описание: отсутствует e2e-сценарий для основного пользовательского маршрута.  
  Техническое исполнение: добавить e2e тест: поиск -> фильтр risk/critical -> переход в карту -> возврат в реестр с сохранением контекста.  
  Приоритет: `Medium`.  
  Следующее действие: создать e2e-спеку и стабилизировать data-testid на элементах фильтра/таблицы/карты.  
  Ожидаемый эффект: снижение регрессий при доработках UI и API.

- [ ] `[TD-CRMHUB-API-001]` `Хозяйства и контрагенты` -> `Реальные API-метрики вместо демо-агрегации`  
  Описание: часть KPI и блоков на `/consulting/crm` формируются из упрощенной клиентской агрегации, а не из выделенного CRM-реестра.  
  Техническое исполнение: добавить backend endpoint сводки CRM (`/crm/summary`) и перевести карточки/KPI/блок последних контрагентов на server-driven ответ.  
  Приоритет: `High`.  
  Следующее действие: определить DTO `crmSummary` (farms/fields/plans/activePlans/latestCounterparties) и подключить в `apps/web/app/consulting/crm/page.tsx`.  
  Ожидаемый эффект: консистентные цифры в CRM-хабе и снижение расхождений между экранами.

- [ ] `[TD-CRMHUB-UX-001]` `Хозяйства и контрагенты` -> `Унификация кодировки текстов UI`  
  Описание: в ряде файлов присутствуют строки с кракозябрами, что снижает качество интерфейса и усложняет поддержку.  
  Техническое исполнение: провести точечную нормализацию кодировки на UTF-8 для страниц CRM и связанных компонентов/сообщений ошибок.  
  Приоритет: `Medium`.  
  Следующее действие: пройти файлы `apps/web/app/consulting/crm/**` и заменить некорректные строки с проверкой линтером.  
  Ожидаемый эффект: чистый читаемый UI-текст и меньше дефектов локализации.

- [ ] `[TD-CRMHUB-QA-001]` `Хозяйства и контрагенты` -> `E2E сценарий “клик -> переход -> подсветка сущности”`  
  Описание: нет автоматической проверки smart routing по `entity` в CRM-хабе и подреестрах.  
  Техническое исполнение: добавить e2e тесты для маршрутов `/consulting/crm`, `/consulting/crm/farms`, `/consulting/crm/counterparties` с проверкой авто-скролла и подсветки `data-focus=true`.  
  Приоритет: `Medium`.  
  Следующее действие: добавить тестовые данные и e2e-спеку на переход из блока “Последние добавленные контрагенты”.  
  Ожидаемый эффект: снижение регрессий навигации и гарантия корректной работы smart routing.

- [ ] `[TD-CRMHUB-API-002]` `Хозяйства и контрагенты` -> `Server-side поиск/фильтрация по CRM-сущностям`  
  Описание: поиск по `entity` на ряде экранов зависит от клиентского списка и не масштабируется на большие объемы данных.  
  Техническое исполнение: реализовать backend endpoint поиска (`/crm/search`) и подключить его в `crm/farms/counterparties` вместо только клиентской фильтрации.  
  Приоритет: `Medium`.  
  Следующее действие: определить контракт поиска (entityType, query, page, pageSize) и внедрить в UI с пагинацией.  
  Ожидаемый эффект: ускорение работы на больших данных и стабильная релевантность поиска.

- [x] `[TD-COUNTERPARTIES-API-001]` `Контрагенты` -> `Расширенный CRUD профиля контрагента` (2026-02-24)  
  Описание: текущий контур закрывает создание/просмотр/привязку к холдингу, но отсутствует редактирование профиля и архивирование/удаление контрагента.  
  Техническое исполнение: добавить endpoint `PATCH /crm/accounts/:id` и soft-delete/архивирование, затем подключить форму редактирования в `apps/web/app/consulting/crm/counterparties/**`.  
  Приоритет: `Medium`.  
  Следующее действие: согласовать DTO обновления `Account` (name, inn, type, holdingId, status) и реализовать API + UI-форму редактирования в карточке контрагента.  
  Ожидаемый эффект: реальный управленческий CRM-цикл по контрагенту без ручных обходов и прямых правок в БД.

- [x] `[TD-COMMERCE-API-001]` `Коммерция` -> `Подключение server-driven данных по 4 разделам` (2026-02-24)  
  Описание: экраны `/commerce/*` реализованы как route stubs без интеграции с backend.  
  Техническое исполнение: подключить `GET /commerce/contracts`, `GET /commerce/fulfillment`, `GET /commerce/invoices`, `GET /commerce/payments` и перевести заглушки на данные API.  
  Приоритет: `High`.  
  Следующее действие: закрыть следующий API-этап через формы `POST/PATCH` для полного бизнес-цикла Commerce.  
  Ожидаемый эффект: раздел Коммерции станет рабочим инструментом, а не только навигационным каркасом.

- [x] `[TD-COMMERCE-UX-001]` `Коммерция` -> `Smart routing с entity/severity и подсветкой` (2026-02-24)  
  Описание: отсутствует контракт фокусировки сущности при переходах между экранами Commerce.  
  Техническое исполнение: внедрить query-параметры `entity`/`severity`, авто-скролл и подсветку целевого блока `data-focus=true` на `/commerce/*`.  
  Приоритет: `Medium`.  
  Следующее действие: расширить deep-link сценарии на формы POST/PATCH-операций Commerce.  
  Ожидаемый эффект: ускорение сценариев операционной навигации и снижение времени поиска нужной записи.

- [x] `[TD-COMMERCE-QA-001]` `Коммерция` -> `E2E сценарий навигации Commerce` (2026-02-24)  
  Описание: нет автоматической проверки потока `клик -> переход -> фокус` для нового раздела меню.  
  Техническое исполнение: добавить e2e-сценарий для перехода из sidebar в `Договоры`, `Исполнение`, `Документы`, `Оплаты` с проверкой URL и отображения целевого экрана.  
  Приоритет: `Medium`.  
  Следующее действие: добавить расширенный e2e-поток для POST/PATCH операций после внедрения UI-форм Commerce.  
  Ожидаемый эффект: снижение регрессий в ключевом навигационном маршруте модуля Коммерции.

- [x] `[TD-GLOBAL-UX-001]` `Глобальный AI Чат` -> `Глобальная видимость и корректное закрытие чата` (2026-02-25)  
  Описание: FAB кнопка AI-чата перекрывалась локальными layout контекстами (stacking context issues) и не была видна вне `(app)`. Фреймворк `framer-motion` зависал при закрытии панели.  
  Техническое исполнение: перенос `AiChatRoot` в базовый `app/layout.tsx`. Замена exit-анимации Framer Motion на стейт-зависимую. Обновление цвета FAB на `bg-slate-900` для контрастности. Установка `z-[100000]`.  
  Приоритет: `High`.  
  Следующее действие: Подключить реальный backend endpoint для AI-чата.  
  Ожидаемый эффект: Стабильный, контрастный операционный виджет, доступный поверх любого модуля платформы.

## Как отмечать выполнение

- Выполненный пункт отмечается как `[x]`.
- В конце строки добавляется дата закрытия в формате `YYYY-MM-DD`.
- Если долг разбит на подзадачи, создаются отдельные чекбоксы, а родительский пункт закрывается только после закрытия всех подзадач.
