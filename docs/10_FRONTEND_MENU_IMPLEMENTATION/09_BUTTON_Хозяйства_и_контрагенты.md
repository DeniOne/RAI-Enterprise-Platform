# Кнопка/экран: Хозяйства и контрагенты (`/consulting/crm`)

## 0. Статус производства кнопки/экрана

- Stage: MVP_READY
- Готовность: 82%
- Дата последнего обновления: 2026-02-24
- Следующий milestone: HARDENING (server-driven summary + e2e smart routing)

## 1. Название кнопки/экрана и бизнес-роль

`Хозяйства и контрагенты` — операционная точка CRM-контура в блоке `Управление Урожаем`, где пользователь получает сводку по хозяйствам/контрагентам и переходит в реестры для действий.

## 2. Целевые маршруты (основной + подмаршруты)

- Основной: `/consulting/crm`
- Подмаршруты:
- `/consulting/crm/farms`
- `/consulting/crm/counterparties`
- `/consulting/crm/fields`
- `/consulting/crm/history`

## 3. Поведение при нажатии (куда ведет, что видит пользователь)

- Действие: клик по пункту меню открывает `/consulting/crm`.
- Эффект: пользователь сразу видит сводные метрики и плитки перехода по CRM-подразделам.
- Действие: на экране отображается блок `Последние добавленные контрагенты` (топ-5) с полями `Наименование`, `Дата`, `Статус`.
- Эффект: руководитель видит оперативную активность менеджера по контрагентам без перехода в детальный реестр.
- Действие: клик по KPI-плиткам и разделам ведет в профильные экраны (`farms`, `counterparties`, `fields`, `history`, `plans`).
- Эффект: сокращается путь от обзора к рабочему действию.

## 4. UI/UX-сценарий

- `loading`
- Действие: при загрузке API выводятся значения `...` и блоки остаются доступными для структуры экрана.
- Эффект: пользователь понимает, что данные загружаются.
- `empty`
- Действие: на `farms` и `counterparties` показывается пустое состояние с CTA-переходом.
- Эффект: пользователь получает следующий шаг вместо тупика.
- `error`
- Действие: показывается сообщение ошибки и кнопка `Повторить запрос`.
- Эффект: восстановление без перезагрузки страницы.
- `permission`
- Действие: при `401/403` показывается явное сообщение о недостатке прав.
- Эффект: прозрачная причина недоступности данных без падения UI.

## 5. Кликабельность блоков и действия

- Действие: клик по KPI `Хозяйства`.
- Переход: `/consulting/crm/farms`.
- Эффект: быстрый вход в реестр хозяйств.
- Действие: клик по KPI `Поля`.
- Переход: `/consulting/crm/fields`.
- Эффект: быстрый вход в реестр полей.
- Действие: клик по KPI `Планы`.
- Переход: `/consulting/plans`.
- Эффект: переход из CRM в плановый контур.
- Действие: клик по KPI `Активные планы`.
- Переход: `/consulting/plans/active`.
- Эффект: фокус на текущем сезоне и активных работах.
- Действие: клик по карточке `Реестр хозяйств`.
- Переход: `/consulting/crm/farms`.
- Эффект: доступ к списку хозяйств и их активности.
- Действие: клик по карточке `Контрагенты`.
- Переход: `/consulting/crm/counterparties`.
- Эффект: доступ к списку контрагентов.
- Действие: клик по карточке `Поля / Объекты`.
- Переход: `/consulting/crm/fields`.
- Эффект: доступ к объектам земельного банка.
- Действие: клик по карточке `История сезонов`.
- Переход: `/consulting/crm/history`.
- Эффект: переход к истории статусов и изменений.
- Действие: клик по `Наименованию` контрагента в блоке `Последние добавленные контрагенты`.
- Переход: `/consulting/crm/counterparties?entity=<наименование>`.
- Эффект: мгновенный переход к конкретному контрагенту с подсветкой строки.
- Действие: клик по ссылке `Открыть весь реестр` в блоке `Последние добавленные контрагенты`.
- Переход: `/consulting/crm/counterparties`.
- Эффект: быстрый переход в полный список для анализа и действий.
- Действие: клик по CTA в empty на `farms`: `Перейти к созданию первого плана`.
- Переход: `/consulting/plans/drafts`.
- Эффект: пользователь сразу начинает заполнять контур данными.
- Действие: клик по CTA в empty на `counterparties`: `Перейти в реестр хозяйств`.
- Переход: `/consulting/crm/farms`.
- Эффект: пользователь продолжает работу в ближайшем релевантном разделе.
- Действие: клик по кнопке `Повторить запрос` в `error` на `crm/farms/counterparties`.
- Переход: без смены маршрута, повторный вызов текущего API.
- Эффект: восстановление данных без перезагрузки и потери контекста.

## 6. Smart routing контракт (`entity`/`severity`, подсветка, авто-скролл)

- Поддерживается параметр `entity` на маршрутах:
- `/consulting/crm` — подсветка карточки раздела.
- `/consulting/crm/farms` — подсветка строки хозяйства.
- `/consulting/crm/counterparties` — подсветка строки контрагента.
- Действие: при наличии `?entity=...` выполняется поиск, подсветка и авто-скролл к `data-focus=true`.
- Эффект: пользователь попадает сразу к нужной сущности из алертов/внешних ссылок.
- Действие: при отсутствии совпадения выводится нейтральное уведомление.
- Эффект: понятный результат даже при устаревшей ссылке.

## 7. API-связки (какие endpoint используются)

- `/registry/fields` (`api.crm.fields`)
- `/consulting/plans` (`api.crm.plans`)

## 8. Критерий готовности MVP

- Клик по меню `Хозяйства и контрагенты` открывает рабочий `/consulting/crm`.
- На ключевых экранах отрабатывают `loading/empty/error/permission`.
- Smart routing по `entity` работает с подсветкой и автоскроллом для `crm`, `farms`, `counterparties`.

## 9. Production-ready checklist

- [ ] заменить демо-данные на реальные API-метрики
- [ ] унифицировать/почистить кодировку текстов (без кракозябр)
- [ ] добавить e2e-сценарий “клик -> переход -> подсветка сущности”

## 10. Технический долг

- Не доделано: нет server-side фильтрации/поиска по сущностям CRM.
- Почему сейчас не сделано: текущий этап закрывает UX-контур и стабильность состояний, без расширения API-контракта.
- Приоритет: Medium.
- Следующий конкретный шаг: добавить endpoint поиска по `entity` в CRM и подключить query-поиск на странице.

## 11. Ссылки на TD-ID в 99_TECH_DEBT_CHECKLIST.md

- TD-CRMHUB-API-001
- TD-CRMHUB-UX-001
- TD-CRMHUB-QA-001
- TD-CRMHUB-API-002



