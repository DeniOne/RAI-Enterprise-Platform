# Кнопка/экран: Реестр хозяйств (`/consulting/crm/farms`)

## 0. Статус производства кнопки/экрана

- Stage: MVP_READY
- Готовность: 86%
- Дата последнего обновления: 2026-02-24
- Следующий milestone: HARDENING (детализация карты хозяйства + централизованный AI-контекст)

## 1. Название кнопки/экрана и бизнес-роль

`Реестр хозяйств` — рабочая область и карта сущности `Хозяйство` (не только дашборд).  
Через карту хозяйства менеджер ведет весь контекст для техкарт: поля, ресурсы, технику, риски, исполнение, пост-анализ и индексируемый AI-контекст.

## 2. Целевые маршруты (основной + подмаршруты)

- Основной: `/consulting/crm/farms`
- Карта хозяйства: `/consulting/crm/farms/:farmId`
- Связанные переходы:
- `/consulting/crm/history`
- `/consulting/plans`
- `/consulting/techmaps`
- `/consulting/crm/fields`

## 3. Поведение при нажатии

- Клик по `Реестр хозяйств` открывает рабочий список хозяйств с KPI и поиском.
- Внизу списка отображаются только `Риск` и `Критично` (операционный фокус).
- Клик по хозяйству открывает `Карту хозяйства` (`/consulting/crm/farms/:farmId`) с микроскоп-режимом по всем релевантным данным.

## 4. UI/UX-сценарий

- `loading`: KPI/блоки/таблицы показывают состояние загрузки.
- `empty`: явное сообщение + CTA на создание первого плана/добавление поля.
- `error`: сообщение об ошибке + `Повторить запрос`.
- `permission`: уведомление о недостатке прав без падения страницы.

## 5. Кликабельность блоков и действия, пути переходов

- KPI `В норме` -> `/consulting/crm/farms?severity=ok`
- KPI `Риск` -> `/consulting/crm/farms?severity=warning`
- KPI `Критично` -> `/consulting/crm/farms?severity=critical`
- Поиск по хозяйствам -> фильтрация по `ID/названию`
- Клик по строке хозяйства -> `/consulting/crm/farms/:farmId`
- `История` в строке -> `/consulting/crm/history?entity=<farmName>`

### Ключевые действия внутри Карты хозяйства

- `Добавить поле` -> переход в карточку/создание поля
- `Добавить технику` -> привязка техники к операциям
- `Добавить ресурс` -> семена/удобрения/СЗР
- `Создать/привязать техкарту`
- `Добавить риск/триггер`
- `Добавить AI-контекст` (теги, кастомные ячейки, заметки)

## 6. Smart routing контракт (`entity`/`severity`, подсветка, авто-скролл)

- На реестре поддерживаются:
- `entity` — фокус по `id/name` хозяйства
- `severity` — фокус по уровню `ok|warning|critical`
- Поведение: подсветка + авто-скролл к `data-focus=true`.
- При отсутствии совпадения: нейтральное уведомление.

## 7. API-связки (текущий контур + целевой контур)

### Текущие (уже используются)

- `/crm/farms/registry/:companyId` (`api.crm.farmsRegistry`) — server-side реестр хозяйств (search/severity/page/pageSize)
- `/crm/farms/:farmId/map/:companyId` (`api.crm.farmMap`) — server-side карта хозяйства
- `/consulting/plans` (`api.crm.plans`)
- `/registry/fields` (`api.crm.fields`)
- `/tech-map` (`api.consulting.techmaps.list`)
- `/users/me` + `/crm/accounts/:companyId` (`api.users.me`, `api.crm.accounts`)

### Целевые (нужны для production-карты хозяйства)

- `GET /crm/farms` — реестр хозяйств (поиск/фильтры/пагинация)
- `GET /crm/farms/:farmId` — полная карта хозяйства
- `POST /crm/farms/:farmId/context` — AI-контекст (теги/ячейки/заметки)
- `POST /crm/farms/:farmId/assets` — техника/ресурсы/привязки к операциям

## 8. Критерий готовности MVP

- Реестр работает как рабочая область: KPI + поиск + риск/критично список.
- Карта хозяйства отображает базовый микроскоп-контекст:
- связь с контрагентом (юрлицом)
- планы/активные планы
- поля/площадь
- техкарты/активные техкарты
- В карте есть ввод допконтекста для ИИ: теги, кастомные ячейки, свободный текст.

## 9. Production-ready checklist

- [ ] ввести отдельную доменную сущность `Farm` (отдельно от `Account/Counterparty`)
- [ ] реализовать backend API карты хозяйства (`/crm/farms*`)
- [ ] добавить блок `Техника и мощности` (пахота/посев/обработка/уборка)
- [ ] добавить блок `Материалы и снабжение` (семена/СЗР/удобрения/остатки)
- [ ] добавить блок `Риски и триггеры` (тип/порог/действие/влияние на урожай)
- [ ] добавить блок `Пост-анализ` (факт, отклонения, причины, выводы)
- [ ] вынести AI-контекст из localStorage в централизованное хранилище + индексацию
- [ ] добавить e2e: поиск -> карта хозяйства -> добавление AI-контекста -> повторное открытие

## 10. Технический долг

- Не доделано:
- пока нет отдельной сущности `Farm` и API-контракта карты хозяйства;
- контекст AI хранится локально (localStorage), не централизован и не индексируется backend;
- блоки `Техника`, `Материалы`, `Риски`, `Пост-анализ` описаны, но не закрыты в данных.

- Почему сейчас не сделано:
- текущий этап закрыл UX и навигационный каркас на доступных endpoint;
- для полного контура требуется расширение backend-домена и схемы хранения.

- Приоритет: `High`

- Следующий конкретный шаг:
- согласовать и внедрить backend-модель `Farm` + endpoint `GET /crm/farms/:farmId`, затем перевести карту хозяйства на server-driven данные.

## 11. Ссылки на TD-ID в 99_TECH_DEBT_CHECKLIST.md

- TD-FARMS-DATA-001
- TD-FARMS-AI-001
- TD-FARMS-API-001
- TD-FARMS-UX-001
- TD-FARMS-QA-001



