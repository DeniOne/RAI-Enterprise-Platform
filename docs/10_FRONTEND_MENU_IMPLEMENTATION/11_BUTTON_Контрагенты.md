# Кнопка/экран: Контрагенты (`/consulting/crm/counterparties`)

## 0. Статус производства кнопки/экрана

- Stage: DONE
- Готовность: 100%
- Дата последнего обновления: 2026-02-24
- Следующий milestone: поддержка и регрессионные проверки

## 1. Название кнопки/экрана и бизнес-роль

`Контрагенты` — CRM-экран управления иерархией сущностей `Холдинг -> Юрлицо -> Хозяйство` с рабочим реестром, карточкой, операционными вкладками и фильтрами.

### Обязательное правило структуры

- `Контрагент` и `Хозяйство` — разные сущности.
- Для `Холдинг` обязательно доступны действия: `Добавить юрлицо`, `Добавить хозяйство`.
- Для `Юрлицо` обязательно доступно действие: `Добавить хозяйство`.
- Совпадение названий не объединяет сущности.

## 2. Целевые маршруты (основной + подмаршруты)

- Основной: `/consulting/crm/counterparties`
- Карточка контрагента: `/consulting/crm/counterparties/:counterpartyId`
- Связанные переходы:
- `/consulting/crm/farms?entity=<name>`
- `/consulting/crm/history?entity=<name>`

## 3. Поведение при нажатии (куда ведет, что видит пользователь)

- Клик по меню `Контрагенты` открывает рабочий реестр.
- В реестре доступны фильтры: `тип`, `статус`, `ответственный`, `риск`.
- Из реестра можно:
- создать `Холдинг` или `Юрлицо`;
- обновить привязку `Юрлица` к `Холдингу`;
- перейти в карточку контрагента;
- перейти в историю и в добавление хозяйства.
- В карточке доступны вкладки: `Профиль`, `Юрлица`, `Поля`, `Задачи`, `Документы`, `Риски`.

## 4. UI/UX-сценарий

- `loading`: загрузка реестра/карточки.
- `empty`: пустой результат по фильтрам или отсутствие записей.
- `error`: сообщение + `Повторить запрос`.
- `permission`: явный отказ при `401/403` без падения UI.

## 5. Кликабельность блоков и действия, пути переходов

- `Добавить юрлицо` (для `Холдинг`) -> префилл формы создания `Юрлица` с `holdingId`.
- `Добавить хозяйство` (для `Холдинг` и `Юрлицо`) -> `/consulting/crm/farms?entity=<name>`.
- `Карточка` (для `Юрлицо`) -> `/consulting/crm/counterparties/:counterpartyId`.
- `История` -> `/consulting/crm/history?entity=<name>`.
- `Сохранить профиль` в карточке -> `PATCH /crm/accounts/:id`.

## 6. Smart routing контракт (`entity`/`severity`, подсветка, авто-скролл)

- На реестре поддерживается `entity`.
- При `?entity=...` выполняется поиск по `id/name/inn`, подсветка строки `data-focus=true` и автоскролл.
- При отсутствии совпадения показывается нейтральное уведомление.
- `severity` не используется на этом экране.

## 7. API-связки (какие endpoint используются)

- `GET /users/me` -> company context.
- `GET /crm/holdings/:companyId` -> список холдингов.
- `POST /crm/holdings` -> создание холдинга.
- `GET /crm/accounts/:companyId?search&type&status&riskCategory&responsibleId` -> реестр юрлиц.
- `POST /crm/accounts` -> создание юрлица.
- `PUT /crm/accounts/:id/holding` -> привязка юрлица к холдингу.
- `GET /crm/accounts/:id/workspace?companyId=...` -> данные вкладок карточки.
- `PATCH /crm/accounts/:id` -> редактирование профиля контрагента.

## 8. Критерий готовности MVP

- Экран работает как операционный CRM-реестр, не как статичная витрина.
- Есть управление иерархией `Холдинг -> Юрлицо -> Хозяйство`.
- Карточка контрагента содержит операционные вкладки (`Юрлица/Поля/Задачи/Документы/Риски`).
- API-валидация блокирует закрытие контрагента (`status=FROZEN`) без связанных хозяйств.

## 9. Production-ready checklist

- [x] добавлен тестовый сценарий в API (`crm.service.spec.ts`) на запрет закрытия структуры без связанных хозяйств (2026-02-24)
- [x] добавлен CRUD для контактов/взаимодействий/обязательств из карточки контрагента (2026-02-24)
- [x] добавлен SLA-блок и выбор ответственного из справочника пользователей компании (2026-02-24)

## 10. Технический долг

- Не доделано: open critical долгов по этой кнопке нет.
- Почему не сделано сейчас: оставлены только расширения следующего контура (интеграции 1С/NDVI-источники/advanced analytics), не блокирующие production-ready MVP.
- Приоритет: Low.
- Следующий конкретный шаг: подключить внешние источники NDVI/документооборота для расширенного аналитического слоя карточки.

## 11. Ссылки на TD-ID в 99_TECH_DEBT_CHECKLIST.md

- открытых TD-ID по кнопке `Контрагенты` нет
