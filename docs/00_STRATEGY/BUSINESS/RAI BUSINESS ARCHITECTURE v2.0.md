О# RAI BUSINESS ARCHITECTURE v2.0

Статус: рабочая версия на основе фактической реализации в коде `RAI_EP`
Метод: анализ кода и структуры проекта (без опоры на документацию)
Дата фиксации: 2026-02-23

---

## 0. Что изменилось относительно v1.0

`v1.0` описывает целевую концепцию. `v2.0` фиксирует, как система реально работает сейчас в коде:

- подтверждён двухконтурный подход (`Back-Office`/`Front-Office`), но он уже реализован как набор модулей и FSM, а не только как концепт;
- подтверждён принцип «ИИ предлагает, человек утверждает», и дополнительно реализованы `pilot/kill-switch/rollout` механизмы;
- подтверждена экономика результата, но фактический контур построен как строгий `ledger + idempotency + panic-mode`, а не просто учёт `Δ`;
- добавлен обязательный технический контур: `tenant isolation`, `outbox`, `audit tamper-evident`, `risk-gates`, `integrity-gates`.

---

## 1. Фактическая системная модель RAI_EP (по коду)

### 1.1 Платформа

- `apps/api` — основной NestJS backend (модульная доменная система).
- `packages/prisma-client/schema.prisma` — единая доменная модель и контракты данных.
- `apps/telegram-bot` — фронтовой полевой интерфейс (действия, подтверждения, наблюдения, advisory feedback).
- `apps/web` — веб-контуры `front-office`, `ofs`, `finance`, `economy`, `knowledge`, `hr`, `gr` (часть экранов пока placeholder).
- `packages/*-engine` — специализированные движки (`risk`, `regenerative`, `rd`, `vector-store`).

### 1.2 Базовые архитектурные законы, реально работающие в коде

- Мультитенантность: `TenantContext + Prisma tenant-scoped access + companyId enforcement + RLS-сессия в finance`.
- Событийность: `OutboxMessage` и доменные события (в т.ч. `task.status.transitioned`, `finance.economic_event.created`).
- Конечные автоматы (FSM):
  - `HarvestPlan` статусы,
  - `TechMap` статусы,
  - `Task` статусы,
  - `Season APL` (16 стадий производства рапса).
- Аудит и прослеживаемость: `AuditService` с tamper-evident подписью в metadata.
- Контуры блокировок: `Risk Gate`, `Integrity Gate`, `Quorum` блокировки, `READ_ONLY/HALTED` режимы тенанта.

---

## 2. Реальный операционный цикл (сквозная логика)

1. Создаётся `HarvestPlan` в `DRAFT`, проходит FSM до `ACTIVE`.
2. На базе плана генерируется и версионируется `TechMap`.
3. `TechMap` не активируется без `Integrity Admission` (техника, ТМЦ, регенеративные инварианты, quorum-блокировки).
4. Из активной карты генерируются `Task` (1 операция = 1 задача), задачи проходят FSM.
5. Полевые данные (`FieldObservation`/Telegram/медиа/гео) идут через `IntegrityGate`.
6. `IntegrityGate` запускает обязательные причинные петли:
   - incident/call -> deviation review + consult thread,
   - weak evidence -> риск в CMR,
   - delay -> стратегический контур,
   - confirmation -> активация активов,
   - measurement -> soil/trust/drift pipeline.
7. При завершении задач факты затрат уходят в `EconomyService` через integration слой.
8. `EconomyService` формирует экономические факты, проводки в ledger, контролирует баланс, идемпотентность и anti-replay.
9. `Advisory` работает в режиме shadow/pilot: рекомендации формируются, но решение фиксируется человеком (`accept/reject/feedback`).

---

## 3. Матрица соответствия: Теория v1.0 -> Фактическая реализация -> Дополнение v2.0

### 3.1 Сущность бизнеса

- Теория v1.0: результатный агроконсалтинг с тех.ядром и монетизацией от прироста.
- Реализация: есть `consulting + tech-map + task + integrity + economy` как единый производственный контур.
- Дополнение v2.0: результат формируется не только agronomy-логикой, но и жесткой `операционной управляемостью состояния` через FSM и инварианты.

### 3.2 Формула бизнеса

- Теория v1.0: `Контекст -> План -> Техкарта -> Исполнение -> Δ -> Монетизация`.
- Реализация: фактически `CRM/Registry -> HarvestPlan FSM -> TechMap FSM + Admission -> Task FSM -> Observation/Integrity -> Economy/Ledger`.
- Дополнение v2.0: между исполнением и монетизацией добавлен обязательный слой `валидации доказательств` и `причинных петель`.

### 3.3 Два контура управления

- Теория v1.0: Back-Office и Front-Office.
- Реализация:
  - Front-Office: `season/agro-orchestrator`, `tech-map`, `task`, `field-observation`, Telegram транспорт.
  - Back-Office: `consulting`, `cmr`, `finance-economy`, `risk`, `strategic`, `hr`, `legal/gr`.
- Дополнение v2.0: добавлен системный `Governance-Contour` (tenant, audit, outbox, quorum, kill-switch, panic-mode).

### 3.4 Ролевая модель

- Теория v1.0: менеджер/агроном/руководство/ИИ.
- Реализация: RBAC и role-checks в контроллерах (`CEO/CFO/ADMIN` на критических решениях), ИИ-советы фиксируются отдельно.
- Дополнение v2.0: явно выделяется роль `оператора governance` (управление pilot/rollout/kill-switch/override).

### 3.5 Поток денег

- Теория v1.0: входы денег и комиссии.
- Реализация: денежный контур реализован как `economic events -> ledger entries -> budget/liquidity dashboards`.
- Дополнение v2.0: вводятся обязательные принципы fintech-уровня: `idempotency`, `replay protection`, `balanced journal`, `tenant panic isolation`.

### 3.6 Стратегический фокус

- Теория v1.0: не SaaS, а интеллектуальный агро-оператор.
- Реализация: подтверждено кодом — приоритет на управление производственными состояниями и рисками, а не на «фичи ради фич».
- Дополнение v2.0: стратегическое ядро = `оператор причинно-следственной целостности результата`.

---

## 4. Обновлённая бизнес-архитектура v2.0

### 4.1 Ядро ценности

`RAI_EP` — это операционная система агрорезультата, где экономический эффект возникает только после прохождения цепочки:

`План -> Технологическая модель -> Операционное исполнение -> Доказанное событие -> Экономическое признание`.

### 4.2 Контуры v2.0

- Производственный контур: `Season/APL`, `TechMap`, `Task`, `Execution`.
- Контур доказательств: `FieldObservation`, `IntegrityGate`, `Trust/Verification`, `Deviation`.
- Контур рисков и решений: `RiskEngine`, `CMR`, `ManagementDecision`, `Quorum`.
- Финансовый контур: `EconomyEvent`, `Ledger`, `Budget`, `Liquidity`, `OFS`.
- Контур ИИ-сопровождения: `ShadowAdvisory`, `Pilot`, `Rollout`, `Kill-Switch`, `Human Feedback`.
- Контур институциональной безопасности: `Tenant isolation`, `Audit`, `Outbox`, `Invariant metrics`, `Read-only halt`.

### 4.3 Инварианты v2.0 (фактически обязательные)

- Нет tenant-контекста -> нет доверенного доступа к данным.
- Нет допустимого FSM-перехода -> нет изменения состояния.
- Нет admission по техкарте -> нет активации плана выполнения.
- Нет доказательности/контекста -> нет признания события в управляющем контуре.
- Нет валидного финансового контракта/идемпотентности -> нет экономической записи.
- Баланс проводок нарушен -> операция блокируется, тенант может уходить в изоляцию.
- ИИ не имеет права финального утверждения производственного/финансового решения.

---

## 5. Уточнённая формула монетизации v2.0

`Монетизация = f(подтверждённый производственный результат, доказанная исполнимость, риск-профиль, финансовая дисциплина)`

Где:

- подтверждённый результат — это не только `Δ`, но и качественная трассировка фактов;
- риск-профиль влияет на скорость и допустимость операционных решений;
- финансовая дисциплина проверяется технически (ledger-инварианты), а не декларативно.

---

## 6. Области расхождения v1.0 и текущей реализации

- Web Back-Office/Front-Office частично в состоянии `placeholder`, при том что backend-контуры уже существенно глубже.
- `Production/Trading` бизнес-блоки (в духе холдинга v1.0) в текущем коде представлены слабее, чем `Consulting/Execution/Finance`.
- Часть advanced-контуров уже есть в API/моделях, но операционная зрелость UI и пользовательских процессов ещё отстаёт.

---

## 7. Итог v2.0

`RAI_EP` фактически реализован как **мультитенантная, событийная, инвариантно-защищённая операционная система управления агрорезультатом**, где:

- теория `v1.0` в основном подтверждена,
- но реальная архитектура глубже и строже за счёт governance/finance/integrity контуров,
- а ключевая единица управления — не «задача», а `доказанное изменение состояния с экономическим следом`.
