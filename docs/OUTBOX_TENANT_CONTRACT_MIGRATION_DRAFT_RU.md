---
id: DOC-OPS-RUN-002
layer: Operations
type: Runbook
status: draft
version: 0.1.0
---

# Outbox Tenant Contract Migration Draft

Р”Р°С‚Р°: 2026-02-15

## Р¦РµР»СЊ
РЈСЃС‚СЂР°РЅРёС‚СЊ tenant ambiguity РІ outbox path Рё РїРѕРґРіРѕС‚РѕРІРёС‚СЊ Р±РµР·РѕРїР°СЃРЅС‹Р№ РїРµСЂРµС…РѕРґ Рє enforce tenant-РєРѕРЅС‚СЂР°РєС‚Сѓ.

## РџСЂРµРґР»Р°РіР°РµРјР°СЏ СЃС…РµРјР° РјРёРіСЂР°С†РёРё
РЁР°Р±Р»РѕРЅ: `expand -> backfill -> validate -> enforce -> contract`

1. Expand
- Р”РѕР±Р°РІРёС‚СЊ РІ `OutboxMessage` РїРѕР»Рµ tenant-РєРѕРЅС‚СЂР°РєС‚Р°:
  - РІР°СЂРёР°РЅС‚ A: `companyId` (nullable РЅР° РїРµСЂРІРѕРј С€Р°РіРµ)
  - РІР°СЂРёР°РЅС‚ B: `tenantScope` JSON (РµСЃР»Рё РµСЃС‚СЊ СЃРёСЃС‚РµРјРЅС‹Рµ СЃРѕР±С‹С‚РёСЏ Р±РµР· tenant)
- Р”РѕР±Р°РІРёС‚СЊ РёРЅРґРµРєСЃ РїРѕ tenant-РїРѕР»СЋ.

2. Backfill
- Р—Р°РїРѕР»РЅРёС‚СЊ tenant-РїРѕР»Рµ РґР»СЏ РёСЃС‚РѕСЂРёС‡РµСЃРєРёС… Р·Р°РїРёСЃРµР№:
  - С‡РµСЂРµР· `aggregateType/aggregateId` lookup.
- РќРµРѕРїСЂРµРґРµР»РёРјС‹Рµ Р·Р°РїРёСЃРё РїРѕРјРµС‡Р°С‚СЊ РєР°Рє `SYSTEM_SCOPE`.

3. Validate
- SQL-РїСЂРѕРІРµСЂРєРё РЅР° РґРѕР»СЋ `NULL/UNKNOWN` Р·Р°РїРёСЃРµР№.
- РћС‚РґРµР»СЊРЅР°СЏ РїСЂРѕРІРµСЂРєР° РґР»СЏ СЃРѕР±С‹С‚РёР№, РёРґСѓС‰РёС… РІ critical processing path.

4. Enforce
- РџРµСЂРµРІРµСЃС‚Рё outbox writer РЅР° РѕР±СЏР·Р°С‚РµР»СЊРЅС‹Р№ tenant-contract.
- Р’РєР»СЋС‡РёС‚СЊ reject Р»РѕРіРёРєРё РґР»СЏ РїСѓР±Р»РёРєР°С†РёР№ Р±РµР· tenant context (РєСЂРѕРјРµ `SYSTEM_SCOPE` whitelist).

5. Contract
- РЎРґРµР»Р°С‚СЊ NOT NULL РёР»Рё СЃС‚СЂРѕРіРёР№ enum policy (РµСЃР»Рё РІС‹Р±СЂР°РЅ РІР°СЂРёР°РЅС‚ A/B).
- РћР±РЅРѕРІРёС‚СЊ relay query/publish РїСЂР°РІРёР»Р° РїРѕРґ tenant-aware РѕР±СЂР°Р±РѕС‚РєСѓ.

## Р РёСЃРєРё
1. РСЃС‚РѕСЂРёС‡РµСЃРєРёРµ СЃРѕР±С‹С‚РёСЏ Р±РµР· РґРѕСЃС‚Р°С‚РѕС‡РЅС‹С… РґР°РЅРЅС‹С… РґР»СЏ backfill.
2. Р›РѕР¶РЅС‹Рµ Р±Р»РѕРєРёСЂРѕРІРєРё РїСЂРё СЃР»РёС€РєРѕРј СЂР°РЅРЅРµРј enforce.

## Rollback
1. Р’РµСЂРЅСѓС‚СЊ writer РІ shadow mode (Р»РѕРіРёСЂРѕРІР°С‚СЊ РІРјРµСЃС‚Рѕ reject).
2. РЎРЅСЏС‚СЊ strict constraint РґРѕ Р·Р°РІРµСЂС€РµРЅРёСЏ РєРѕСЂСЂРµРєС‚РЅРѕРіРѕ backfill.

## РљСЂРёС‚РµСЂРёР№ Р·Р°РІРµСЂС€РµРЅРёСЏ
1. РџСѓР±Р»РёРєР°С†РёСЏ outbox-СЃРѕР±С‹С‚РёСЏ Р±РµР· tenant-РєРѕРЅС‚СЂР°РєС‚Р° РЅРµРІРѕР·РјРѕР¶РЅР° (РєСЂРѕРјРµ whitelist).
2. Р”РѕР»СЏ `UNKNOWN` РІ outbox РЅРµ РїСЂРµРІС‹С€Р°РµС‚ СЃРѕРіР»Р°СЃРѕРІР°РЅРЅС‹Р№ РїРѕСЂРѕРі.
3. Relay РєРѕСЂСЂРµРєС‚РЅРѕ РѕР±СЂР°Р±Р°С‚С‹РІР°РµС‚ tenant-aware СЃРѕР±С‹С‚РёСЏ Р±РµР· cross-tenant СЂРёСЃРєР°.


