---
id: DOC-ARC-GEN-057
type: HLD
layer: Architecture
status: Draft
version: 0.1.0
owners: [@techlead]
last_updated: 2026-02-15
---

1. КЛЮЧЕВОЙ АРХИТЕКТУРНЫЙ ПРИНЦИП (ФИКСИРУЕМ)

❗ Агротехнология ≠ набор микросервисов
Агротехнология = граф управляемых процессов,
а микросервисы = исполнители и хранители состояния.

Поэтому:

Business Core НЕ меняем

RAI Domain расширяем доменами

Агротехнология живёт как Process Layer поверх доменов

AI и Engram — надстройка, а не логика

Это полностью согласуется с:

Router–Solver 

AI_ORCHESTRATION_HUB

Engram как опыт, а не состояние 

ENGRAM_MEMORY_SYSTEM

C4 / Core–Domain separation 

SYSTEM_ARCHITECTURE

2. КАНОНИЧЕСКАЯ СЛОЁНАЯ МОДЕЛЬ (ИТОГОВАЯ)
┌────────────────────────────────────────────┐
│ FRONT / BOT / API                          │
├────────────────────────────────────────────┤
│ AI ORCHESTRATION (Router / Solvers)        │
├────────────────────────────────────────────┤
│ AGRO PROCESS LAYER (NEW)                   │  ← ВОТ ГДЕ ЖИВЁТ 16 ЭТАПОВ
├────────────────────────────────────────────┤
│ RAI DOMAIN SERVICES                        │
├────────────────────────────────────────────┤
│ BUSINESS CORE                              │
├────────────────────────────────────────────┤
│ DATA + EVENTS + ENGRAM                     │
└────────────────────────────────────────────┘

3. ЧТО ТАКОЕ AGRO PROCESS LAYER (КЛЮЧЕВОЕ)

Это НЕ сервис и НЕ БД.

Это:

оркестратор агротехнологических процессов

оперирует этапами, микропроцессами, условиями, блокировками

использует:

Task Engine (из Core)

Audit

Event Bus

НЕ хранит данные полей (это Domain)

4. ПОЛНАЯ КАРТА МОДУЛЕЙ / ДОМЕНОВ / МИКРОСЕРВИСОВ
4.1 BUSINESS CORE (без изменений, но с расширением usage)

Уже есть (канон):

Identity Service

Registry Service

Task Engine

Audit Service

Event Service

Как используются агро-декомпозицией:

каждый микропроцесс = Task

каждый этап = Workflow

каждый косяк = Audit + Negative Engram

✔ Core не знает, что это рапс
✔ Он знает, что это «процесс с этапами и правилами»

4.2 RAI DOMAIN SERVICES (РАСШИРЯЕМ)
Существующие (по архитектуре):

Field Service

Crop Service

Season Service

Operations Service

❗ Добавляем домены (НЕ этапы!)
1. AgroEnvironment Service

Назначение: контекст среды
Сущности:

Погода

Почва

Влага

Климатические риски

Используется в этапах 1, 2, 4, 6, 7, 11

2. Input & Supply Domain

(СЗР, удобрения, семена)

Сущности:

Препарат

Действующее вещество

Партия

Регламент

Остатки

Используется в этапах 4–11

3. Machinery & Fleet Domain

(МТП / технопарк)

Сущности:

Машина

Агрегат

Конфигурация

Телеметрия

Аренда

Используется в этапах 2, 3, 4, 5, 8, 11, 12

4. Quality & Yield Domain

Сущности:

Урожай

Потери

Качество

Масличность

Влажность

Используется в этапах 12–16

5. Storage & Logistics Domain

Сущности:

Партия

Склад

Сушка

Перемещение

Этапы 15–16

6. Compliance & Regulation Domain

Сущности:

ФГИС-партия

Срок ожидания

Экспортные ограничения

Пчёлы / уведомления

Этапы 5, 8, 11, 16

4.3 AGRO PROCESS LAYER (ГЛАВНОЕ)
Ключевые сервисы:
AgroProcess Orchestrator

управляет 16 этапами

знает:

порядок

зависимости

блокировки

НЕ хранит данные

AgroStage Engine

Stage 1 … Stage 16

каждый этап:

Preconditions

Actions

Postconditions

Exit Rules

Пример:

Stage 4 (Сев):
- requires: Stage 3 = completed
- blocks if: soil_moisture < threshold
- emits: sowing.completed

AgroRule Engine

агрономические правила

hard / soft constraints

источник алертов

4.4 AI + ENGRAM (как они встраиваются)
AI НЕ управляет процессом

Он:

анализирует контекст этапа

предлагает решение

объясняет риски

Engram:

пишет Negative Engram, если:

этап выполнен с отклонением

результат плохой

блокирует повтор ошибки через AgroRule Engine

✔ полностью соответствует 

ENGRAM_MEMORY_SYSTEM

5. СООТВЕТСТВИЕ 16 ЭТАПОВ → СИСТЕМА
Этап	Где реализован
1–3	AgroProcess + Field + Environment
4–5	Process + Inputs + Machinery
6–8	Process + Environment + AI
9–11	Process + Compliance + AI
12	Process + Machinery + Quality
13–15	Storage + Quality
16	Compliance + Finance (ERP)
6. ПОЧЕМУ ЭТО ПРАВИЛЬНО (КРИТИЧНО)
❌ Плохой путь

«Этап 4 Service»

«Этап 5 Service»
→ ад микросервисов, дубли данных, мёртвый AI

✅ Твой путь

Core = универсальный

Domain = факты

Process Layer = логика

AI = мозг-советник

Engram = опыт

Это Enterprise-уровень, а не агро-CRM.