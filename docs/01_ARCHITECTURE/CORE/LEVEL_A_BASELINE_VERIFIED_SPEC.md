# 0. Статус документа

- **Система:** RAI_Enterprise_Platform
- **Уровень зрелости:** LEVEL A — Controlled Intelligence
- **Статус верификации:** Формально верифицировано
- **Охваченные инварианты:** I1–I14 (согласно ARCHITECTURAL_TEST_PROTOCOL)
- **Уровни тестирования:** L1–L6

---

# 1. Позиционирование системы (Level A)

На уровне зрелости LEVEL A система функционирует как детерминированная экспертная среда поддержки принятия решений в агрономии. Главной архитектурной целью является обеспечение абсолютной целостности данных, прослеживаемости решений и жестких ограничений на действия ИИ.

- **Роль системы:** Инфраструктура исполнения и контроля (IO & Orchestration).
- **Роль ИИ:** Исключительно Advisor (Советник), Coach (Наставник) и Auditor (Аудитор).
- **Модель полномочий:** Человек является единственным источником инициативы по изменению состояния домена. ИИ действует как вторичный валидатор и аналитик.
- **Архитектурные ограничения:** Прямое влияние ИИ на доменные сущности без премодерации человеком запрещено.

**ИИ НЕ ВЫПОЛНЯЕТ (Level A Explicit Deny):**
- Генерацию полных технологических карт (TechMap).
- Вероятностное моделирование урожайности.
- Симуляцию сценариев «что, если».
- Контрфактический анализ.
- Самостоятельное обучение на лету.
- Автономную модификацию агрономических стратегий.

---

# 2. Модель архитектурных слоев

## 2.1 Structural Layer (Структурный слой)

Слой отвечает за управление жизненным циклом сущностей и соблюдение инвариантов бизнес-процессов.

### Конечный автомат (FSM)
Список состояний TechMap:
1. `DRAFT` — Черновик, доступен для мутаций.
2. `REVIEW` — Проверка, блокировка частичных правок.
3. `APPROVED` — Утверждено, мутации запрещены, ожидание заморозки.
4. `FROZEN` — Заморожено, любая мутация невозможна.

### Матрица переходов состояний
| Текущее состояние | Событие (Event) | Следующее состояние | Допущено | Обоснование |
| :--- | :--- | :--- | :--- | :--- |
| `DRAFT` | `SUBMIT` | `REVIEW` | ДА | Передача на проверку |
| `REVIEW` | `REJECT` | `DRAFT` | ДА | Возврат на доработку |
| `REVIEW` | `APPROVE` | `APPROVED` | ДА | Фиксация решения |
| `APPROVED` | `FREEZE` | `FROZEN` | ДА | Окончательная блокировка |
| `FROZEN` | `EDIT` | `DRAFT` | **НЕТ** | Нарушение I3 (Freeze Irreversibility) |
| `ANY` | `UNAUTHORIZED_JUMP` | `ANY` | **НЕТ** | Нарушение I2 (No Illegal Transition) |

**Диаграмма переходов (ASCII):**
```text
[ DRAFT ] --(SUBMIT)--> [ REVIEW ] --(APPROVE)--> [ APPROVED ] --(FREEZE)--> [[ FROZEN ]]
   ^                        |
   +-------(REJECT)---------+
```

### Доказательство детерминизма (I1)
Для каждого кортежа (Состояние S, Событие E) в коде `AgroOrchestratorService` определен строго один результирующий переход. Любое событие, не входящее в матрицу, выбрасывает `IllegalStateTransitionException`.
**Формальная проверка:** Матрица переходов (раздел 2.1) является функционально полной для домена Level A. Функция перехода `δ(S, E) -> S'` является однозначной.
[Invariant: I1 | Test Level: L4 | Trace: FSM_DET_01]

### Доказательство отсутствия недостижимых состояний (Unreachable States)
Все состояния {`DRAFT`, `REVIEW`, `APPROVED`, `FROZEN`} достижимы из начального состояния `DRAFT` через конечную последовательность событий {`SUBMIT`, `APPROVE`, `FREEZE`}. 
- `DRAFT`: Начальное состояние (Initial).
- `REVIEW`: `δ(DRAFT, SUBMIT)`.
- `APPROVED`: `δ(REVIEW, APPROVE)`.
- `FROZEN`: `δ(APPROVED, FREEZE)`.
Ни одно состояние не изолировано от графа переходов.
[Invariant: I1 | Test Level: L4 | Trace: FSM_REACH_01]

### Доказательство отсутствия тупиков (Deadlocks)
Тупиковым состоянием (Deadlock) в Level A является только терминальное состояние `FROZEN`. 
- В состояниях `DRAFT`, `REVIEW`, `APPROVED` всегда существует как минимум один исходящий переход.
- Состояние `FROZEN` является целевым терминальным состоянием процесса, отсутствие переходов из которого является проектным решением (I3), а не архитектурной ошибкой.
[Invariant: I1 | Test Level: L4 | Trace: FSM_DEADLOCK_01]

### Блокировка запрещенных переходов (I2)
Логика оркестратора проверяет наличие ребра в графе состояний перед выполнением любой операции. Попытки прыжков через состояния атомарно отклоняются IntegrityGate.
[Invariant: I2 | Test Level: L3 | Trace: FSM_GATE_02]

### Необратимость заморозки (I3)
После достижения состояния `FROZEN` любые входящие события мутации (update/delete) блокируются на уровне провайдера данных (Prisma Middleware). Переход из `FROZEN` в любые другие состояния в Level A отсутствует.
[Invariant: I3 | Test Level: L4 | Trace: FSM_FREEZE_01]

### Прослеживаемость решений (I5)
Любое состояние `APPROVED` обязано содержать ссылку на `DecisionRecordID` в метаданных. Сохранение статуса без записи в лог решений невозможно (DB Foreign Key constraint).
[Invariant: I5 | Test Level: L5 | Trace: DECISION_TRACE_01]

---

## 2.2 Immutable Decisions Subsystem (Подсистема неизменяемых решений)

Система логирования и фиксации фактов выбора.

- **Событие утверждения:** Атомарная транзакция, создающая `DecisionRecord` и обновляющая статус сущности.
- **Механизм заморозки:** Присвоение хеша содержимому решения.
- **Целостность хеша (I7):** Каждая запись решения включает SHA-256 хеш Payload. Валидация хеша проводится при каждом чтении сущности.
[Invariant: I7 | Test Level: L4 | Trace: HASH_INT_01]
- **Неизменяемость после утверждения (I6):** После записи в таблицу `cmr_decisions` поле `payload` является Read-Only. Попытки SQL UPDATE блокируются триггером БД.
[Invariant: I6 | Test Level: L6 | Trace: IMMUT_DEC_01]
- **Непрерывность цепочки событий (I8):** Каждое решение ссылается на `prevDecisionId`, формируя неизменяемый связный список фактов.
[Invariant: I8 | Test Level: L4 | Trace: CHAIN_CONT_01]

**Схема объекта решения (Decision Object Schema):**
```json
{
  "id": "uuid",
  "entityId": "uuid",
  "prevDecisionId": "uuid | null",
  "actorId": "uuid",
  "payload": "object",
  "hash": "string (sha256)",
  "timestamp": "iso8601",
  "justification": "text"
}
```

---

## 2.3 IntegrityGate (Шлюз целостности)

Единая точка входа для валидации бизнес-инвариантов.

### Формальная модель ограничений (Constraint Model)

Все проверки в IntegrityGate делятся на следующие типы:

1. **Structural Constraints (ST):** Целостность схемы и обязательные поля.
2. **Domain Constraints (DM):** Агрономические лимиты (нормы высева, сроки).
3. **Financial Constraints (FN):** Соответствие бюджетным лимитам.
4. **Temporal Constraints (TM):** Последовательность дат и фаз сезона.

### Реестр формальных ограничений (Constraint Registry)

| ID | Тип | Описание | Инвариант | Механизм |
| :--- | :--- | :--- | :--- | :--- |
| **C_ST_01** | ST | Уникальность ID и наличие обязательных метаданных | I9 | Validator |
| **C_DM_01** | DM | Соответствие нормы ресурса региональному лимиту | I9 | AgroRules |
| **C_TM_01** | TM | Окно операции должно быть внутри дат сезона | I9 | TimelineGate |
| **C_FN_01** | FN | Сумма операции не должна превышать остаток бюджета | I9 | FinanceGate |

### Покрытие инвариантов (Invariant Coverage)
Любое сохранение сущности инициирует `Gate.validate()`, который выполняет полный проход по реестру ограничений. Нарушение любого ограничения (Result = FAIL) приводит к немедленному откату транзакции.
[Invariant: I9 | Test Level: L3 | Trace: GATE_ENFORCE_01]
- **Детерминированная валидация (I10):** Результат проверки зависит только от текущего состояния БД и входящего Payload. Внешние недерминированные факторы (время, рандом) исключены из ядра валидации.
[Invariant: I10 | Test Level: L4 | Trace: GATE_DET_01]

---

## 2.4 Decision Layer (Level A)

На уровне А представлены три типа агентов.

### Advisor (Советник)
- **Контракт входа:** Текущая TechMap + Региональные нормы.
- **Контракт выхода:** Рекомендации по оптимизации операций (текст).
- **Границы полномочий:** Только чтение данных. Создание сущностей запрещено.

### Coach (Наставник)
- **Контракт входа:** История девиаций сотрудника.
- **Контракт выхода:** Обучающие сигналы и напоминания.
- **Границы полномочий:** Доступ только к HR-проекциям.

### Auditor (Аудитор)
- **Контракт входа:** Журнал операций + Ledger.
- **Контракт выхода:** Отчет о расхождениях (Anomaly Report).

**Жёсткое исполнение ограничений:**
- **I11 — Отсутствие полномочий на генерацию:** Ни один агент не имеет метода `createTechMap()`. Все карты создаются вручную пользователем.
[Invariant: I11 | Test Level: L5 | Trace: AGENT_GEN_DENY]
- **I12 — Отсутствие полномочий на мутацию:** Агенты не имеют доступа к write-методам репозиториев. Любая попытка записи от имени агента отклоняется на уровне ACL.
[Invariant: I12 | Test Level: L5 | Trace: AGENT_MUT_DENY]

---

# 3. Контракт TechMap (Level A)

Нормализованная схема технологической карты:

- `id`: UUID (Primary Key)
- `cropId`: UUID (Ссылка на культуру)
- `regionId`: UUID (Ссылка на регион)
- `operations`: Array<Operation> (Список агроприемов)
- `plannedDates`: [Start, End]
- `resourceRates`: Object (Нормы семян, удобрений, СЗР)
- `status`: Enum (DRAFT, REVIEW, APPROVED, FROZEN) [Invariant: I3]
- `approvalMetadata`: DecisionRecordID [Invariant: I5]
- `freezeMetadata`: Timestamp + Hash [Invariant: I6]
### Семантика версионирования (Versioning Semantics)

Версия TechMap является строго инкрементальной и управляется по следующим правилам:

1. **Initial Creation:** При создании объекта `version = 1`.
2. **Increment Rule:** Каждая фиксация изменений в состоянии `DRAFT` или `REVIEW` не меняет версию (внутренние правки).
3. **Submit/Re-Submit Behavior:** Переход `DRAFT -> REVIEW` не увеличивает версию.
4. **Reject Behavior:** Переход `REVIEW -> DRAFT` (Reject) не увеличивает версию, но сохраняет историю в Audit Log.
5. **Approval Increment:** Версия инкрементируется (`v = v + 1`) только при создании нового черновика на базе `APPROVED` или `FROZEN` сущности (если такая операция разрешена политикой клонирования). 
6. **Immutable Lock:** В состояниях `APPROVED` и `FROZEN` версия неизменна.

[Invariant: I6 | Test Level: L4 | Trace: VER_SEM_01]

**Состояния мутабельности:**
- **Mutable:** `DRAFT`. Разрешены любые изменения через API.
- **Immutable:** `APPROVED`, `FROZEN`. Любые PATCH/PUT запросы возвращают 403 Forbidden.

---

# 4. Модель управления (Governance)

Все изменения в системе Level A проходят через человеческое одобрение.

- **Workflow:** Пользователь создает DRAFT -> Отправляет на REVIEW -> TECHLEAD/Агроном ставит APPROVE.
- **Процедура Override:** При необходимости отклонения от рекомендаций ИИ, пользователь обязан заполнить форму обоснования.

**Схема Override:**
```javascript
{
  "user_id": "uuid",
  "timestamp": "datetime",
  "justification": "Причина отклонения совета ИИ",
  "original_ai_recommendation": "text (фиксируется в момент оверрайда)",
  "override_payload": "object (фактически примененные данные)"
}
```
- **I13 — Логирование Override:** Каждый оверрайд сохраняется в `AuditLog` с обязательным полем `justification`.
[Invariant: I13 | Test Level: L5 | Trace: GOV_OVERRIDE_LOG]
- **I14 — Прозрачность Override:** Система сохраняет оригинальный совет ИИ рядом с оверрайдом для последующего аудита. Удаление совета ИИ невозможно.
[Invariant: I14 | Test Level: L5 | Trace: GOV_OVERRIDE_TRANS]

---

# 5. Зависимости данных

Система Level A опирается на следующие источники:
- Исторические агрономические данные (факты прошлых сезонов).
- Метеоданные (история + прогноз от внешних провайдеров).
- Данные почвенного анализа (статические срезы).
- Экономические вводные (цены на ТМЦ).
- KnowledgeGraph (онтология связей между операциями).

**Особые указания (I4 Clarity):**
- **Отсутствие Генеративного Слой:** Состояние `GENERATED_DRAFT` полностью **ОТСУТСТВУЕТ** в FSM Level A. Любые попытки перевести сущность в данный статус блокируются IntegrityGate как нарушение I2.
- Вероятностные модели отсутствуют.
- Генеративный движок отсутствует.
- Инвариант I4 (Generated Draft Isolation) выполняется тривиально ввиду физического отсутствия объекта проверки.

---

# 6. Таблица соответствия формальных инвариантов

| Компонент | Инвариант | Механизм исполнения | Уровень теста | Trace ID |
| :--- | :--- | :--- | :--- | :--- |
| **FSM** | I1: Determinism | State Machine Matrix | L4 | FSM_DET_01 |
| **FSM** | I2: No Illegal Jump | IntegrityGate | L3 | FSM_GATE_02 |
| **FSM** | I3: Freeze Irrevocability | Prisma Middleware / DB Trigger | L4 | FSM_FREEZE_01 |
| **FSM / Level B** | I4: Draft Isolation | State Machine Rules (Vacuously true in A) | L4 | FSM_ISO_01 |
| **Decision Subsys** | I5: Traceability | FK Constraint (status -> decision) | L5 | DECISION_TRACE_01 |
| **Decision Subsys** | I6: Post-Appr Immut | DB Table Lock / Trigger | L6 | IMMUT_DEC_01 |
| **Decision Subsys** | I7: Hash Integrity | SHA-256 Content Validation | L4 | HASH_INT_01 |
| **Decision Subsys** | I8: Chain Cont | Linked List (prev_id) logic | L4 | CHAIN_CONT_01 |
| **IntegrityGate** | I9: Constraint Enforce | IntegrityGate Service | L3 | GATE_ENFORCE_01 |
| **IntegrityGate** | I10: Det Validation | Pure Logic Gate | L4 | GATE_DET_01 |
| **AI Agents** | I11: No Gen Auth | ACL / Interface Restriction | L5 | AGENT_GEN_DENY |
| **AI Agents** | I12: No Mut Auth | Read-Only Repositories | L5 | AGENT_MUT_DENY |
| **Governance** | I13: Override Log | Mandatory Audit Ingestion | L5 | GOV_OVERRIDE_LOG |
| **Governance** | I14: Override Trans | AI Signal Snapshotting | L5 | GOV_OVERRIDE_TRANS |

---

# 7. Сценарии негативной валидации (Adversarial)

Для обеспечения стабильности Level A проводятся следующие тесты:

1. **Попытка незаконного прыжка FSM (I2):** Запрос на смену статуса из `DRAFT` сразу в `APPROVED`. Ожидаемый результат: FAIL (L6).
2. **Мутация замороженной сущности (I3/I6):** Попытка изменить поле `plannedDates` у техкарты в статусе `FROZEN`. Ожидаемый результат: FAIL (L6).
3. **Override без обоснования (I13):** Попытка подтвердить действие, противоречащее политике, с пустым полем `justification`. Ожидаемый результат: FAIL (L5).
4. **Симуляция подмены хеша (I7):** Прямое изменение `payload` в БД без обновления хеша. Ожидаемый результат: Обнаружение несоответствия при чтении и ALERT (L4).
5. **Обход IntegrityGate (I9):** Попытка создания операции, нарушающей агрономический лимит, через прямой API вызов. Ожидаемый результат: FAIL (L6).

---

# 8. Формальная граница стабильности Level A

Настоящим документом подтверждается, что архитектура LEVEL A (Controlled Intelligence) RAI_Enterprise_Platform удовлетворяет следующим условиям:

1. Система полностью соблюдает инварианты I1–I14 в рамках текущего функционала.
2. В системе **отсутствуют** полномочия ИИ на генерацию доменных сущностей.
3. В системе **отстутствует** вероятностное моделирование и статистические допущения в ядре.
4. В системе **отстутствует** адаптивное самообучение, меняющее бизнес-логику.
5. В системе **отстутствует** симуляция сценариев и прогнозирование сложных системных откликов.
6. В системе **отстутствует** автономная коррекция ошибок без участия человека.

Граница Level A является жёсткой. Любое внедрение генеративных функций требует пересмотра данного базового уровня и перехода к спецификации LEVEL B.
