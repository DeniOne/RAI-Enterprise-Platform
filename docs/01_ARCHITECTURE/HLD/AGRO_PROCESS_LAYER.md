---
id: DOC-ARC-GEN-033
type: HLD
layer: Architecture
status: Draft
version: 0.1.0
owners: [@techlead]
last_updated: 2026-02-15
---

---
id: component-apl
type: component
status: review
owners: [architects, product-owner]
aligned_with: [principle-vision]
---

# HLD: Agro Process Layer (APL)

> **–°—Ç–∞—Ç—É—Å:** Draft | **–°–ª–æ–π:** Architecture | **–¢–∏–ø:** Technical Spec

---

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—è

**Agro Process Layer (APL)** ‚Äî —ç—Ç–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π **–ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏** –∞–≥—Ä–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏.

–≠—Ç–æ **–ù–ï** –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ ("AgroService") –∏ **–ù–ï** –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ("AgroDB").
–≠—Ç–æ –¥–≤–∏–∂–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ö–∞–æ—Å –∞–≥—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å—Ç—Ä–æ–≥–∏–π, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ—Ç–æ–∫.

### 1.1 –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1.  **Separation of Concerns:**
    *   **Domain Services (Field, Crop, Machinery):** –•—Ä–∞–Ω—è—Ç —Ñ–∞–∫—Ç—ã (–ß—Ç–æ? –ì–¥–µ? –ß–µ–º?).
    *   **APL:** –•—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏–∫—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ö–æ–≥–¥–∞? –ó–∞—á–µ–º? –ß—Ç–æ –¥–∞–ª—å—à–µ?).
    *   **Business Core:** –ò—Å–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ (Task Engine).
2.  **Canonical Process Graph:**
    *   16 —ç—Ç–∞–ø–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Ä–æ–∂–∞–µ–º (–∏–∑ Research) ‚Äî —ç—Ç–æ **Reference Workflow**.
    *   APL –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —ç—Ç–æ—Ç –≥—Ä–∞—Ñ (–ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —ç—Ç–∞–ø—ã, –≤–µ—Ç–≤–∏—Ç—å), –Ω–æ —Å–ª–µ–¥—É–µ—Ç –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–π –ª–æ–≥–∏–∫–µ "–æ—Ç –ø–æ—á–≤—ã –¥–æ –∞–º–±–∞—Ä–∞".
3.  **Stateless Orchestration:**
    *   –°–∞–º —Å–ª–æ–π –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π (—ç—Ç–æ –¥–µ–ª–æ Domain).
    *   –û–Ω —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ **–ø—Ä–æ—Ü–µ—Å—Å–∞** (–Ω–∞ –∫–∞–∫–æ–º –º—ã —ç—Ç–∞–ø–µ, –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã).

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ê–≥—Ä–æ-–ü—Ä–æ—Ü–µ—Å—Å–Ω–æ–≥–æ –°–ª–æ—è

```mermaid
graph TD
    %% –í—Ö–æ–¥—è—â–∏–µ
    Input[üìÖ Trigger / Scheduler / User] --> Orchestrator

    %% APL Internals
    subgraph APL [Agro Process Layer]
        Orchestrator[üéº AgroProcess Orchestrator]
        StageEngine[üé¨ Stage Engine]
        RuleEngine[‚öñÔ∏è AgroRule Engine]
    end

    %% –í–Ω–µ—à–Ω–∏–µ —Å–≤—è–∑–∏
    Orchestrator -->|Get Context| DomainLayer[üöú Domain Services]
    Orchestrator -->|Create Task| TaskEngine[‚úÖ Task Engine (Core)]
    Orchestrator -->|Validate| RuleEngine
    StageEngine -->|Check Preconditions| DomainLayer
    
    %% AI Integration
    AI[ü§ñ AI Orchestration Hub] -.->|Advisory Interface| Orchestrator
    
    %% Memory
    Audit[üìú Audit Service] -->|Log Decision| Engram[üß† Engram System]
```

### 2.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã APL

#### üéº AgroProcess Orchestrator
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä.
*   **–§—É–Ω–∫—Ü–∏—è:** –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–∞–π–º–µ—Ä–∞, IoT) –∏ —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏—Ç—å.
*   **–ü—Ä–∏–º–µ—Ä:** –ü—Ä–∏—à–ª–∞ –¥–∞—Ç–∞ —Å–µ–≤–∞ -> –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–≥–æ–¥—É -> –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –Ω–∞ –æ—Å–º–æ—Ç—Ä –ø–æ–ª—è.

#### üé¨ Stage Engine (–î–≤–∏–∂–æ–∫ –≠—Ç–∞–ø–æ–≤)
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≠—Ç–∞–ø 4. –°–µ–≤").
*   **Logic:** –ó–Ω–∞–µ—Ç Preconditions (—á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≥–æ—Ç–æ–≤–æ) –∏ Postconditions (—á—Ç–æ —Å—á–∏—Ç–∞—Ç—å —É—Å–ø–µ—Ö–æ–º).
*   **Mapping:** –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π "–≠—Ç–∞–ø –°–µ–≤" –≤ –Ω–∞–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á Task Engine.

#### ‚öñÔ∏è AgroRule Engine (–î–≤–∏–∂–æ–∫ –ü—Ä–∞–≤–∏–ª)
–•—Ä–∞–Ω–∏—Ç–µ–ª—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
*   **Hard Constraints:** "–ù–µ–ª—å–∑—è —Å–µ—è—Ç—å –≤ –≥—Ä—è–∑—å" (–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞).
*   **Soft Constraints:** "–õ—É—á—à–µ —Å–µ—è—Ç—å –Ω–æ—á—å—é" (Warning).
*   **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AI:** AI –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ–±—Ö–æ–¥ –ø—Ä–∞–≤–∏–ª, –Ω–æ Rule Engine —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ.

---

## 3. Reference Workflow: 16 Stages

–ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º 16 —ç—Ç–∞–ø–æ–≤ –Ω–µ –∫–∞–∫ –∂–µ—Å—Ç–∫–∏–π –∫–æ–¥, –∞ –∫–∞–∫ **Canonical Graph**.

| Stage ID | –ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ | –ö–ª—é—á–µ–≤—ã–µ –î–æ–º–µ–Ω—ã (Reads) | –†–µ–∑—É–ª—å—Ç–∞—Ç (Events) |
| :--- | :--- | :--- | :--- |
| **01** | –ü—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫ –∏ –∞–Ω–∞–ª–∏–∑ | `Field`, `History` | `analysis.completed` |
| **02** | –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ | `Machinery`, `Soil` | `tillage.executed` |
| **03** | –ü—Ä–µ–¥–ø–æ—Å–µ–≤–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | `Machinery`, `Soil` | `seedbed.ready` |
| **04** | –°–µ–≤ | `Inputs`, `Machinery` | `sowing.completed` |
| **05** | –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ | `Inputs` (Insecticides) | `protection.applied` |
| **...** | ... | ... | ... |
| **16** | –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ–∑–æ–Ω–∞ | `Finance`, `Audit` | `season.closed` |

> **–ì–∏–±–∫–æ—Å—Ç—å:** –î–ª—è –∫—É–∫—É—Ä—É–∑—ã –≥—Ä–∞—Ñ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω (–¥—Ä—É–≥–∏–µ —ç—Ç–∞–ø—ã), –Ω–æ –¥–≤–∏–∂–æ–∫ (StageEngine) –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ.

---

## 4. –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å Business Core

APL ‚Äî —ç—Ç–æ "–º–æ–∑–≥", –∞ Business Core ‚Äî "—Ä—É–∫–∏ –∏ –Ω–æ–≥–∏".

### 4.1 Task Engine (Workflow)
APL –Ω–µ –∏–º–µ–µ—Ç —Å–≤–æ–µ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á.
*   –ö–æ–≥–¥–∞ APL —Ä–µ—à–∞–µ—Ç "–ù–∞–¥–æ —Å–µ—è—Ç—å", –æ–Ω –¥–µ–ª–∞–µ—Ç `POST /tasks` –≤ `Task Service`.
*   APL –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è `task.completed`.

### 4.2 Audit Service (Evidence)
–ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ APL (—Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞) –ø–∏—à–µ—Ç—Å—è –≤ –ê—É–¥–∏—Ç.
*   –≠—Ç–æ –∫–æ—Ä–º–æ–≤–∞—è –±–∞–∑–∞ –¥–ª—è **Engram System**.

### 4.3 Event Bus (State Change)
APL —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ.
*   –°–ª—É—à–∞–µ—Ç: `sensor.moisture.critical`, `user.command.start_harvest`.
*   –ü—É–±–ª–∏–∫—É–µ—Ç: `stage.suboptimal`, `risk.detected`.

---

## 5. –°—Ü–µ–Ω–∞—Ä–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Flow)

**–ó–∞–¥–∞—á–∞:** –ü–µ—Ä–µ—Ö–æ–¥ –∫ "–≠—Ç–∞–ø—É 4. –°–µ–≤".

1.  **Trigger:** –ê–≥—Ä–æ–Ω–æ–º –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å —Å–µ–≤" –≤ UI.
2.  **Orchestrator:** –ü–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å.
3.  **Stage Engine:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Preconditions: "–≠—Ç–∞–ø 3 –∑–∞–≤–µ—Ä—à–µ–Ω?", "–°–µ–º–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ?".
    *   –ß–∏—Ç–∞–µ—Ç **Domain Services** (Stock, Field Status).
4.  **Rule Engine:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: "–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã > 15%?" (–î–∞–Ω–Ω—ã–µ –æ—Ç IoT/Domain).
    *   –ï—Å–ª–∏ < 12% -> **Blocker**.
5.  **Decision:**
    *   –ï—Å–ª–∏ OK -> –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏ –≤ **Task Engine**: "–í—ã–µ–∑–¥ —Å–µ—è–ª–∫–∏", "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–º—è–Ω".
    *   –ï—Å–ª–∏ Blocker -> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É + –ê–ª–µ—Ä—Ç.
6.  **AI Advisory (Optional):**
    *   –ï—Å–ª–∏ Blocker, AI –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å: "–ú–æ–∂–Ω–æ —Å–µ—è—Ç—å –≥–ª—É–±–∂–µ, —Ä–∏—Å–∫ 20%".
    *   Orchestrator –∂–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞ (Override).

---

## 6. –†–µ–∑—é–º–µ

*   **APL** = Logic Keeper.
*   **Domain** = Data Keeper.
*   **Core** = Execution.
*   **AI** = Advisor.

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∞–≥—Ä–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é (–¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫—É–ª—å—Ç—É—Ä—ã, –º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞) –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –±—ç–∫–µ–Ω–¥–∞.
