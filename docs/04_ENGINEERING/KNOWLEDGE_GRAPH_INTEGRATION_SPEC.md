# KNOWLEDGE_GRAPH_INTEGRATION_SPEC.md

## 0. Статус документа

- **Система:** RAI_Enterprise_Platform
- **Компонент:** Knowledge Graph Integration (Level B)
- **Статус:** FORMAL SPECIFICATION
- **Зависимости:** INVARIANT_EXTENSION_FOR_LEVEL_B.md, GENERATIVE_ENGINE_SPEC.md
- **Document Maturity Level:** D3 (Verification-Ready)

---

## 1. Назначение (Purpose)

Данный документ ДОЛЖЕН определить формальную спецификацию интеграции Knowledge Graph в рамках Level B платформы RAI Enterprise Platform. Knowledge Graph ДОЛЖЕН служить консультативным слоем только для чтения для Generative Engine.

Спецификация ДОЛЖНА обеспечить:
- Режим только для чтения (Read-Only Advisory Layer)
- Отсутствие влияния на детерминизм генерации (I19)
- Прослеживаемость использования графа знаний
- Изоляцию от производственных данных

---

## 2. Область применения (Scope)

### 2.1 Входит в область

- Формальное определение интерфейса `KnowledgeGraphService`
- Режим только для чтения
- Контракты интеграции с Generative Engine
- Правила использования графа знаний
- Ограничения на влияние графа на детерминизм
- Логирование запросов к графу

### 2.2 Не входит в область (см. Раздел 10)

- Реализация графовой базы данных
- Алгоритмы построения графа знаний
- Онтологии и схемы графа
- Производительность запросов
- Визуализация графа
- Обновление графа знаний
- Реализация схемы базы данных

---

## 3. Формальные определения (Formal Definitions)

### 3.1 Интерфейс KnowledgeGraphService

```
KnowledgeGraphService := {
  query: (query: GraphQuery) → GraphResult,
  getRelatedConcepts: (conceptId: UUID) → Concept[],
  getConstraints: (cropId: UUID, regionId: UUID) → Constraint[],
  logQuery: (query: GraphQuery, result: GraphResult) → void
}

КРИТИЧЕСКОЕ ОГРАНИЧЕНИЕ:
  НЕТ методов записи (create, update, delete)
  Граф знаний — ТОЛЬКО ДЛЯ ЧТЕНИЯ
```

### 3.2 GraphQuery

```
GraphQuery := {
  queryType: QueryType,
  parameters: Map<String, Any>,
  requestedAt: ISO8601,
  requestedBy: String      // modelId или userId
}

QueryType := 
  | GET_RELATED_CONCEPTS
  | GET_CONSTRAINTS
  | GET_BEST_PRACTICES
  | GET_HISTORICAL_DATA
```

### 3.3 GraphResult

```
GraphResult := {
  data: Json,
  confidence: ℝ ∈ [0.0, 1.0],
  sources: Source[],
  retrievedAt: ISO8601,
  hash: SHA256
}

Source := {
  type: 'EXPERT' | 'RESEARCH' | 'HISTORICAL',
  reference: String,
  reliability: ℝ ∈ [0.0, 1.0]
}
```

### 3.4 Concept

```
Concept := {
  id: UUID,
  name: String,
  category: ConceptCategory,
  attributes: Map<String, Any>,
  relationships: Relationship[]
}

ConceptCategory := 
  | CROP
  | OPERATION
  | RESOURCE
  | CONSTRAINT
  | RISK
```

---

## 4. Маппинг инвариантов (Invariant Mapping) — только I15–I28

### 4.1 Покрываемые инварианты

**I19: Детерминированная генерация** (частично)
- **Требование:** Knowledge Graph НЕ ДОЛЖЕН нарушать детерминизм генерации.
- **Механизм:** Результаты запросов к графу ДОЛЖНЫ быть детерминированными при фиксированном состоянии графа. Версия графа ДОЛЖНА записываться в `generationMetadata`.
- **Trace:** [TRACE-LB-ENG-101]

**I16: Провенанс генерации** (частично)
- **Требование:** Использование графа знаний ДОЛЖНО быть прослеживаемым.
- **Механизм:** Все запросы к графу ДОЛЖНЫ логироваться с `hash` результата.
- **Trace:** [TRACE-LB-ENG-102]

### 4.2 Непокрываемые инварианты

I15, I17, I18, I20, I21, I22, I23, I24, I25, I26, I27, I28 НЕ применимы к данному компоненту.

---

## 5. Выравнивание FSM (FSM Alignment)

### 5.1 Отсутствие влияния на FSM

Knowledge Graph НЕ ДОЛЖЕН:
- Изменять состояние TechMap
- Инициировать переходы FSM
- Создавать производственные записи

Knowledge Graph МОЖЕТ:
- Предоставлять консультативные данные для Generative Engine
- Использоваться для валидации ограничений (через IntegrityGate)

**Trace:** [TRACE-LB-ENG-103]

### 5.2 Использование в генеративном процессе

```
Generative Engine МОЖЕТ использовать Knowledge Graph:
  1. Для получения best practices (опционально)
  2. Для получения ограничений (обязательно для I21)
  3. Для получения исторических данных (опционально)

НО:
  - Результаты ДОЛЖНЫ быть детерминированными
  - Версия графа ДОЛЖНА записываться в generationMetadata
  - Запросы ДОЛЖНЫ логироваться
```

**Trace:** [TRACE-LB-ENG-104]

---

## 6. Ограничения детерминизма (Determinism Constraints)

### 6.1 DC-1: Детерминизм запросов

**Ограничение:**
```
∀ запроса Q к графу G версии V:
  query(Q, G_V)₁ = query(Q, G_V)₂

где равенство — это идентичность:
  - data (содержимое)
  - hash
```

**Механизм:** Граф знаний ДОЛЖЕН быть версионирован. Запросы к одной версии ДОЛЖНЫ возвращать идентичные результаты.

**Trace:** [TRACE-LB-ENG-105]

### 6.2 DC-2: Версионирование графа

**Ограничение:**
```
∀ генерации g:
  g.generationMetadata.knowledgeGraphVersion ДОЛЖНА быть записана

∀ версии V графа:
  V неизменяема после публикации
```

**Механизм:** Граф знаний версионируется. Изменения графа создают новую версию.

**Trace:** [TRACE-LB-ENG-106]

### 6.3 DC-3: Логирование запросов

**Ограничение:**
```
∀ запроса Q:
  logQuery(Q, result) ДОЛЖЕН записать:
    - queryType
    - parameters
    - result.hash
    - graphVersion
    - requestedAt
```

**Механизм:** Все запросы к графу ДОЛЖНЫ логироваться для прослеживаемости.

**Trace:** [TRACE-LB-ENG-107]

---

## 7. Стратегия верификации (Verification Strategy)

### 7.1 Структурные тесты (L3)

**Тест:** Проверка отсутствия методов записи
```
Дано: KnowledgeGraphService
Когда: inspect(service.methods)
Тогда: НЕТ методов create, update, delete, write
```
**Trace:** [TRACE-LB-TEST-601]

### 7.2 Тесты формальных инвариантов (L4)

**Тест I19-01:** Детерминизм запросов
```
Дано: запрос Q к графу версии V
Когда: query(Q, V) вызван N раз
Тогда: все N результатов побайтово идентичны
```
**Trace:** [TRACE-LB-TEST-602]

**Тест I16-01:** Логирование запросов
```
Дано: запрос Q
Когда: query(Q)
Тогда: log содержит запись с Q, result.hash, graphVersion
```
**Trace:** [TRACE-LB-TEST-603]

### 7.3 Тесты на основе свойств (L5)

**Свойство PBT-01:** Детерминизм для фиксированной версии
```
Свойство: ∀ запроса Q, версии V:
  ∀ n ∈ ℕ: query(Q, V)₀ = query(Q, V)ₙ
Trace: [TRACE-LB-TEST-604]
```

**Свойство PBT-02:** Режим только для чтения
```
Свойство: ∀ операции op на KnowledgeGraphService:
  op НЕ изменяет состояние графа
Trace: [TRACE-LB-TEST-605]
```

---

## 8. Критерии приёмки (Acceptance Criteria) — бинарные

### 8.1 Обязательные критерии

| ID | Критерий | Статус |
|----|----------|--------|
| AC-01 | Нет методов записи | ✓ ОПРЕДЕЛЁН |
| AC-02 | Детерминизм запросов обеспечен | ✓ ОПРЕДЕЛЁН |
| AC-03 | Версионирование графа реализовано | ✓ ОПРЕДЕЛЁН |
| AC-04 | Логирование запросов реализовано | ✓ ОПРЕДЕЛЁН |
| AC-05 | Нет влияния на FSM | ✓ ОПРЕДЕЛЁН |

### 8.2 Верификационные ворота

**Ворота G1:** Все тесты L4 (TRACE-LB-TEST-601 — TRACE-LB-TEST-603) ДОЛЖНЫ пройти.

**Ворота G2:** Тесты на основе свойств (PBT-01, PBT-02) ДОЛЖНЫ пройти для 10,000 сгенерированных запросов.

**Ворота G3:** Отсутствие методов записи ДОЛЖНО быть верифицировано на уровне интерфейса.

---

## 9. Матрица прослеживаемости (Traceability Matrix)

| Trace ID | Тип | Требование | Метод верификации | Статус |
|----------|-----|------------|-------------------|--------|
| TRACE-LB-ENG-101 | Инвариант | I19: Детерминизм | L4 Тест I19-01, PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-ENG-102 | Инвариант | I16: Прослеживаемость | L4 Тест I16-01 | ОПРЕДЕЛЁН |
| TRACE-LB-ENG-103 | FSM | Нет влияния на FSM | Структурный тест | ОПРЕДЕЛЁН |
| TRACE-LB-ENG-104 | Интеграция | Использование в генерации | Интеграционный тест | ОПРЕДЕЛЁН |
| TRACE-LB-ENG-105 | Ограничение | DC-1: Детерминизм запросов | PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-ENG-106 | Ограничение | DC-2: Версионирование | Версионирование | ОПРЕДЕЛЁН |
| TRACE-LB-ENG-107 | Ограничение | DC-3: Логирование | Аудит логов | ОПРЕДЕЛЁН |
| TRACE-LB-TEST-601 | Тест | Нет методов записи | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-602 | Тест | I19-01: Детерминизм | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-603 | Тест | I16-01: Логирование | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-604 | Тест | PBT-01: Детерминизм версии | Property-Based | В ОЖИДАНИИ |
| TRACE-LB-TEST-605 | Тест | PBT-02: Только чтение | Property-Based | В ОЖИДАНИИ |

---

## 10. Вне области применения (Out of Scope)

Следующее ЯВНО ИСКЛЮЧЕНО из области данной спецификации:

1. **Графовая БД:** Выбор Neo4j, ArangoDB, или другой графовой БД
2. **Построение графа:** Алгоритмы извлечения знаний, NLP, entity extraction
3. **Онтологии:** Дизайн онтологий, схемы графа, таксономии
4. **Производительность:** Оптимизация запросов, индексирование, кэширование
5. **Визуализация:** UI для визуализации графа знаний
6. **Обновление:** Процессы обновления графа, инкрементальное обновление
7. **Качество данных:** Валидация данных графа, разрешение конфликтов
8. **Масштабирование:** Шардирование графа, распределённые запросы

Эти вопросы ДОЛЖНЫ быть рассмотрены в отдельных инженерных и data science спецификациях.

---

## Document Maturity Level: D3 (Verification-Ready)

**Обоснование:**
- ✓ Структурно завершён (D1)
- ✓ Выровнен с инвариантами (D2): I19, I16 явно замаплены
- ✓ Готов к верификации (D3): Все стратегии тестирования определены с trace ID
- ✗ Утверждён для реализации (D4): Требуется выбор графовой БД и план интеграции

**Следующие шаги:**
1. Выбрать графовую базу данных
2. Определить схему графа знаний
3. Реализовать версионирование графа
4. Реализовать тесты L4 и L5
5. Получить утверждение стейкхолдеров для повышения до D4
