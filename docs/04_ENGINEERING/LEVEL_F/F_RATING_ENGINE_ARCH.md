---
id: DOC-ENG-LVLF-002
type: Architecture Specification
layer: Engineering (Computation)
status: Enforced
version: 2.0.0
owners: [@techlead, @algorithm_engineer]
last_updated: 2026-02-20
---

# УРОВЕНЬ F: АРХИТЕКТУРА РЕЙТИНГОВОГО ДВИЖКА (F_RATING_ENGINE_ARCH)

## 0. Аксиома Чистой Функции (Pure Function Axiom)
`F_RATING_ENGINE` математически преобразует подписанный `TrustSnapshot` в финансовую метрику (`FRS`, `RCS`). Движок **ПОЛНОСТЬЮ STATELESS**. Внутри него нет сетевых вызовов, нет обращений к базе данных и нет случайных чисел. 
$f(Snapshot_{Hash}) \rightarrow Rating_{Fixed}$.

---

## 1. Детерминизм Вычислений (IEEE-754 Strictness)

В институциональных финансах недопустимо, чтобы расчет рейтинга на сервере Linux X86 отличался в 15-м знаке после запятой от расчета на Mac ARM, так как это инвалидирует криптографические подписи.

### 1.1 Float-Math Boundaries
- **Среда исполнения:** Расчет рейтингов инкапсулирован в изолированный WASM (WebAssembly) контейнер или библиотеку с отключенным аппаратным ускорением FPU (Fast-Math disabled).
- **Библиотеки:** Запрещено использование нативных встроенных функций `Math.sin`, `Math.random`, `Math.pow` движка JS (V8), так как они зависят от платформы. Используются только строгие детерминированные (Soft-float) математические библиотеки.
- **Округление (Rounding Policy):** Все промежуточные расчеты FRS сохраняются как рациональные числа (BigInt / Fractional) ИЛИ строго округляются (Round-to-Nearest, Ties-to-Even) до $8$ знаков (Scale 8) на каждом шаге цикла.

### 1.2 Sandboxing (Песочница)
- Код формулы (Formula Version) загружается из защищенного реестра.
- Исполняется в `v8::Isolate` (или аналоге) с отключенном I/O (нет доступа к сети, файлам).
- Жесткий Timeout: $50$ms на расчет. Жесткий Memory Limit: $32$MB на инстанс.

---

## 2. Архитектура Версионирования (Semantic Formula Versioning)

Банк выдал кредитную ставку на $3$ года на основе алгоритма $v1.2.0$. Платформа не имеет права "тихо" обновить алгоритм для исторического снимка.

### 2.1 Formula Registry (Реестр Формул)
- Каждая версия формулы (напр., `CSM_Calc_v1.2`) хешируется: $H_{Formula} = SHA256(SourceCode)$.
- Метаданные `RiskProfile` навсегда биндятся (вяжутся) к $H_{Formula}$.

### 2.2 Deterministic Replay (Dispute Resolution)
При поступлении запроса от `LEVEL_F_DISPUTE_PROTOCOL` на пересчет (Replay):
1. Движок скачивает исходный WASM/код формулы по $H_{Formula}$.
2. Подает исторический `snapshot_data` на вход.
3. Возвращает результат. Если $\Delta > 0.00000000$ (Bit-perfect match failure), инициируется протокол $S1$ Breach.

---

## 3. Математические Инварианты Модели (Assertion Fences)

Перед генерацией итогового рейтинга, движок прогоняет результат через "Забор Утверждений" (Assertion Fence). Если результаты нелегитимны — движок падает (Panic), но не выдает коррумпированный рейтинг.

| Инвариант | Проверка Engine | Действие при ошибке |
| :--- | :--- | :--- |
| **I-FRS-BOUNDS** | $0 \le FRS \le 1000$ | `PANIC: OUT_OF_BOUNDS_ERROR` |
| **I-RCS-CAP** | Если $P05\_Risk \ge 0.10$, то $RCS \equiv 0$ | `PANIC: CIRCUIT_BREAKER_BYPASS` |
| **I-DETERMINISM** | $R_1(S_X) \equiv R_2(S_X)$ (расчет 2 раза) | `CRITICAL_PANIC: CPU_DESYNC` |

---

## 4. Конвейер Вывода (Output Formatting)
- Все плавающие числа в итоговом JSON для страховых сериализуются как **Строки** (Strings), во избежание потери точности при парсинге в системах банков на Java/Python (`"frs": "850.1234"` вместо `"frs": 850.1234`).
