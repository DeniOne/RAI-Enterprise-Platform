---
id: DOC-ARH-LVLF-004
type: Specification
layer: Architecture
status: Proposed
version: 1.1.1
owners: [@techlead]
last_updated: 2026-02-20
---

# УРОВЕНЬ F: ИНСТИТУЦИОНАЛЬНАЯ МОДЕЛЬ РЕЙТИНГОВАНИЯ ФЕРМ (F_FARM_RATING_MODEL)

## 0. Статус Документа
Данный документ является **Формальной Спецификацией (Hardened Enterprise v1.1.1 — Formal Closure Edition)** математической реализации Движка Рейтингования Ферм (`F_RATING_ENGINE`). Текущая версия полностью детерминирована, защищена от манипуляций (anti-gaming hardened), имеет строгие временные семантики и готова к интеграции с системами финансового уровня. Любые неформализованные исключения, плавающие окна или двусмысленные трактовки в реализации СТРОГО ЗАПРЕЩАЮТСЯ.

---

## 1. Структура Стимулов и Философия Дизайна (Incentive Structure & Design Philosophy)

Архитектура $FRS$ (Farm Rating Score) базируется на четырёх аксиомах финансового риск-менеджмента:
1. **Приоритет стабильности над регенерацией**: Система поощряет стабильные предсказуемые урожаи ($S_{stab}$) выше, чем агрессивный восстановительный рост ($S_{regen}$). Волатильность наказывается всегда.
2. **Деградационный контроль**: Любая деградация ($b_{OLS} < 0$, $CV_{norm} > 1$) мгновенно обнуляет поощрения.
3. **Ограничение на «ускоренную регенерацию»**: Восстановление экосистемы — медленный процесс. Любые аномалии роста ($b_{OLS} \gg B_{slope\_max}$) ограничиваются сверху, чтобы исключить манипуляции с химическими стимуляторами.
4. **Асимметрия штрафов**: Рост баллов всегда линеен и ограничен сверху, а штрафы за риск ($P_{tail}$) и вмешательство в автономию ($P_{gov}$) обладают высоким мультипликатором (крутой линейный штраф), быстро обнуляя итоговую оценку при нарушениях.

---

## 2. Формальный Реестр Переменных (Formal Variable Registry)

Для полного устранения интерпретационной зоны вводится явная привязка всех входных переменных движка к архитектуре Level D и Level E.

| Переменная | Source Spec / Level | Описание (Definition) | Детерминированный Ссылочный Источник (Deterministic Reference) |
| :--- | :--- | :--- | :--- |
| $CV_{farm}$ | Level E | Коэффициент вариации урожайности индивидуальной фермы за скользящее окно 5 сезонов ($T_{-5}...T_{-1}$). | `TrustSnapshot.historical_metrics.cv_5yr` |
| $B_{CV}$ | Level D | Trimmed Median (10-90) функции $CV_{farm}$ по всей когорте за тот же период. | Смарт-контракт Baseline (по ключу `cohort_id`) |
| $b_{OLS}$ | Level E | Коэффициент наклона Ordinary Least Squares для индекса $SRI$ за $N$ сезонов. | `TrustSnapshot.historical_metrics.sri_slope` |
| $B_{slope\_max}$ | Level D | Trimmed Median (80-100) лучших показателей $b_{OLS}$ (топ-20% регенераторов) в когорте. | Смарт-контракт Baseline (по ключу `cohort_id`) |
| $P05_{risk}$ | Level B/E | Квантиль Tail Risk P05 (5%) прогнозируемой маржинальности, вычисленный через Монте-Карло, нормализованный в $[0,1]$. | `TrustSnapshot.risk_metrics.p05_normalized` |
| $\rho_{ov}$ | Level E | `OverrideDensity`. Доля ручных стратегических вмешательств оператора в автономию системы за текущий сезон $T_0$. | `TrustSnapshot.governance_metrics.override_density` |
| $SRI$ | Level B/E | Soil Regeneration Index. Агрегированный индекс здоровья почвы (0-1). | Базовый расчет модуля Level B `SoilHealthEngine` |

---

## 3. Формальное Доказательство Ограниченности (Boundedness Proof Sketch)

Для прохождения регуляторного аудита, спецификация гарантирует, что $\forall$ входных данных из допустимого множества выходной скор $FRS \in [0, 1000]$.

**Proof Sketch:**
1. Пусть начальное значение (Base) = $500$.
2. Из Раздела 4.2: $S_{stab} = 250 \cdot \text{Clamp}_0^1(\dots) \implies S_{stab} \in [0, 250]$.
3. Из Раздела 4.3: $S_{regen} = 250 \cdot \text{Clamp}_0^1(\dots) \implies S_{regen} \in [0, 250]$.
4. Максимально возможная сумма без штрафов: $500 + 250 + 250 = 1000$.
5. Штрафы $P_{tail} \ge 0$ и $P_{gov} \ge 0$, так как функция $\text{Min}()$ работает с неотрицательными аргументами (благодаря $\text{Max}(0,\dots)$ и Clamp'ам в переменных). Следовательно, максимум $\le 1000$.
6. Функция верхнего уровня $\text{Clamp}_0^{1000}()$ гарантирует, что любая отрицательная сумма (например, при максимальных штрафах $-500 - 500$) будет усечена до $0$.
**Q.E.D.** $FRS \in [0, 1000]$.

---

## 4. Строгая Математическая Модель (Hardened Mathematical Model)

Все вычисления проводятся в типе `Decimal(18,8)`. Запрещено использование типов с плавающей точкой стандарта IEEE 754.

### 4.1 Мастер-Формула
$$
FRS = \text{Clamp}_{0}^{1000} \left( 500 + S_{stab} + S_{regen} - P_{tail} - P_{gov} \right)
$$

### 4.2 Стабильность ($S_{stab}$)
Нормированный коэффициент вариации $CV_{norm}$ вычисляется как отношение исторической вариации фермы к медианной вариации базовой когорты.
$$
CV_{norm} = \frac{CV_{farm}}{B_{CV}}
$$
$$
S_{stab} = 250 \cdot \text{Clamp}_{0}^{1} \left( 1 - CV_{norm} \right)
$$

### 4.3 Регенерация ($S_{regen}$)
Коэффициент наклона линии тренда $b_{OLS}$ поощряет восстановление.
$$
S_{regen} = 250 \cdot \text{Clamp}_{0}^{1} \left( \frac{b_{OLS}}{B_{slope\_max}} \right)
$$

### 4.4 Штрафы Эксплуатации ($P_{tail}$, $P_{gov}$)
- **Tail Risk Penalty**: $P_{tail} = \text{Min}(500, \, 2000 \cdot P05_{risk})$
- **Governance Penalty**: $P_{gov} = \text{Min}\left(500, \, \text{Max}(0, \, \rho_{ov} - 0.05) \cdot 5000\right)$

---

## 5. Граничные Условия и Фолбэки (Boundary Conditions & Fallback Protocol)

| Ситуация (Trigger) | Фолбэк Протокол (Deterministic Rule) | Влияние на FRS |
| :--- | :--- | :--- |
| **$N < 5$** (Недостаток истории) | Присвоить фиксированный $S_{stab} = 0$, $S_{regen} = 0$. | Индекс ограничен интервалом $[0, 500]$. Деградация возможна, рост — нет. Статус: `INSUFFICIENT_DATA`. |
| **$B_{CV} = 0$** | Деление на ноль: Принять $CV_{norm} = 1$. | $S_{stab} = 0$. |
| **$B_{slope\_max} \le 0$** | Деление на ноль: Принять $\frac{b_{OLS}}{B_{slope\_max}} = 0$. | $S_{regen} = 0$. Деградирующий бейзлайн не дает премии никому. |
| **Missing Slope (Вырождение OLS)** | Вызывается при коллинеарности. Принять $b_{OLS} = 0$. | $S_{regen} = 0$. |
| **$P05_{risk} \notin [0, 1]$** | Принудительно применить $\text{Clamp}_{0}^{1}(P05_{risk})$ до умножения на $2000$. | Корректный расчёт штрафа. |
| **$\text{NaN}$ или $\pm\infty$ в расчётах** | Немедленный выброс аппаратного исключения `ENGINE_PANIC`. | Процесс прерывается, FRS не формируется (REJECTED). |

---

## 6. Временная Семантика (Temporal Semantics)

Все временные окна СТРОГО фиксированы, скользящие окна исключены из оперативного расчёта.

1. **Базовый Сезон (Season Definition):** Фиксированный агрономический цикл, определяемый метаданными когорты (start_date, end_date), закреплёнными в реестре Level D.
2. **Yield_current:** Фактический урожай за последний ЗАВЕРШЁННЫЙ сезон $T_0$.
3. **Yield_5yr (Rolling Window):** Среднее (с применением Trimmed 10-90) значение урожайности за 5 последовательных завершенных сезонов: $[T_{-5}, T_{-4}, T_{-3}, T_{-2}, T_{-1}]$. Текущий сезон $T_0$ в расчет медианы базы не входит.
4. **Лаг Публикации Данных ($T_{lag}$):** Все метрики фиксируются на 14 день ($T_{lag} = 14$ days) после завершения сезона $T_0$ для сбора запаздывающей телеметрии. Перерасчёт в течение сезона СТРОГО ЗАПРЕЩЁН.
5. **Freeze Logic для Macro Shock:** Флаг `macro_shock_flag` оценивается однократно на момент $T_0 + 14$ days. Состояние флага "замораживается" для всего рассчитанного TrustSnapshot навсегда (привязан к `issued_at`).

---

## 7. Детерминированная Модель Исполнения (Deterministic Execution Model)

Документ требует абсолютной воспроизводимости на любой платформе.

1. **Precision Rules:** Тип `Decimal` с точностью 18 знаков и 8 десятичными (`Decimal(18,8)`).
2. **Rounding Protocol:** СТРОГОЕ использование `ROUND_HALF_EVEN` (Banker's round) для всех промежуточных делений. Окончательное скругление FRS до целого числа (integer) применяется самым последним шагом.
3. **Порядок Операций (Pipeline Priority):** Умножение MUST выполняться до деления ($A \cdot B / C$, а не $A \cdot (B/C)$) для сокращения ошибок округления. Сложение компонентов строго в порядке: $500 \rightarrow +S_{stab} \rightarrow +S_{regen} \rightarrow -P_{tail} \rightarrow -P_{gov}$.
4. **Baseline Snapshot Hash:** Матрица базовых медиан фиксируется смарт-контрактом. Хэш базы `baseline_hash` (SHA-256) является обязательным входом. Проверка подписи гарантирует защиту от атак повторного воспроизведения (Replay Attacks) со старыми бейзлайнами.
5. **Deterministic Equivalence Testing:** В CI/CD пайплайне MUST выполняться тесты на детерминированную эквивалентность (Golden Values) на миллионах синтетических слепков до релиза.
6. **Big-O Complexity:** Ожидаемая алгоритмическая сложность вычисления одного FRS на подготовленных агрегатах строго константна $O(1)$. Рекурсивные вызовы запрещены.

---

## 8. Защита от Манипуляций (Anti-Gaming Hardened Layer)

Системный аудит-триггер ($\mathcal{T}_{audit}$) фиксирует финансовые аномалии через корреляцию действий пользователя и метрик.

- **Активация:** Флаг `audit_recommendation` выставляется в `true`, если для выборки $N \ge 5$ сезонов:
  1. $\rho_{Pearson}(SRI_{slope}, \rho_{ov}) > 0.70$
  2. $p\text{-value} \le 0.05$ (Двусторонний тест значимости)
  3. $\Delta \rho_{ov} > 0$ (Растущий тренд переназначений)
- **Minimum Data Support:** Если суммарное количество стратегических вмешательств за $N$ сезонов менее $10$, тест признается малозначимым, триггер деактивируется (защита от коротких рядов выбросов).
- **Корректировка:** При расчёте p-value MUST применяться поправка Ньюи-Уэста на гетероскедастичность и автокорреляцию первого порядка (HAC correction).

---

## 9. Формальный JSON Output Контракт

Выход системы СТРОГО соответствует указанной JSON-схеме (Schema Strict):

```json
{
  "frs_score": "Decimal(18,8)",
  "components": {
    "s_stab": "Decimal(18,8)",
    "s_regen": "Decimal(18,8)",
    "p_tail": "Decimal(18,8)",
    "p_gov": "Decimal(18,8)"
  },
  "flags": {
    "macro_shock_flag": "Boolean",
    "audit_recommendation": "Boolean"
  },
  "metadata": {
    "baseline_version": "String",
    "baseline_hash": "Hex(SHA-256)",
    "cohort_id": "String",
    "data_sufficiency_status": "Enum(VALID|INSUFFICIENT_DATA)"
  }
}
```
*Любое отклонение от схемы вызывает `ENGINE_PANIC`.*

---

## 10. Реестр Остаточных Рисков (Residual Risk List)
Несмотря на Enterprise-ужесточение, сохраняются следующие риски, делегируемые на Governance:
1. **Задержка Оракула (Oracle Latency):** Статус `macro_shock_flag` зависит от внешнего оракула. Задержка публикации приведет к "пробитию" макро-защиты для ферм, закрывших сезон до апдейта. Решается через Level F Dispute Protocol.
2. **Линейность OLS на Долгих Горизонтах:** Расчет $b_{OLS}$ подразумевает линейную регенерацию. На горизонтах $N > 10$ сезонов регенерация выходит на плато. Текущая математика может начать штрафовать за плато. В версии `v2.0` потребуется переход от OLS к сигмоидной аппроксимации.
