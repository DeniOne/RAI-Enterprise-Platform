---
id: DOC-ARH-LVLF-006
type: Specification
layer: Architecture
status: Proposed
version: 1.1.1
owners: [@techlead]
last_updated: 2026-02-20
---

# УРОВЕНЬ F: ИНСТИТУЦИОНАЛЬНАЯ МОДЕЛЬ ФИНАНСОВЫХ СИГНАЛОВ (F_FINANCIAL_SIGNAL_MODEL)

## 0. Статус Документа и Версионирование
Данный документ является **Формальной Спецификацией (Production-Grade Level F v1.1.1 — Formal Closure Edition)** модели генерации производных финансовых сигналов. Модель предназначена для интеграции с Tier-1 банками, кредитными организациями и страховыми фондами. Спецификация полностью детерминирована, математически замкнута и пригодна для Due Diligence аудита класса "Big-4". Модель **не является решением о выдаче кредита**; она поставляет изолированные корректирующие риск-сигналы. Окончательное решение принимается на стороне финансовой организации.

- **FIN_MODEL_VERSION:** `F-1.1.1`
- **MODEL_HASH:** `7f83b1657ff1fc53b92dc18148a1d65dfc2d4b1fa3d677284addd200126d9069`
  *(Хэш SHA-256 вычисляется от детерминированной Canonical JSON-сериализации конфигурационного словаря, включающего в себя: AST-деревья формул CSM/IPD/CCE, значения констант $\alpha, \beta, \gamma$, логинку SMA, границы Clamp и триггеры Circuit Breaker. Это математически доказывает неизменность логики модели)*
- **Backward Compatibility Policy:** Любое изменение формул, диапазонов или логики (кроме non-breaking расширений API) требует поднятия MAJOR версии (`F-2.0.0`). Старые снимки MUST процесситься по версии модели, актуальной на момент их генерации.

---

## 1. Консистентность Времени (Time Consistency Definition)

Для исключения временных атак и неопределенностей (Time Horizon Conflict) фиксируются строгие понятия:
- **Агро-Сезон (Season):** Дискретная единица времени (обычно 1 год), завершающаяся генерацией `TrustSnapshot`. 
- **Фиксация Снимка (Snapshot Timing):** `snapshot_id` формируется строго после завершения сбора урожая и утверждения результатов аудитом Level C/D. Снимок неизменяем.
- **Временной Срез (Temporal Binding):** Финансовый сигнал всегда запрашивается для конкретного `snapshot_id`, который жестко привязан к конкретному завершенному сезону. Запрещено пересчитывать `snapshot_id` прошлых сезонов по новой MAJOR-версии модели. Сигнал детерминирован навсегда.

---

## 2. Области Определения и Размерности (Formal Parameter Specification)

Все входные и выходные параметры специфицированы математически. Выход за пределы допустимого диапазона (Out of Bounds) вызывает немедленный `REJECT` на уровне F-Gate.

### 2.1 Входные Параметры (Inputs from Level E/Level F Cerification)

| Параметр | Тип данных | Диапазон | Единицы | Описание и Инварианты | Поведение при OOB |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `FRS` | float | `[0.0, 1000.0]` | index_points | Farm Rating Score. Invariant: monotonic positive. | `REJECT` |
| `RCS` | float | `[0.0, 100.0]` | index_points | Risk Calibration Score. Invariant: monotonic positive. | `REJECT` |
| `P05_risk` | float | `[0.0, 1.0]` | probability | Вероятность >5% просадки урожая. Invariant: monotonic negative. | `REJECT` |
| `SRI_trend` | float | `[-1.0, 1.0]` | ratio / season | Наклон тренда регенерации (OLS). | `CLAMP [-1.0, 1.0]` |
| `Contract` | enumeration | `{MANAGED, ADVISORY, ...}` | category | Тип контракта Level E. | `REJECT IF NULL` |
| `NoCriticalMasks` | boolean | `{true, false}` | logic | Отсутствие критических нарушений (Level C). | `REJECT IF NULL` |

### 2.2 Константы Модели (Model Constants)

| Параметр | Тип данных | Значение | Единицы | Описание |
| :--- | :--- | :--- | :--- | :--- |
| $\alpha$ | integer | `200` | basis points (bps) | Максимальная награда для CSM. |
| $\beta$ | float | `0.30` | ratio | Максимальная скидка премии (IPD). |
| $\gamma$ | float | `0.50` | ratio | Штрафной мультипликатор риска (IPD). |

---

## 3. Основные Финансовые Сигналы (Core Signal Outputs)

Level F генерирует три первичных финансовых сигнала. Использование `Simple Moving Average` (SMA) применяется для сглаживания волатильности на горизонте 3 сезонов.

Определение функции SMA для параметра $X$ (выполняется СТРОГО ПОСЛЕ проверки Circuit Breaker):
$$
\text{SMA}_3(X_t) = \begin{cases} 
\frac{X_t + X_{t-1} + X_{t-2}}{3}, & \text{если есть 3 сезона} \\
\frac{\sum_{i=1}^{k} X_i}{k}, & \text{если } k < 3 \text{ сезонов} \\
\text{NULL}, & \text{если } k = 0 \text{ (Отсутствие данных)}
\end{cases}
$$

### 3.1 Модификатор Кредитного Скоринга (Credit Scoring Modifier — CSM)
**Назначение:** Коррекция процентной ставки по операционным кредитам фермы.
**Максимальная выгода (Lower Bound):** $-200$ bps ($-2.00\%$)
**Верхняя граница (Upper Bound):** $0$ bps.

**Формула (Детерминированная):**
$$
\text{CSM}_t = \max\left(-\alpha, \quad \min\left(0, \quad -\alpha \cdot \frac{\text{SMA}_3(FRS_t)}{1000} \cdot (1 - \text{SMA}_3(P05\_risk_t))\right)\right)
$$
*Замечание: При `FRS = 0` или `P05 = 1.0`, `CSM = 0` (скидка отсутствует).*

### 3.2 Скидка на Страховую Премию (Insurance Premium Discount — IPD)
**Назначение:** Процентное снижение или увеличение (surcharge) базовой страховой премии на основе подтвержденной устойчивости (RCS) и штрафа за риск (P05).

**Спецификация интерпретации:** 
Поле `ipd_ratio` является **мультипликатором изменения** (multiplier delta). Положительное значение означает **скидку**, отрицательное — **наценку (surcharge)**. 
**Диапазон:** $[-0.50, 0.30]$ (от $-50\%$ штрафа до $+30\%$ скидки). 
**API-Интерпретация Страховщиком:** $\text{Final Premium} = \text{Base Premium} \cdot (1 - \text{ipd\_ratio})$. *(Т.е. IPD = 0.230 снижает премию на 23%)*.

**Формула:**
$$
\text{IPD}_t = \max\left(-\gamma, \quad \min\left(\beta, \quad \beta \cdot \frac{\text{SMA}_3(RCS_t)}{100} - \gamma \cdot \text{SMA}_3(P05\_risk_t)\right)\right)
$$

### 3.3 Право на Карбоновые Кредиты (Carbon Credit Eligibility — CCE)
**Назначение:** Строгий бинарный гейт для участия в углеродном рынке. Требует устойчивого тренда минимум 2 сезона.
**Формула (Boolean Evaluation):**
$$
\text{CCE}_t = (\text{Seasons} \ge 2) \land (\text{SMA}_2(SRI\_trend_t) > 0.0) \land (\text{Contract} \in \{\text{MANAGED}, \text{ADVISORY}\}) \land (\text{NoCriticalMasks} == \text{TRUE})
$$

---

## 4. Инварианты Финансового Слоя (Formal Invariants)

Архитектура гарантирует банкам и регуляторам нерушимость следующих аксиом:

1. **Монотонность CSM по FRS:** $\frac{\partial \text{CSM}}{\partial \text{FRS}} \le 0$.
2. **Антимонотонность по P05:** Рост риска P05 математически обязан снижать финансовую выгоду: скидка уменьшается (CSM стремится к 0) и страховка дорожает (IPD стремится в отрицательную зону).
3. **Строгое Граничное Условие (Clamp):** Ни один сигнал никогда не превысит установленных $\alpha$, $\beta$, $\gamma$.
4. **Некоординированный Лимит Выгоды (No Cross-Institution Benefit Coordination):** Совокупная выгода (Credit Discount + Insurance Discount + Carbon Credit) не лимитируется на уровне Level F. Level F **does not coordinate cross-institution benefit caps**. Каждый институт применяет собственные риск-оверлеи (risk overlays) и лимитирует свои потери независимо.
5. **Ортогональность Внутридневной Волатильности:** Сигналы пересчитываются строго раз за сезон.
6. **Детерминированность:** Из одного и того же `snapshot_id` при фиксированном `FIN_MODEL_VERSION` функция извлечения финансового сигнала MUST выдавать побитово идентичный результат.

---

## 5. Защита от Рисков и Краевые Сценарии (Circuit Breakers & Edge Cases)

### 5.1 Автоматический Выключатель (Circuit Breaker)
Автоматический выключатель **ИМЕЕТ АБСОЛЮТНЫЙ ПРИОРИТЕТ** над сглаживанием SMA (SMA выполняется СТРОГО ПОСЛЕ оценки CB). Это ликвидирует сценарий, при котором мощный шок в периоде $t$ скрывается плавной SMA. Сравнение идет между моментальными кадрами $t$ и $t-1$.

**Условие Активации (Absolute Shock):**
$$
\text{If } (P05_t - P05_{t-1}) > 0.1 \implies \text{SUSPEND\_FINANCIAL\_SIGNALS}
$$
**Следствие:** При скачке вероятности провала урожая более чем на 10% (0.1), все выходы принудительно устанавливаются в $\text{CSM} = 0$, $\text{IPD} = 0$, $\text{CCE} = \text{FALSE}$ на срок **1 (Один) полный сезон**. Разблокировка требует ручного макро-аудита или прохождения полного цикла пересертификации фермы.

### 5.2 Edge Cases (Обработка Исключений)
- **Extreme FRS Drops:** Если FRS падает до `0`, CSM становится `0` (отмена кредитной скидки).
- **Extreme Disaster (P05 = 1.0):** Если ферма гарантированно погибнет, $\text{CSM} = 0$, $\text{IPD} = -\gamma$ (максимальная наценка на страховку).
- **Missing Data (Недостаток Истории):** Если $k=0$ (новая ферма без завершенного сезона), запросы возвращают статус `404 Not Found`.

---

## 6. Устойчивость к Манипуляциям (Model Manipulation Resistance)

Модель содержит встроенные защитные контуры от направленного игрового поведения (Gaming):
1. **Artificial Smoothing Attack:** Защита от попытки фермы искусственно "сгладить" FRS перед концом сезона. Спецификация Level E оценивает волатильность за весь вегетационный период, не давая "спрятать" шок в конце таймлайна.
2. **Snapshot Timing Attack:** Снимок генерируется СТРОГО системно по закрытию сезона. Клиент (фермер) не может выбрать "выгодный день" для генерации `snapshot_id`.
3. **Strategic Crop Declaration:** Ускоренное переключение культур сбрасывает SMA историю тренда регенерации (требуется Continuity Gate из Level C), обрушая CCE и CSM для спекулятивных фермеров.
4. **Selective Upgrade Attack:** Попытка купить `MANAGED` контракт за один день до закрытия сезона не дает CCE, т.к. `SMA_2` требует минимум два сезона нахождения в стабильном контракте с подтвержденной регенерацией.

---

## 7. Спецификация API (API Specification)

API предоставляет изолированный доступ финансовым учреждениям по протоколу HTTPS.

### 7.1 Endpoint: Узнать Финансовые Сигналы
- **HTTP Method:** `POST`
- **Path:** `/api/v1/financial-signal`
- **Authentication:** OAuth2 (Client Credentials) + mTLS (Bank Identity).

### 7.2 Ожидаемый Запрос (Input Schema)
Сервер принимает JSON тело. Все вычисления детерминированно опираются на представленный слепок `snapshot_id`.
```json
{
  "request_id": "uuid-v4",
  "snapshot_id": "uuid-v4",
  "farm_id": "uuid-v4",
  "timestamp": "YYYY-MM-DDThh:mm:ssZ"
}
```

### 7.3 Структура Ответа (Output Schema)
```json
{
  "$schema": "https://level-f.rai.io/schemas/fin-signal-response/v1.json",
  "snapshot_id": "uuid-v4",
  "farm_id": "uuid-v4",
  "csm_basis_points": -176.4,
  "ipd_ratio": 0.230,
  "cce_eligible": true,
  "model_version": "F-1.1.1",
  "generated_at": "YYYY-MM-DDThh:mm:ssZ",
  "circuit_breaker_active": false,
  "signal_signature": {
    "signer_pubkey": "...",
    "hash": "...",
    "signature": "..."
  }
}
```
*(Особое пояснение для парсера: IPD интерпретируется как Final Premium = Base Premium * (1 - ipd_ratio))*.

**HTTP Status Codes:** `200 OK`, `400 Bad Request`, `403 Forbidden`, `404 Not Found`, `410 Gone`, `422 Unprocessable Entity`.

---

## 8. Криптографическая Целостность Подписи (Signal Integrity)

Сигнал является защищенным юридическим документом.
- **Алгоритм:** Ed25519 (RFC 8032) PureEdDSA с детерминированным Nonce.
- **Payload для подписи:** Строго Canonical JSON (RFC 8785) всего объекта ответа, за вычетом самого блока `"signal_signature"`.
- **Защита от изменений:** Присутствие `snapshot_id` и `model_version` внутри захешированного и подписанного payload гарантирует, что сигнал посчитан именно по этой версии алгоритма для конкретных микро-данных. Попытка банка "выдать" эти же результаты для следующего сезона сломает привязку хеша к `snapshot_id`.

---

## 9. Аудиторский Протокол (Audit Protocol & Forensic Reconstruction)

### 9.1 Immutable Event Log (Соответствие SEC 17a-4(f))
Все вызовы API от финансовых институтов логируются в append-only WORM хранилище.
**Структура Записи:** 
`[Timestamp] [Bank_OAuth_ID] [Farm_ID] [Snapshot_ID] [CB_State] [Output_Hash]`

### 9.2 Порядок Форензики (Forensic Reconstruction Procedure)
Любой аудитор (Big-4) имеет право потребовать воссоздания исторического сигнала.
**Процедура:**
1. Аудитор извлекает `TrustSnapshot` по `Snapshot_ID` из WORM-хранилища Level E.
2. Аудитор загружает код `FIN_MODEL_VERSION`.
3. Аудитор локально исполняет формулу $\max / \min$, CB-Gate и SMA.
4. Итоговый `output_hash` MUST побитово совпасть с хешем, сохраненным в Audit Event Log. Расхождение означает критическую компрометацию Layer F.

---

## 10. Регуляторные Положения (Regulatory Considerations)

1. **Не является кредитным решением:** Сигнал `CSM` несет рекомендательный характер корректировки процентной ставки. Модель `F_FIN_LAYER` не производит KYC/AML, не оценивает залоги фермера и не принимает решения о выдаче ликвидности.
2. **Ответственность Финального Кредитора:** Окончательное одобрение кредитного лимита и итоговой ставки остается исключительной прерогативой банковского комитета.
3. **Прозрачность Модели:** Модель не использует подходы Black-Box AI. Алгоритм является White-Box линейной математикой с явными ограничителями, что удовлетворяет требованиям Basel III/IV к операционным риск-моделям.
