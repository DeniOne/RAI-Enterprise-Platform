# YIELD_PROBABILITY_MODEL_SPEC.md

## 0. Статус документа

- **Система:** RAI_Enterprise_Platform
- **Компонент:** Yield Probability Model (Level B)
- **Статус:** FORMAL SPECIFICATION
- **Зависимости:** INVARIANT_EXTENSION_FOR_LEVEL_B.md, FSM_EXTENSION_LEVEL_B.md
- **Document Maturity Level:** D3 (Verification-Ready)

---

## 1. Назначение (Purpose)

Данный документ ДОЛЖЕН определить формальную спецификацию модели вероятностного прогнозирования урожайности в рамках Level B платформы RAI Enterprise Platform. Модель ДОЛЖНА обеспечивать детерминированное прогнозирование урожайности с явными вероятностными границами и прослеживаемостью.

Спецификация ДОЛЖНА обеспечить:
- Прослеживаемость модели урожайности (I20)
- Вероятностные инварианты (I25, I26, I27) для B2+
- Детерминированное прогнозирование для B1 (I19)
- Объяснимость прогнозов (I24)

---

## 2. Область применения (Scope)

### 2.1 Входит в область

- Формальное определение сущности `YieldForecast`
- Ограничения распределения вероятностей (I25, I26, I27)
- Версионирование модели и прослеживаемость (I20)
- Гарантии детерминизма для фазы B1
- Требования к объяснимости (I24)
- Контракты интеграции с Generative Engine

### 2.2 Не входит в область (см. Раздел 10)

- Архитектура модели машинного обучения
- Пайплайны обучающих данных
- Процедуры обучения модели
- Настройка гиперпараметров
- Бенчмарки производительности
- UI для визуализации прогнозов
- Реализация схемы базы данных

---

## 3. Формальные определения (Formal Definitions)

### 3.1 Сущность YieldForecast

```
YieldForecast := {
  id: UUID,
  techMapId: UUID,
  forecastedYield: ℝ⁺,
  confidenceInterval: (ℝ⁺, ℝ⁺),
  probability: ProbabilityDistribution | null,
  modelVersion: String,
  inputData: InputDataSnapshot,
  forecastedAt: ISO8601,
  hash: SHA256,
  explainability: ExplainabilityRecord
}
```

### 3.2 ProbabilityDistribution (только B2+)

```
ProbabilityDistribution := {
  type: 'NORMAL' | 'LOGNORMAL' | 'BETA',
  parameters: Map<String, ℝ>,
  quantiles: Map<Percentile, ℝ⁺>
}

Ограничения (I25, I26, I27):
  1. Нормализация (I25):
     ∫ p(y) dy = 1
  
  2. Границы (I26):
     ∀y: 0 ≤ p(y) ≤ 1
  
  3. Доверительный интервал (I27):
     confidence = P(y ∈ [lower, upper])
     0.8 ≤ confidence ≤ 0.99
```

### 3.3 InputDataSnapshot

```
InputDataSnapshot := {
  techMapOperations: Json,
  historicalYields: ℝ⁺[],
  weatherData: Json,
  soilData: Json,
  snapshotHash: SHA256
}
```

### 3.4 ExplainabilityRecord (I24)

```
ExplainabilityRecord := {
  primaryFactors: Factor[],
  modelRationale: String,
  confidenceJustification: String,
  limitationsDisclosed: Boolean
}

Factor := {
  name: String,
  impact: ℝ,          // от -1.0 до 1.0
  confidence: ℝ       // от 0.0 до 1.0
}
```

---

## 4. Маппинг инвариантов (Invariant Mapping) — только I15–I28

### 4.1 Покрываемые инварианты

**I20: Прослеживаемость модели урожайности**
- **Требование:** Каждый прогноз ДОЛЖЕН записывать версию модели, снимок входных данных и временную метку.
- **Механизм:** Сущность `YieldForecast` включает `modelVersion`, `inputData`, `forecastedAt`, `hash`.
- **Trace:** [TRACE-LB-DOMAIN-101]

**I19: Детерминированная генерация** (B1 Strict)
- **Требование:** Для B1 идентичные входные данные ДОЛЖНЫ производить идентичный прогноз (без вероятности).
- **Механизм:** Поле `probability` равно `null` для B1. Прогноз вычисляется через детерминированную функцию.
- **Trace:** [TRACE-LB-DOMAIN-102]

**I24: Обязательная объяснимость**
- **Требование:** Каждый прогноз ДОЛЖЕН включать `ExplainabilityRecord` с раскрытыми ограничениями.
- **Механизм:** Поле `explainability` НЕ NULL. Поле `limitationsDisclosed` ДОЛЖНО быть `true`.
- **Trace:** [TRACE-LB-DOMAIN-103]

**I25: Нормализация вероятности** (B2+)
- **Требование:** Распределение вероятности ДОЛЖНО интегрироваться в 1.
- **Механизм:** Функция валидации `∫ p(y) dy = 1 ± ε`, где `ε = 0.001`.
- **Trace:** [TRACE-LB-DOMAIN-104]

**I26: Границы вероятности** (B2+)
- **Требование:** Все значения вероятности ДОЛЖНЫ быть в диапазоне [0, 1].
- **Механизм:** Функция валидации `∀y: 0 ≤ p(y) ≤ 1`.
- **Trace:** [TRACE-LB-DOMAIN-105]

**I27: Доверительный интервал** (B2+)
- **Требование:** Уровень доверия ДОЛЖЕН быть между 80% и 99%.
- **Механизм:** Функция валидации `0.8 ≤ confidence ≤ 0.99`.
- **Trace:** [TRACE-LB-DOMAIN-106]

### 4.2 Непокрываемые инварианты

I15, I16, I17, I18, I21, I22, I23, I28 НЕ применимы к данному компоненту.

---

## 5. Выравнивание FSM (FSM Alignment)

### 5.1 Жизненный цикл прогноза урожайности

Компонент прогнозирования урожайности НЕ имеет собственного FSM. Прогнозы являются **неизменяемыми снимками** после создания.

### 5.2 Связь с FSM TechMap

Прогнозы урожайности МОГУТ генерироваться в следующих состояниях TechMap:

- `GENERATED_DRAFT`: Прогноз генерируется как часть генеративного процесса
- `APPROVED`: Прогноз запрашивается пользователем для утверждённой TechMap
- `FROZEN`: Исторический прогноз для замороженной TechMap

Ограничения:
- Прогнозы НЕ ДОЛЖНЫ изменять состояние TechMap
- Прогнозы НЕ ДОЛЖНЫ инициировать переходы FSM
- Прогнозы являются сущностями только для чтения

**Trace:** [TRACE-LB-DOMAIN-107]

---

## 6. Ограничения детерминизма (Determinism Constraints)

### 6.1 DC-1: Строгий детерминизм B1

**Ограничение:** Для фазы B1:
```
∀ входных данных I₁, I₂:
  I₁ = I₂ ⇒ forecast(I₁) = forecast(I₂)

где равенство — это побайтовая идентичность:
  - forecastedYield
  - confidenceInterval
  - hash
```

**Механизм:** Прогнозы B1 НЕ ДОЛЖНЫ использовать вероятностные модели. Использовать только детерминированную регрессию.

**Trace:** [TRACE-LB-DOMAIN-108]

### 6.2 DC-2: Неизменяемость снимка входных данных

**Ограничение:**
```
hash(inputData) = SHA256(
  techMapOperations ||
  historicalYields ||
  weatherData ||
  soilData
)

После создания прогноза:
  inputData неизменяем
```

**Механизм:** `InputDataSnapshot` замораживается при создании прогноза.

**Trace:** [TRACE-LB-DOMAIN-109]

### 6.3 DC-3: Статистическая эквивалентность B2+

**Ограничение:** Для фазы B2+ с вероятностными моделями:
```
∀ входных данных I с seed S:
  forecast(I, S)₁ ≈ forecast(I, S)₂

где ≈ обозначает статистическую эквивалентность:
  |mean(y₁) - mean(y₂)| < ε_mean
  |std(y₁) - std(y₂)| < ε_std
```

**Параметры:** `ε_mean = 0.01 т/га`, `ε_std = 0.001 т/га`

**Trace:** [TRACE-LB-DOMAIN-110]

---

## 7. Стратегия верификации (Verification Strategy)

### 7.1 Структурные тесты (L3)

**Тест:** Проверка соответствия схеме YieldForecast
```
Дано: сущность forecast
Когда: validate_schema(forecast)
Тогда: проходит все проверки обязательных полей, включая explainability
```
**Trace:** [TRACE-LB-TEST-101]

### 7.2 Тесты формальных инвариантов (L4)

**Тест I20-01:** Полнота прослеживаемости
```
Дано: прогноз f
Когда: validate_traceability(f)
Тогда: f.modelVersion NOT NULL AND
      f.inputData NOT NULL AND
      f.forecastedAt NOT NULL AND
      f.hash NOT NULL
```
**Trace:** [TRACE-LB-TEST-102]

**Тест I24-01:** Обязательная объяснимость
```
Дано: прогноз f
Когда: validate_explainability(f)
Тогда: f.explainability NOT NULL AND
      f.explainability.limitationsDisclosed = true AND
      f.explainability.primaryFactors.length > 0
```
**Trace:** [TRACE-LB-TEST-103]

**Тест I25-01:** Нормализация вероятности (B2+)
```
Дано: прогноз f с распределением вероятности p
Когда: вычислить интеграл ∫ p(y) dy
Тогда: |integral - 1.0| < 0.001
```
**Trace:** [TRACE-LB-TEST-104]

**Тест I26-01:** Границы вероятности (B2+)
```
Дано: прогноз f с распределением вероятности p
Когда: выборка y из p
Тогда: ∀y: 0 ≤ p(y) ≤ 1
```
**Trace:** [TRACE-LB-TEST-105]

**Тест I27-01:** Доверительный интервал (B2+)
```
Дано: прогноз f с доверительным интервалом [L, U]
Когда: вычислить confidence = P(y ∈ [L, U])
Тогда: 0.8 ≤ confidence ≤ 0.99
```
**Trace:** [TRACE-LB-TEST-106]

**Тест I19-01:** Детерминизм B1
```
Дано: входные данные I и модель B1
Когда: forecast(I) вызван N раз
Тогда: все N результатов побайтово идентичны
```
**Trace:** [TRACE-LB-TEST-107]

### 7.3 Тесты на основе свойств (L5)

**Свойство PBT-01:** Детерминизм для B1
```
Свойство: ∀ входных данных I:
  ∀ n ∈ ℕ: forecast_B1(I)₀ = forecast_B1(I)ₙ
Trace: [TRACE-LB-TEST-108]
```

**Свойство PBT-02:** Статистическая эквивалентность для B2+
```
Свойство: ∀ входных данных I, seed S:
  distance(forecast(I,S)₁, forecast(I,S)₂) < ε
Trace: [TRACE-LB-TEST-109]
```

---

## 8. Критерии приёмки (Acceptance Criteria) — бинарные

### 8.1 Обязательные критерии

| ID | Критерий | Статус |
|----|----------|--------|
| AC-01 | Прослеживаемость I20 обеспечена | ✓ ОПРЕДЕЛЁН |
| AC-02 | Объяснимость I24 обязательна | ✓ ОПРЕДЕЛЁН |
| AC-03 | Нормализация вероятности I25 (B2+) | ✓ ОПРЕДЕЛЁН |
| AC-04 | Границы вероятности I26 (B2+) | ✓ ОПРЕДЕЛЁН |
| AC-05 | Доверительный интервал I27 (B2+) | ✓ ОПРЕДЕЛЁН |
| AC-06 | Детерминизм B1 I19 обеспечен | ✓ ОПРЕДЕЛЁН |
| AC-07 | Снимок входных данных неизменяем | ✓ ОПРЕДЕЛЁН |

### 8.2 Верификационные ворота

**Ворота G1:** Все тесты L4 (TRACE-LB-TEST-101 — TRACE-LB-TEST-107) ДОЛЖНЫ пройти.

**Ворота G2:** Тесты на основе свойств (PBT-01 для B1, PBT-02 для B2+) ДОЛЖНЫ пройти для 10,000 сгенерированных входных данных.

**Ворота G3:** Полнота объяснимости ДОЛЖНА быть верифицирована для 100% прогнозов.

---

## 9. Матрица прослеживаемости (Traceability Matrix)

| Trace ID | Тип | Требование | Метод верификации | Статус |
|----------|-----|------------|-------------------|--------|
| TRACE-LB-DOMAIN-101 | Инвариант | I20: Прослеживаемость модели | L4 Тест I20-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-102 | Инвариант | I19: Детерминизм B1 | L4 Тест I19-01, PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-103 | Инвариант | I24: Объяснимость | L4 Тест I24-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-104 | Инвариант | I25: Нормализация | L4 Тест I25-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-105 | Инвариант | I26: Границы | L4 Тест I26-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-106 | Инвариант | I27: Доверие | L4 Тест I27-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-107 | FSM | Нет FSM / Только чтение | Структурный тест | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-108 | Ограничение | DC-1: Детерминизм B1 | PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-109 | Ограничение | DC-2: Неизменяемость снимка | Автоматизированный | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-110 | Ограничение | DC-3: Эквивалентность B2+ | PBT-02 | ОПРЕДЕЛЁН |
| TRACE-LB-TEST-101 | Тест | Валидация схемы | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-102 | Тест | I20-01: Прослеживаемость | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-103 | Тест | I24-01: Объяснимость | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-104 | Тест | I25-01: Нормализация | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-105 | Тест | I26-01: Границы | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-106 | Тест | I27-01: Доверие | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-107 | Тест | I19-01: Детерминизм B1 | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-108 | Тест | PBT-01: Детерминизм | Property-Based | В ОЖИДАНИИ |
| TRACE-LB-TEST-109 | Тест | PBT-02: Статистич. эквив. | Property-Based | В ОЖИДАНИИ |

---

## 10. Вне области применения (Out of Scope)

Следующее ЯВНО ИСКЛЮЧЕНО из области данной спецификации:

1. **Машинное обучение:** Архитектура модели, алгоритмы обучения, дизайн нейронных сетей
2. **Обучающие данные:** Сбор данных, очистка, feature engineering
3. **Производительность:** Задержка инференса, размер модели, оптимизация GPU
4. **Выбор модели:** Сравнение ML-фреймворков, настройка гиперпараметров
5. **UI/UX:** Визуализация прогнозов, дизайн дашбордов
6. **Хранение:** Стратегия персистентности прогнозов, индексирование БД
7. **Real-time:** Потоковые предсказания, онлайн-обучение
8. **A/B тестирование:** Сравнение моделей, champion/challenger workflows

Эти вопросы ДОЛЖНЫ быть рассмотрены в отдельных спецификациях ML-инженерии и продукта.

---

## Document Maturity Level: D3 (Verification-Ready)

**Обоснование:**
- ✓ Структурно завершён (D1)
- ✓ Выровнен с инвариантами (D2): I20, I19, I24, I25, I26, I27 явно замаплены
- ✓ Готов к верификации (D3): Все стратегии тестирования определены с trace ID
- ✗ Утверждён для реализации (D4): Требуется выбор ML-модели и план интеграции

**Следующие шаги:**
1. Выбрать детерминированную регрессионную модель для B1
2. Выбрать вероятностную модель для B2+ (с гарантиями нормализации)
3. Реализовать тесты L4 и L5
4. Определить контракт интеграции с Generative Engine
5. Получить утверждение стейкхолдеров для повышения до D4
