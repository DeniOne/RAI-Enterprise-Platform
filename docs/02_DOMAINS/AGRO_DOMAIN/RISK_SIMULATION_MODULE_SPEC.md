# RISK_SIMULATION_MODULE_SPEC.md

## 0. Статус документа

- **Система:** RAI_Enterprise_Platform
- **Компонент:** Risk Simulation Module (Level B)
- **Статус:** FORMAL SPECIFICATION
- **Зависимости:** INVARIANT_EXTENSION_FOR_LEVEL_B.md, FSM_EXTENSION_LEVEL_B.md
- **Document Maturity Level:** D3 (Verification-Ready)

---

## 1. Назначение (Purpose)

Данный документ ДОЛЖЕН определить формальную спецификацию модуля симуляции рисков в рамках Level B платформы RAI Enterprise Platform. Модуль ДОЛЖЕН обеспечивать изолированную симуляцию сценариев "что если" без влияния на производственные данные.

Спецификация ДОЛЖНА обеспечить:
- Изоляцию симуляций (I22)
- Детерминированность симуляций при фиксированном seed (I19)
- Прослеживаемость параметров симуляции
- Отсутствие влияния на FSM TechMap

---

## 2. Область применения (Scope)

### 2.1 Входит в область

- Формальное определение сущности `SimulationRun`
- Изоляция симуляций от производственных данных (I22)
- Детерминизм симуляций (I19)
- Типы сценариев симуляции
- Контракты интеграции с TechMap и Yield Model
- Правила хранения результатов симуляции

### 2.2 Не входит в область (см. Раздел 10)

- Алгоритмы симуляции погодных условий
- Модели роста растений
- Экономические модели
- UI для настройки сценариев
- Визуализация результатов
- Производительность симуляций
- Реализация схемы базы данных

---

## 3. Формальные определения (Formal Definitions)

### 3.1 Сущность SimulationRun

```
SimulationRun := {
  id: UUID,
  scenarioType: ScenarioType,
  scenarioParams: ScenarioParams,
  baseTechMapId: UUID,
  results: SimulationResults,
  isProduction: Boolean,
  seed: ℕ | null,
  hash: SHA256,
  createdAt: ISO8601,
  createdBy: UUID
}

Инвариант I22:
  isProduction MUST = false
```

### 3.2 ScenarioType

```
ScenarioType := 
  | WEATHER_ANOMALY      // Экстремальные погодные условия
  | SOWING_DATE_SHIFT    // Изменение сроков посева
  | FERTILIZER_RATE      // Изменение норм внесения удобрений
  | PEST_OUTBREAK        // Вспышка вредителей
  | PRICE_VOLATILITY     // Волатильность цен
  | RESOURCE_SHORTAGE    // Дефицит ресурсов
```

### 3.3 ScenarioParams

```
ScenarioParams := {
  modifications: Modification[],
  constraints: Constraint[],
  duration: Duration
}

Modification := {
  target: ModificationTarget,
  delta: ℝ | Json,
  unit: String
}

ModificationTarget := 
  | OPERATION_DATE
  | RESOURCE_RATE
  | WEATHER_PARAMETER
  | PRICE_PARAMETER
```

### 3.4 SimulationResults

```
SimulationResults := {
  forecastedYield: ℝ⁺,
  yieldDelta: ℝ,              // Δ относительно базового прогноза
  economicImpact: ℝ,          // В валюте
  riskScore: ℝ,               // 0.0 - 1.0
  detailedMetrics: Json,
  computedAt: ISO8601
}
```

---

## 4. Маппинг инвариантов (Invariant Mapping) — только I15–I28

### 4.1 Покрываемые инварианты

**I22: Изоляция симуляций**
- **Требование:** Результаты симуляций ДОЛЖНЫ храниться отдельно от производственных данных. Симуляции НЕ ДОЛЖНЫ изменять состояние TechMap.
- **Механизм:** Поле `isProduction` ВСЕГДА равно `false`. Симуляции НЕ создают записи в производственных таблицах.
- **Trace:** [TRACE-LB-DOMAIN-201]

**I19: Детерминированная генерация** (частично)
- **Требование:** При фиксированном `seed` и идентичных параметрах симуляция ДОЛЖНА производить идентичные результаты.
- **Механизм:** Если `seed` указан, все стохастические процессы используют этот seed.
- **Trace:** [TRACE-LB-DOMAIN-202]

### 4.2 Непокрываемые инварианты

I15, I16, I17, I18, I20, I21, I23, I24, I25, I26, I27, I28 НЕ применимы к данному компоненту.

---

## 5. Выравнивание FSM (FSM Alignment)

### 5.1 Жизненный цикл симуляции

Модуль симуляции НЕ имеет собственного FSM. Симуляции являются **неизменяемыми снимками** после создания.

### 5.2 Связь с FSM TechMap

Симуляции МОГУТ запускаться для TechMap в следующих состояниях:

- `DRAFT`: Симуляция для черновика
- `REVIEW`: Симуляция для оценки рисков перед утверждением
- `APPROVED`: Симуляция для утверждённой TechMap
- `FROZEN`: Ретроспективная симуляция для замороженной TechMap

**Критическое ограничение (I22):**
```
∀ simulation s:
  s.isProduction = false
  
∀ TechMap t:
  run_simulation(t) ⇏ modify(t)
  run_simulation(t) ⇏ transition(t)
```

Симуляции НЕ ДОЛЖНЫ:
- Изменять состояние TechMap
- Инициировать переходы FSM
- Создавать производственные записи

**Trace:** [TRACE-LB-DOMAIN-203]

---

## 6. Ограничения детерминизма (Determinism Constraints)

### 6.1 DC-1: Детерминизм при фиксированном seed

**Ограничение:**
```
∀ параметров сценария P, seed S:
  simulate(P, S)₁ = simulate(P, S)₂

где равенство — это побайтовая идентичность:
  - forecastedYield
  - yieldDelta
  - economicImpact
  - riskScore
  - hash
```

**Механизм:** Все стохастические процессы (погода, вредители, цены) ДОЛЖНЫ использовать детерминированный генератор с фиксированным seed.

**Trace:** [TRACE-LB-DOMAIN-204]

### 6.2 DC-2: Неизменяемость параметров сценария

**Ограничение:**
```
hash(simulation) = SHA256(
  scenarioType ||
  scenarioParams ||
  baseTechMapId ||
  seed
)

После создания симуляции:
  scenarioParams неизменяемы
```

**Механизм:** `ScenarioParams` замораживаются при создании симуляции.

**Trace:** [TRACE-LB-DOMAIN-205]

### 6.3 DC-3: Изоляция от производственных данных

**Ограничение:**
```
∀ simulation s:
  s.isProduction = false
  
∀ производственной таблицы T:
  simulate() ⇏ write(T)
```

**Механизм:** Симуляции работают только с копиями данных. Запись в производственные таблицы запрещена на уровне прав доступа.

**Trace:** [TRACE-LB-DOMAIN-206]

---

## 7. Стратегия верификации (Verification Strategy)

### 7.1 Структурные тесты (L3)

**Тест:** Проверка соответствия схеме SimulationRun
```
Дано: сущность simulation
Когда: validate_schema(simulation)
Тогда: проходит все проверки обязательных полей
      AND simulation.isProduction = false
```
**Trace:** [TRACE-LB-TEST-201]

### 7.2 Тесты формальных инвариантов (L4)

**Тест I22-01:** Изоляция от производственных данных
```
Дано: симуляция s
Когда: run_simulation(s)
Тогда: s.isProduction = false
      AND нет записей в производственных таблицах
```
**Trace:** [TRACE-LB-TEST-202]

**Тест I22-02:** Отсутствие влияния на TechMap FSM
```
Дано: TechMap t в состоянии S
Когда: run_simulation(t, scenario)
Тогда: t.status = S (не изменилось)
      AND нет событий FSM
```
**Trace:** [TRACE-LB-TEST-203]

**Тест I19-01:** Детерминизм симуляции
```
Дано: параметры P и seed S
Когда: simulate(P, S) вызван N раз
Тогда: все N результатов побайтово идентичны
```
**Trace:** [TRACE-LB-TEST-204]

### 7.3 Тесты на основе свойств (L5)

**Свойство PBT-01:** Детерминизм при фиксированном seed
```
Свойство: ∀ параметров P, seed S:
  ∀ n ∈ ℕ: simulate(P, S)₀ = simulate(P, S)ₙ
Trace: [TRACE-LB-TEST-205]
```

**Свойство PBT-02:** Изоляция симуляций
```
Свойство: ∀ симуляции s:
  s.isProduction = false
  AND ∄ записей в производственных таблицах
Trace: [TRACE-LB-TEST-206]
```

---

## 8. Критерии приёмки (Acceptance Criteria) — бинарные

### 8.1 Обязательные критерии

| ID | Критерий | Статус |
|----|----------|--------|
| AC-01 | Изоляция I22 обеспечена | ✓ ОПРЕДЕЛЁН |
| AC-02 | Детерминизм I19 при фиксированном seed | ✓ ОПРЕДЕЛЁН |
| AC-03 | isProduction всегда false | ✓ ОПРЕДЕЛЁН |
| AC-04 | Нет влияния на FSM TechMap | ✓ ОПРЕДЕЛЁН |
| AC-05 | Параметры сценария неизменяемы | ✓ ОПРЕДЕЛЁН |
| AC-06 | Нет записи в производственные таблицы | ✓ ОПРЕДЕЛЁН |

### 8.2 Верификационные ворота

**Ворота G1:** Все тесты L4 (TRACE-LB-TEST-201 — TRACE-LB-TEST-204) ДОЛЖНЫ пройти.

**Ворота G2:** Тесты на основе свойств (PBT-01, PBT-02) ДОЛЖНЫ пройти для 10,000 сгенерированных сценариев.

**Ворота G3:** Изоляция от производственных данных ДОЛЖНА быть верифицирована на уровне прав доступа БД.

---

## 9. Матрица прослеживаемости (Traceability Matrix)

| Trace ID | Тип | Требование | Метод верификации | Статус |
|----------|-----|------------|-------------------|--------|
| TRACE-LB-DOMAIN-201 | Инвариант | I22: Изоляция симуляций | L4 Тест I22-01, I22-02 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-202 | Инвариант | I19: Детерминизм | L4 Тест I19-01, PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-203 | FSM | Нет влияния на FSM | L4 Тест I22-02 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-204 | Ограничение | DC-1: Детерминизм seed | PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-205 | Ограничение | DC-2: Неизменяемость параметров | Автоматизированный | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-206 | Ограничение | DC-3: Изоляция данных | PBT-02 | ОПРЕДЕЛЁН |
| TRACE-LB-TEST-201 | Тест | Валидация схемы | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-202 | Тест | I22-01: Изоляция данных | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-203 | Тест | I22-02: Нет влияния FSM | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-204 | Тест | I19-01: Детерминизм | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-205 | Тест | PBT-01: Детерминизм seed | Property-Based | В ОЖИДАНИИ |
| TRACE-LB-TEST-206 | Тест | PBT-02: Изоляция | Property-Based | В ОЖИДАНИИ |

---

## 10. Вне области применения (Out of Scope)

Следующее ЯВНО ИСКЛЮЧЕНО из области данной спецификации:

1. **Модели симуляции:** Алгоритмы погодных моделей, моделей роста растений
2. **Экономические модели:** Модели ценообразования, рыночной волатильности
3. **Производительность:** Оптимизация скорости симуляций, параллелизация
4. **UI/UX:** Интерфейс настройки сценариев, визуализация результатов
5. **Хранение:** Стратегия архивации старых симуляций
6. **Статистический анализ:** Агрегация результатов множественных симуляций
7. **Real-time:** Потоковые симуляции, онлайн-обновление параметров
8. **Интеграция:** Экспорт результатов в внешние системы

Эти вопросы ДОЛЖНЫ быть рассмотрены в отдельных спецификациях моделирования и продукта.

---

## Document Maturity Level: D3 (Verification-Ready)

**Обоснование:**
- ✓ Структурно завершён (D1)
- ✓ Выровнен с инвариантами (D2): I22, I19 явно замаплены
- ✓ Готов к верификации (D3): Все стратегии тестирования определены с trace ID
- ✗ Утверждён для реализации (D4): Требуется выбор моделей симуляции и план интеграции

**Следующие шаги:**
1. Выбрать модели симуляции для каждого типа сценария
2. Реализовать тесты L4 и L5
3. Настроить права доступа БД для обеспечения изоляции
4. Определить контракты интеграции с TechMap и Yield Model
5. Получить утверждение стейкхолдеров для повышения до D4
