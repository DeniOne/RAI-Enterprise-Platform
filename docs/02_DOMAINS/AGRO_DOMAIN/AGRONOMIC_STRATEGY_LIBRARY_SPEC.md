# AGRONOMIC_STRATEGY_LIBRARY_SPEC.md

## 0. Статус документа

- **Система:** RAI_Enterprise_Platform
- **Компонент:** Agronomic Strategy Library (Level B)
- **Статус:** FORMAL SPECIFICATION
- **Зависимости:** INVARIANT_EXTENSION_FOR_LEVEL_B.md, FSM_EXTENSION_LEVEL_B.md
- **Document Maturity Level:** D3 (Verification-Ready)

---

## 1. Назначение (Purpose)

Данный документ ДОЛЖЕН определить формальную спецификацию компонента Agronomic Strategy Library в рамках Level B платформы RAI Enterprise Platform. Библиотека ДОЛЖНА предоставлять неизменяемые, версионированные агрономические стратегии, которые служат входными данными для Generative Engine.

Спецификация ДОЛЖНА обеспечить:
- Неизменяемость стратегий после публикации (I18)
- Детерминированное получение стратегий (I19)
- Полную прослеживаемость использования стратегий (I16)

---

## 2. Область применения (Scope)

### 2.1 Входит в область

- Формальное определение сущности `AgronomicStrategy`
- Состояния жизненного цикла стратегий и переходы между ними
- Семантика версионирования стратегий
- Правила публикации и архивации
- Гарантии неизменяемости стратегий (I18)
- Контракты интеграции с Generative Engine

### 2.2 Не входит в область (см. Раздел 10)

- UI/UX для создания стратегий
- Алгоритмы валидации содержимого стратегий
- Машинное обучение для генерации стратегий
- Оптимизация производительности
- Реализация схемы базы данных
- Процедуры развертывания

---

## 3. Формальные определения (Formal Definitions)

### 3.1 Сущность AgronomicStrategy

```
AgronomicStrategy := {
  id: UUID,
  name: String,
  version: ℕ⁺,
  cropId: UUID,
  regionId: UUID,
  operations: OperationTemplate[],
  constraints: Constraint[],
  status: StrategyStatus,
  publishedAt: ISO8601 | null,
  hash: SHA256,
  metadata: StrategyMetadata
}
```

### 3.2 StrategyStatus

```
StrategyStatus := DRAFT | PUBLISHED | ARCHIVED

FSM_Strategy:
  DRAFT → PUBLISHED (событие публикации)
  PUBLISHED → ARCHIVED (событие архивации)
  
Запрещённые переходы:
  PUBLISHED ↛ DRAFT
  ARCHIVED ↛ DRAFT
  ARCHIVED ↛ PUBLISHED
```

### 3.3 OperationTemplate

```
OperationTemplate := {
  type: OperationType,
  relativeDay: ℤ,
  resourceRates: Map<ResourceType, Expression>,
  constraints: Constraint[]
}

Expression := Literal | Variable | Function
```

### 3.4 StrategyMetadata

```
StrategyMetadata := {
  author: UUID,
  createdAt: ISO8601,
  modifiedAt: ISO8601,
  source: 'MANUAL' | 'IMPORTED' | 'DERIVED',
  tags: String[]
}
```

---

## 4. Маппинг инвариантов (Invariant Mapping) — только I15–I28

### 4.1 Покрываемые инварианты

**I18: Неизменяемость библиотеки стратегий**
- **Требование:** После публикации стратегии её содержимое НЕ ДОЛЖНО изменяться.
- **Механизм:** Триггеры на уровне БД предотвращают изменения полей `operations`, `constraints`, `hash` при `status = 'PUBLISHED'`.
- **Trace:** [TRACE-LB-DOMAIN-001]

**I16: Провенанс генерации** (частично)
- **Требование:** ID стратегии и версия ДОЛЖНЫ записываться в `generationMetadata` при использовании Generative Engine.
- **Механизм:** Контракт с Generative Engine требует указания `strategyId` и `strategyVersion` в выходных данных.
- **Trace:** [TRACE-LB-DOMAIN-002]

**I19: Детерминированная генерация** (частично)
- **Требование:** Получение стратегии по ID и версии ДОЛЖНО возвращать идентичное содержимое при всех вызовах.
- **Механизм:** Неизменяемость (I18) + версионирование гарантируют детерминированное получение.
- **Trace:** [TRACE-LB-DOMAIN-003]

### 4.2 Непокрываемые инварианты

I15, I17, I20, I21, I22, I23, I24, I25, I26, I27, I28 НЕ применимы к данному компоненту.

---

## 5. Выравнивание FSM (FSM Alignment)

### 5.1 FSM жизненного цикла стратегии

```
Состояния: {DRAFT, PUBLISHED, ARCHIVED}

Переходы:
  T1: DRAFT → PUBLISHED
    Событие: PUBLISH_STRATEGY
    Условие: validate(strategy) = true
    Эффект: publishedAt := now(), hash := SHA256(content)
  
  T2: PUBLISHED → ARCHIVED
    Событие: ARCHIVE_STRATEGY
    Условие: нет
    Эффект: нет (содержимое остаётся неизменным)

Запрещено:
  PUBLISHED → DRAFT
  ARCHIVED → DRAFT
  ARCHIVED → PUBLISHED
```

### 5.2 Связь с FSM TechMap

FSM библиотеки стратегий работает **независимо** от FSM TechMap, определённого в `FSM_EXTENSION_LEVEL_B.md`. Однако:

- Generative Engine МОЖЕТ использовать только стратегии в состоянии `PUBLISHED` для создания `GENERATED_DRAFT` TechMap.
- Архивация стратегии НЕ ДОЛЖНА инвалидировать существующие TechMap, ссылающиеся на архивированную стратегию.

**Trace:** [TRACE-LB-DOMAIN-004]

---

## 6. Ограничения детерминизма (Determinism Constraints)

### 6.1 DC-1: Неизменяемое опубликованное содержимое

**Ограничение:** Для любой стратегии `s`, где `s.status = PUBLISHED`:
```
∀t₁, t₂ ∈ Timeline:
  retrieve(s.id, s.version, t₁) ≡ retrieve(s.id, s.version, t₂)
```

**Механизм:** Триггеры неизменяемости на уровне БД.

**Trace:** [TRACE-LB-DOMAIN-005]

### 6.2 DC-2: Детерминированный хеш

**Ограничение:** 
```
hash(strategy) = SHA256(
  strategy.id ||
  strategy.version ||
  strategy.cropId ||
  strategy.regionId ||
  serialize(strategy.operations) ||
  serialize(strategy.constraints)
)
```

**Механизм:** Вычисление хеша ДОЛЖНО исключать изменяемые поля (`status`, `modifiedAt`, `metadata`).

**Trace:** [TRACE-LB-DOMAIN-006]

### 6.3 DC-3: Монотонное версионирование

**Ограничение:**
```
Для стратегии с именем N, cropId C и regionId R:
  version(N, C, R)ᵢ₊₁ = version(N, C, R)ᵢ + 1
```

**Механизм:** Номера версий ДОЛЖНЫ быть последовательными и неизменяемыми.

**Trace:** [TRACE-LB-DOMAIN-007]

---

## 7. Стратегия верификации (Verification Strategy)

### 7.1 Структурные тесты (L3)

**Тест:** Проверка соответствия схеме стратегии
```
Дано: сущность strategy
Когда: validate_schema(strategy)
Тогда: проходит все проверки обязательных полей
```
**Trace:** [TRACE-LB-TEST-001]

### 7.2 Тесты формальных инвариантов (L4)

**Тест I18-01:** Попытка изменить опубликованную стратегию
```
Дано: стратегия s со status = PUBLISHED
Когда: попытка update(s, {operations: new_ops})
Тогда: операция ДОЛЖНА завершиться с ImmutabilityViolationException
```
**Trace:** [TRACE-LB-TEST-002]

**Тест I18-02:** Проверка неизменяемости хеша
```
Дано: стратегия s со status = PUBLISHED
Когда: retrieve(s.id) в моменты t₁ и t₂
Тогда: hash(s, t₁) = hash(s, t₂)
```
**Trace:** [TRACE-LB-TEST-003]

**Тест I19-01:** Детерминированное получение
```
Дано: стратегия s с id и version
Когда: retrieve(s.id, s.version) вызван N раз
Тогда: все N результатов ДОЛЖНЫ быть побайтово идентичны
```
**Trace:** [TRACE-LB-TEST-004]

### 7.3 Тесты на основе свойств (L5)

**Свойство PBT-01:** Монотонность версий
```
Свойство: ∀ опубликованных стратегий с одинаковыми (name, crop, region):
  версии образуют монотонно возрастающую последовательность
Trace: [TRACE-LB-TEST-005]
```

**Свойство PBT-02:** Детерминизм хеша
```
Свойство: ∀ стратегии s:
  hash(s) зависит только от неизменяемых полей содержимого
Trace: [TRACE-LB-TEST-006]
```

---

## 8. Критерии приёмки (Acceptance Criteria) — бинарные

### 8.1 Обязательные критерии

| ID | Критерий | Статус |
|----|----------|--------|
| AC-01 | Содержимое опубликованной стратегии неизменяемо | ✓ ОПРЕДЕЛЁН |
| AC-02 | Вычисление хеша детерминировано | ✓ ОПРЕДЕЛЁН |
| AC-03 | Номера версий последовательны | ✓ ОПРЕДЕЛЁН |
| AC-04 | Запрещённые переходы FSM заблокированы | ✓ ОПРЕДЕЛЁН |
| AC-05 | Инвариант I18 обеспечен | ✓ ОПРЕДЕЛЁН |
| AC-06 | Контракт интеграции с Generative Engine существует | ✓ ОПРЕДЕЛЁН |

### 8.2 Верификационные ворота

**Ворота G1:** Все тесты L4 (TRACE-LB-TEST-001 — TRACE-LB-TEST-004) ДОЛЖНЫ пройти.

**Ворота G2:** Тесты на основе свойств (PBT-01, PBT-02) ДОЛЖНЫ пройти для 10,000 сгенерированных стратегий.

**Ворота G3:** Обеспечение неизменяемости ДОЛЖНО быть верифицировано на уровне БД.

---

## 9. Матрица прослеживаемости (Traceability Matrix)

| Trace ID | Тип | Требование | Метод верификации | Статус |
|----------|-----|------------|-------------------|--------|
| TRACE-LB-DOMAIN-001 | Инвариант | I18: Неизменяемость стратегий | L4 Тест I18-01, I18-02 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-002 | Инвариант | I16: Провенанс генерации | Контрактный тест | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-003 | Инвариант | I19: Детерминированное получение | L4 Тест I19-01 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-004 | FSM | Независимый FSM | Структурный тест | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-005 | Ограничение | DC-1: Неизменяемое содержимое | L4 Тест | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-006 | Ограничение | DC-2: Детерминированный хеш | PBT-02 | ОПРЕДЕЛЁН |
| TRACE-LB-DOMAIN-007 | Ограничение | DC-3: Монотонное версионирование | PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-TEST-001 | Тест | Валидация схемы | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-002 | Тест | I18-01: Отклонение обновления | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-003 | Тест | I18-02: Неизменяемость хеша | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-004 | Тест | I19-01: Детерминизм получения | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-005 | Тест | PBT-01: Монотонность версий | Property-Based | В ОЖИДАНИИ |
| TRACE-LB-TEST-006 | Тест | PBT-02: Детерминизм хеша | Property-Based | В ОЖИДАНИИ |

---

## 10. Вне области применения (Out of Scope)

Следующее ЯВНО ИСКЛЮЧЕНО из области данной спецификации:

1. **UI/UX дизайн:** Интерфейсы создания стратегий, формы, визарды
2. **Валидация содержимого:** Агрономическая корректность шаблонов операций
3. **Производительность:** Оптимизация запросов, стратегии индексирования, кэширование
4. **Хранение:** Выбор БД, миграция схемы, процедуры резервного копирования
5. **Машинное обучение:** Автоматическая генерация или оптимизация стратегий
6. **Импорт/Экспорт:** Массовый импорт стратегий, конвертация внешних форматов
7. **Контроль доступа:** Ролевые разрешения для создания стратегий
8. **Workflow:** Процессы утверждения для публикации стратегий

Эти вопросы ДОЛЖНЫ быть рассмотрены в отдельных спецификациях или документах реализации.

---

## Document Maturity Level: D3 (Verification-Ready)

**Обоснование:**
- ✓ Структурно завершён (D1)
- ✓ Выровнен с инвариантами (D2): I18, I16, I19 явно замаплены
- ✓ Готов к верификации (D3): Все стратегии тестирования определены с trace ID
- ✗ Утверждён для реализации (D4): Требуется проверка плана реализации

**Следующие шаги:**
1. Создать триггеры неизменяемости на уровне БД
2. Реализовать тесты L4 и L5
3. Определить контракт интеграции с Generative Engine
4. Получить утверждение стейкхолдеров для повышения до D4
