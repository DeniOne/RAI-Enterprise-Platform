---
id: DOC-ARH-LVLF-KMR
type: Core Architecture
layer: Level F
status: Enforced
owners: [@techlead]
last_updated: 2026-02-20
---

# УРОВЕНЬ F: УПРАВЛЕНИЕ КЛЮЧАМИ И РОТАЦИЯ (KEY MANAGEMENT & ROTATION)

Данный документ описывает институциональный стандарт управления криптографическими ключами, описывающий жизненный цикл `Ed25519` подписей для сертификатов Level F. Подчиняется `LEVEL_F_SECURITY_MODEL.md`.

## 1. Иерархия Ключей (Key Hierarchy)

Система базируется на трехуровневой архитектуре `Root-of-Trust`, минимизирующей поверхность атаки в облачных средах.

### 1.1 Root Key (Мастер-Ключ)
- **Алгоритм**: Ed25519
- **Локация**: Offline Cold Storage (Air-gapped HSM)
- **Назначение**: Исключительно выпуск Intermediate-ключей (Tier 2). Выпуск выполняется строго через церемонию.
- **Ротация**: 1 раз в 5 лет или при компрометации.

### 1.2 Intermediate Key (Уровень Облака)
- **Алгоритм**: Ed25519
- **Локация**: Cloud HSM (AWS KMS / HashiCorp Vault)
- **Ограничения**: Никогда не извлекается в RAM (`exportable: false`). Все подписи происходят *внутри* анклава.
- **Назначение**: Выпуск сертификатов ферментации Level F.
- **Ротация**: Раз в 90 дней (см. п. 2.1).

### 1.3 Tenant KMS (Изоляция Клиентов)
Для каждого тенанта (`companyId`) в облачном HSM создается независимый Encryption Context для защиты локальных PII (если применимо). Данный документ фокусируется именно на подписи *сертификатов*, которые делаются общим (для платформы) Intermediate-ключом.

---

## 2. Расписание Ротации (Rotation Schedule)

Ключи, используемые для подписи сертификатов, ротируются по строго детерминированному графику для снижения последствий гипотетического извлечения.

### 2.1 Периодическая Временная Ротация (Time-Based)
- Устанавливается хард-лимит: `90 дней`.
- На 83-й день инициируется фоновый процесс генерации нового ключа в HSM (Pre-computation).
- Переключение (Active → Primary) происходит ровно в 00:00:00 UTC на 90-й день.
- Старый ключ переводится в состояние `Suspended` (он может проверять старые подписи, но не может создавать новые) на срок 365 дней (срок жизни сертификата), после чего уничтожается (`Destroyed`).

### 2.2 Кворумная Ротация (Emergency / M-of-N Governance)
В случае подозрений на компрометацию (аномалии подписей) активируется Emergency Ротация.
- Требуется `5-of-7` подписей Security-администраторов (через Smart-contract или Multisig Vault Approle).
- При сборе кворума текущий `Intermediate Key` немедленно `Revoked`.
- Выпускается новый ключ из холодного `Root Key` (процесс занимает до 24ч, в течение которых выпуск сертификатов находится в состоянии `HALT`).

---

## 3. Модель Отзыва (Revocation Model) и CRL

Поскольку сертификаты — это автономные JWT-документы (TTL=365 дней), необходим локальный инструмент проверки статуса перед акцептом сертификата в инфраструктуре.

### 3.1 Выпуск CRL (Certificate Revocation List)
- Система генерирует статический `CRL.json` каждый час.
- Для быстрого доступа на шлюзе и в движках проверки используется `Redis Bloom Filter` (probability of false positive = $10^{-6}$).
- При попадании в CRL (Bloom Filter -> Positive) система обязана проверить по базе (или S3).

### 3.2 Key Versioning (Версионирование Ключей)
Каждый JWT-сертификат Level F включает заголовок `kid` (Key ID), явно указывающий, какой Intermediate-ключ был использован:
```json
{
  "alg": "EdDSA",
  "typ": "JWT",
  "kid": "v4_f_cert_intermediate_2026_q3"
}
```

Модель верификатора обязана проверять статус конкретного `kid`. Если `kid` находится в реестре отозванных ключей (compromised), **ВСЕ** сертификаты, подписанные им, считаются отозванными автоматически.

---

## 4. Неизменяемый Аудит Подписаний (Immutable Audit Trail)

Движок подписи (Certification Engine) не имеет права напрямую обращаться к HSM без записи в Audit-лог.

### 4.1 Журналирование (Logging Event)
Перед отправкой payload в HSM, система записывает `SIGNATURE_INTENT` в PostgreSQL. При получении успешного ответа фиксируется событие `SIGNATURE_COMPLETED`.

**Структура события:**
- `eventId`: UUID
- `timestamp`: UTC (ISO 8601)
- `initiator_process`: "F_Rating_Engine_v1.2"
- `snapshot_hash`: (хэш снимка данных Level E, на основе которого собирался payload. Обязателен).
- `kid_used`: (ID ключа HSM)
- `quorum_receipt`: (если подпись инициировалась Governance-переопределением, ссылка на Multisig-tx).

### 4.2 Append-Only
Схема хранения аудита является Append-Only. Любая попытка выполнить `UPDATE` или `DELETE` в таблице `level_f_cert_audit` блокируется на уровне триггеров БД (`RAISE EXCEPTION`).

---

## 5. Threat Model для HSM & Root-of-Trust

### 5.1 Single-Cloud Dependency Risk (Снижение рисков вендор-лока)
Риск: AWS(KMS) / GCP / Azure отзывают доступ, или их инфраструктура скомпрометирована.
**Решение:** 
- Root-of-Trust хранится локально на физических YubiKey HSM (распределенных в 3 банковских ячейках разных континентов).
- В случае компрометации облака, Root-ключ способен породить новый Intermediate для другого облака.

### 5.2 Квантовая угроза (Shor's Algorithm - Post-quantum)
- Текущий алгоритм: `Ed25519`
- Action Plan (Roadmap 2028+): Гибридные сертификаты `Ed25519 + CRYSTALS-Dilithium`. Архитектура JWT спроектирована под расширение массива подписей.
