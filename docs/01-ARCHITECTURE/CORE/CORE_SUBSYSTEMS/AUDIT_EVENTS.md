# Subsystem: Audit & Events üõ°Ô∏è

> **–°—Ç–∞—Ç—É—Å:** –ö–∞–Ω–æ–Ω | **–í–µ—Ä—Å–∏—è:** 1.0 | **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** Business Core

---

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ –ê—É–¥–∏—Ç–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç 100% –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∫—Ç–æ —É–¥–∞–ª–∏–ª –ø–æ–ª–µ?) –∏ –¥–ª—è –∞–≥—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (–∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –∑–∞–¥–∞—á–∞?).

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ "–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ê—É–¥–∏—Ç–∞"

–í RAI EP —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:

1. **Memory Buffer**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ –∫–æ–¥–µ.
2. **Primary Storage**: –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `AuditLog` (PostgreSQL) –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
3. **Emergency Storage**: –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–ø–∞–ª–∞, —Å–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `AuditFailure` –∏–ª–∏ Redis Buffer.
4. **Retry Logic**: –°–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è "–ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö" —Å–æ–±—ã—Ç–∏–π.

---

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏—è (Event Schema)

```typescript
interface AuditEvent {
  id: string;          // UUID
  timestamp: Date;     // –ö–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–æ—à–ª–æ
  userId: string;      // –ö—Ç–æ —Å–¥–µ–ª–∞–ª
  companyId: string;   // –í —Ä–∞–º–∫–∞—Ö –∫–∞–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
  action: string;      // –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (CREATED, UPDATED, DELETED, COMPLETED)
  entityType: string;  // –ö —á–µ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è (Season, Field, Task)
  entityId: string;    // ID –æ–±—ä–µ–∫—Ç–∞
  payload: Json;       // –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–¥–∏—Ñ—Ñ –∏–ª–∏ —Å–Ω–∞–ø—à–æ—Ç)
  metadata: Json;      // –ö–æ–Ω—Ç–µ–∫—Å—Ç (IP, –±—Ä–∞—É–∑–µ—Ä, –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞)
}
```

---

## 4. –ö–ª—é—á–µ–≤—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π

- **SECURITY.LOGIN**: –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É.
- **AGRO.SEASON_CLOSED**: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–∑–æ–Ω–∞ (—Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è —Å–Ω–∞–ø—à–æ—Ç–∞).
- **AGRO.FIELD_GEOMETRY_CHANGED**: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –ø–æ–ª—è (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–ª–æ—â–∞–¥–µ–π).
- **CORE.ACCESS_DENIED**: –ü–æ–ø—ã—Ç–∫–∞ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (403).

---

## 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
–ê—É–¥–∏—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è "—Ä–∞–∑–±–æ—Ä–æ–∫", –Ω–æ –∏ –¥–ª—è:
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞.
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –û–±—É—á–µ–Ω–∏—è –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ "–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –¥–µ–π—Å—Ç–≤–∏–π –∞–≥—Ä–æ–Ω–æ–º–æ–≤.
