---
id: decision-adr-005
type: decision
status: approved
owners: [architects, security-officers]
aligned_with: [principle-axioms]
---

# ADR 005: Аутентификация и авторизация — JWT + Multi-tenancy

## Статус
**Принято** | **Версия:** 1.0 | **Дата:** 2026.02.02

## Контекст
Нужно обеспечить безопасность данных в системе, где множество компаний работают в одном облаке.

## Решение
**JWT Auth + Strict Multi-tenancy Isolation**

1. **Аутентификация**: 
   - Используем Passport.js + JWT.
   - Токен выдается после проверки пароля (Identity Service).
   - Для Телеграм-бота — валидация `hash` от платформы.
2. **Авторизация**:
   - Ролевая модель (RBAC): Admin, Manager, Agronomist.
   - **Isolation**: Каждый запрос содержит `companyId`. Сервисы ОБЯЗАНЫ фильтровать данные по этому полю.
3. **Multi-tenancy на уровне БД**:
   - Все таблицы имеют поле `companyId` (или привязаны через цепочку к Company).
   - Индексы включают `companyId` для производительности и безопасности.

## Обоснование
1. **Безопасность**: Утечка данных между компаниями — самый дорогой риск.
2. **Простота**: JWT позволяет сервисам быть stateless.
3. **Масштабируемость**: Эту схему легко перенести на разные БД в будущем (Gamma).

## Последствия
- Разработчики обязаны всегда проверять `companyId` (используем Guards и Base Service).
- Удобная работа с пользователями-совместителями (один User может иметь Profile в разных Company).
