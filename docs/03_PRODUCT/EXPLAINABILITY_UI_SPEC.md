# EXPLAINABILITY_UI_SPEC.md

## 0. Статус документа

- **Система:** RAI_Enterprise_Platform
- **Компонент:** Explainability UI (Level B)
- **Статус:** FORMAL SPECIFICATION
- **Зависимости:** INVARIANT_EXTENSION_FOR_LEVEL_B.md, GENERATIVE_ENGINE_SPEC.md
- **Document Maturity Level:** D3 (Verification-Ready)

---

## 1. Назначение (Purpose)

Данный документ ДОЛЖЕН определить формальную спецификацию пользовательского интерфейса для отображения объяснимости генеративных решений и прогнозов в рамках Level B платформы RAI Enterprise Platform. UI ДОЛЖЕН обеспечивать прозрачность AI-решений.

Спецификация ДОЛЖНА обеспечить:
- Обязательную объяснимость (I24)
- Раскрытие ограничений модели
- Визуализацию факторов влияния
- Прослеживаемость провенанса (I16)

---

## 2. Область применения (Scope)

### 2.1 Входит в область

- Формальные требования к UI объяснимости
- Обязательные элементы интерфейса для `ExplainabilityRecord`
- Требования к визуализации факторов влияния
- Требования к раскрытию ограничений (I24)
- Контракты отображения для генеративных черновиков и прогнозов
- Правила видимости объяснений

### 2.2 Не входит в область (см. Раздел 10)

- Визуальный дизайн (цвета, шрифты, графики)
- Анимации и переходы
- Адаптивная вёрстка
- Производительность рендеринга
- Технологический стек
- Библиотеки визуализации
- Accessibility
- Экспорт объяснений

---

## 3. Формальные определения (Formal Definitions)

### 3.1 Обязательные элементы UI

```
ExplainabilityUI := {
  factorsVisualization: FactorsChart,
  rationalePanel: RationalePanel,
  limitationsPanel: LimitationsPanel,
  provenancePanel: ProvenancePanel,
  confidenceIndicator: ConfidenceIndicator
}
```

### 3.2 FactorsChart (I24)

```
FactorsChart MUST display:
  ∀ factor ∈ primaryFactors:
    - factor.name: String (метка)
    - factor.impact: ℝ ∈ [-1.0, 1.0] (визуальная шкала)
    - factor.confidence: ℝ ∈ [0.0, 1.0] (визуальный индикатор)

Визуализация:
  - Горизонтальная шкала от -1.0 (негативное влияние) до +1.0 (позитивное)
  - Цветовое кодирование: негативное (красный), нейтральное (серый), позитивное (зелёный)
  - Толщина/прозрачность пропорциональна confidence
```

### 3.3 RationalePanel (I24)

```
RationalePanel MUST display:
  - modelRationale: String (текстовое объяснение)
  - confidenceJustification: String (обоснование уровня доверия)

Требования:
  - Текст ДОЛЖЕН быть читаемым (не технический жаргон)
  - Длина НЕ ДОЛЖНА превышать 500 символов
  - Формат: простые предложения, маркированные списки
```

### 3.4 LimitationsPanel (I24)

```
LimitationsPanel MUST display:
  - limitationsDisclosed: Boolean (MUST be true)
  - limitations: String[] (список ограничений модели)

Требования:
  - Панель ДОЛЖНА быть видима ДО утверждения пользователем
  - Ограничения ДОЛЖНЫ быть явно перечислены
  - Минимум 1 ограничение ДОЛЖНО быть указано
```

### 3.5 ProvenancePanel (I16)

```
ProvenancePanel MUST display:
  - modelId: String
  - modelVersion: String
  - generatedAt: ISO8601
  - inputDataHash: SHA256 (первые 8 символов)
```

### 3.6 ConfidenceIndicator

```
ConfidenceIndicator MUST display:
  - overallConfidence: ℝ ∈ [0.0, 1.0]
  - visualRepresentation: ProgressBar | Gauge

Цветовое кодирование:
  - [0.0, 0.5): Красный (низкая уверенность)
  - [0.5, 0.8): Жёлтый (средняя уверенность)
  - [0.8, 1.0]: Зелёный (высокая уверенность)
```

---

## 4. Маппинг инвариантов (Invariant Mapping) — только I15–I28

### 4.1 Покрываемые инварианты

**I24: Обязательная объяснимость**
- **Требование:** Каждый генеративный черновик и прогноз ДОЛЖЕН отображать объяснение.
- **Механизм UI:** `ExplainabilityUI` ДОЛЖЕН быть видим для всех сущностей с `explainability` полем. Скрытие панели ЗАПРЕЩЕНО.
- **Trace:** [TRACE-LB-PRODUCT-101]

**I16: Провенанс генерации** (частично)
- **Требование:** Метаданные модели ДОЛЖНЫ быть видимы пользователю.
- **Механизм UI:** `ProvenancePanel` ДОЛЖЕН отображать `modelId`, `modelVersion`, `generatedAt`.
- **Trace:** [TRACE-LB-PRODUCT-102]

### 4.2 Непокрываемые инварианты

I15, I17, I18, I19, I20, I21, I22, I23, I25, I26, I27, I28 НЕ применимы к данному компоненту UI.

---

## 5. Выравнивание FSM (FSM Alignment)

### 5.1 Отображение объяснимости по состояниям

UI объяснимости ДОЛЖЕН отображаться для следующих сущностей:

```
GENERATED_DRAFT:
  - ExplainabilityUI ДОЛЖЕН быть видим ПЕРЕД утверждением
  - LimitationsPanel ДОЛЖЕН быть явно показан

YieldForecast:
  - ExplainabilityUI ДОЛЖЕН быть доступен по запросу
  - FactorsChart ДОЛЖЕН показывать факторы влияния на урожайность

SimulationRun:
  - ExplainabilityUI МОЖЕТ быть доступен опционально
```

### 5.2 Связь с FSM TechMap

```
Объяснимость НЕ ДОЛЖНА:
  - Изменять состояние TechMap
  - Инициировать переходы FSM
  - Блокировать пользовательские действия

Объяснимость ДОЛЖНА:
  - Быть видимой в режиме только для чтения
  - Обновляться при изменении данных
```

**Trace:** [TRACE-LB-PRODUCT-103]

---

## 6. Ограничения детерминизма (Determinism Constraints)

### 6.1 DC-1: Обязательная видимость ограничений

**Ограничение:**
```
∀ сущности e с explainability:
  UI ДОЛЖЕН отображать LimitationsPanel
  
∀ LimitationsPanel:
  limitationsDisclosed MUST = true
  limitations.length MUST ≥ 1
```

**Механизм:** Панель ограничений НЕ МОЖЕТ быть скрыта или свёрнута по умолчанию.

**Trace:** [TRACE-LB-PRODUCT-104]

### 6.2 DC-2: Видимость факторов влияния

**Ограничение:**
```
∀ factor ∈ primaryFactors:
  FactorsChart ДОЛЖЕН визуализировать:
    - factor.impact (обязательно)
    - factor.confidence (обязательно)
    - factor.name (обязательно)
```

**Механизм:** Все факторы ДОЛЖНЫ быть видимы одновременно (без пагинации для первых N факторов).

**Trace:** [TRACE-LB-PRODUCT-105]

### 6.3 DC-3: Читаемость объяснений

**Ограничение:**
```
∀ текстового объяснения text:
  length(text) SHOULD ≤ 500 символов
  readabilityScore(text) SHOULD ≥ 60 (Flesch Reading Ease)
```

**Механизм:** Объяснения ДОЛЖНЫ быть написаны простым языком, без технического жаргона.

**Trace:** [TRACE-LB-PRODUCT-106]

---

## 7. Стратегия верификации (Verification Strategy)

### 7.1 Структурные тесты (L3)

**Тест:** Проверка наличия обязательных элементов UI
```
Дано: UI объяснимости для сущности e
Когда: render(ui, e)
Тогда: ui.contains(FactorsChart)
      AND ui.contains(RationalePanel)
      AND ui.contains(LimitationsPanel)
      AND ui.contains(ProvenancePanel)
      AND ui.contains(ConfidenceIndicator)
```
**Trace:** [TRACE-LB-TEST-401]

### 7.2 Тесты формальных инвариантов (L4)

**Тест I24-01:** Обязательная видимость объяснимости
```
Дано: GENERATED_DRAFT d с explainability
Когда: render(ui, d)
Тогда: ui.ExplainabilityUI.visible = true
      AND ui.LimitationsPanel.visible = true
      AND ui.explainability.limitationsDisclosed = true
```
**Trace:** [TRACE-LB-TEST-402]

**Тест I24-02:** Наличие ограничений
```
Дано: сущность e с explainability
Когда: render(ui, e)
Тогда: ui.LimitationsPanel.limitations.length ≥ 1
```
**Trace:** [TRACE-LB-TEST-403]

**Тест I16-01:** Видимость провенанса
```
Дано: сущность e с generationMetadata
Когда: render(ui, e)
Тогда: ui.ProvenancePanel отображает modelId, modelVersion, generatedAt
```
**Trace:** [TRACE-LB-TEST-404]

### 7.3 Тесты на основе свойств (L5)

**Свойство PBT-01:** Все факторы визуализированы
```
Свойство: ∀ сущности e с primaryFactors:
  ∀ factor ∈ e.primaryFactors:
    FactorsChart визуализирует factor
Trace: [TRACE-LB-TEST-405]
```

---

## 8. Критерии приёмки (Acceptance Criteria) — бинарные

### 8.1 Обязательные критерии

| ID | Критерий | Статус |
|----|----------|--------|
| AC-01 | I24: Объяснимость видима | ✓ ОПРЕДЕЛЁН |
| AC-02 | Ограничения раскрыты | ✓ ОПРЕДЕЛЁН |
| AC-03 | Факторы визуализированы | ✓ ОПРЕДЕЛЁН |
| AC-04 | I16: Провенанс видим | ✓ ОПРЕДЕЛЁН |
| AC-05 | Индикатор уверенности отображается | ✓ ОПРЕДЕЛЁН |
| AC-06 | Все обязательные элементы UI присутствуют | ✓ ОПРЕДЕЛЁН |

### 8.2 Верификационные ворота

**Ворота G1:** Все тесты L4 (TRACE-LB-TEST-401 — TRACE-LB-TEST-404) ДОЛЖНЫ пройти.

**Ворота G2:** Тест PBT-01 ДОЛЖЕН пройти для всех сущностей с объяснимостью.

**Ворота G3:** Ручная проверка читаемости объяснений (readability score ≥ 60).

---

## 9. Матрица прослеживаемости (Traceability Matrix)

| Trace ID | Тип | Требование | Метод верификации | Статус |
|----------|-----|------------|-------------------|--------|
| TRACE-LB-PRODUCT-101 | Инвариант | I24: Обязательная объяснимость | L4 Тест I24-01, I24-02 | ОПРЕДЕЛЁН |
| TRACE-LB-PRODUCT-102 | Инвариант | I16: Видимость провенанса | L4 Тест I16-01 | ОПРЕДЕЛЁН |
| TRACE-LB-PRODUCT-103 | FSM | Нет влияния на FSM | Структурный тест | ОПРЕДЕЛЁН |
| TRACE-LB-PRODUCT-104 | Ограничение | DC-1: Видимость ограничений | L4 Тест I24-02 | ОПРЕДЕЛЁН |
| TRACE-LB-PRODUCT-105 | Ограничение | DC-2: Видимость факторов | PBT-01 | ОПРЕДЕЛЁН |
| TRACE-LB-PRODUCT-106 | Ограничение | DC-3: Читаемость | Ручная проверка | ОПРЕДЕЛЁН |
| TRACE-LB-TEST-401 | Тест | Наличие элементов UI | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-402 | Тест | I24-01: Видимость | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-403 | Тест | I24-02: Наличие ограничений | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-404 | Тест | I16-01: Провенанс | Автоматизированный | В ОЖИДАНИИ |
| TRACE-LB-TEST-405 | Тест | PBT-01: Все факторы | Property-Based | В ОЖИДАНИИ |

---

## 10. Вне области применения (Out of Scope)

Следующее ЯВНО ИСКЛЮЧЕНО из области данной спецификации:

1. **Визуальный дизайн:** Цветовая схема, типографика, стили графиков
2. **Библиотеки визуализации:** Выбор D3.js, Chart.js, Recharts и т.д.
3. **Анимации:** Переходы графиков, эффекты появления
4. **Адаптивность:** Мобильная вёрстка, различные разрешения
5. **Производительность:** Оптимизация рендеринга больших наборов факторов
6. **Технологии:** Выбор фреймворка, библиотек компонентов
7. **Accessibility:** WCAG-соответствие, screen readers
8. **Экспорт:** Экспорт объяснений в PDF, CSV, JSON

Эти вопросы ДОЛЖНЫ быть рассмотрены в отдельных UI/UX и продуктовых спецификациях.

---

## Document Maturity Level: D3 (Verification-Ready)

**Обоснование:**
- ✓ Структурно завершён (D1)
- ✓ Выровнен с инвариантами (D2): I24, I16 явно замаплены
- ✓ Готов к верификации (D3): Все стратегии тестирования определены с trace ID
- ✗ Утверждён для реализации (D4): Требуется UI/UX дизайн и план реализации

**Следующие шаги:**
1. Создать UI/UX дизайн визуализации факторов и объяснений
2. Выбрать библиотеку визуализации
3. Реализовать тесты L4 и L5
4. Провести ручную проверку читаемости объяснений
5. Получить утверждение стейкхолдеров для повышения до D4
