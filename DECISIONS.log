# DECISIONS LOG

> **Назначение:** Регистр архитектурных и процессных решений проекта.  
> **Формат:** Decision-ID | Дата | Решение | Статус | Автор

---

## SPRINT4-WEB-001

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 16:58  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Создание веб-интерфейса для RAI Enterprise Platform на базе Next.js 14 с JWT-аутентификацией.

### Scope
- **Phase:** Alpha
- **Sprint:** 4 (05.08 - 19.08)
- **Компоненты:**
  - Next.js 14 App Router
  - JWT-аутентификация через HttpOnly cookies
  - **Dashboard с метриками (НОВЫЙ)** — создаём в `apps/web/src/app/dashboard/page.tsx`
  - Форма создания задачи
  - UI Kit (Button, Card, Input)

### Dashboard Scope Resolution
**Решение USER (2026-02-03 16:58):**  
Создаём **новый Dashboard** в `apps/web`. Галочка в SCOPE.md была ошибочной или относилась к другому компоненту.

### Технические ограничения
1. **Auth:**
   - JWT хранится в HttpOnly cookies
   - Auth работает через Next.js Server Actions / Route Handlers
   - Axios используется ТОЛЬКО для client-side API calls
   - Middleware работает на Edge Runtime (ограничения Node.js API)

2. **UI:**
   - Соответствие UI_DESIGN_CANON.md v0.1
   - Шрифт: Geist
   - Заголовки: font-medium (НЕ bold)
   - Светлая тема

3. **Language:**
   - Все тексты интерфейса: СТРОГО НА РУССКОМ
   - Английский только для: файлов, переменных, API endpoints

4. **Multi-tenancy:**
   - Все API запросы включают companyId через JWT payload

### Definition of Done
Sprint 4 считается завершённым, если:
- [x] Login → Dashboard → Create Task работает end-to-end
- [x] UI Canon соблюдён (проверка font-weight в DevTools)
- [x] Нет нарушений Language Policy (все тексты на русском)
- [x] JWT корректно сохраняется в HttpOnly cookies
- [x] Сессия сохраняется после перезагрузки страницы
- [x] Build проходит без ошибок (`pnpm build`)
- [x] Lint проходит без warnings (`pnpm lint`)

### Rollback Conditions
Спринт останавливается, если:
- API endpoints не готовы (отсутствуют `/auth/login`, `/users/me`, `/tasks`, `/fields`)
- JWT токены не стабильны (ошибки 401/403)
- Next.js 14 несовместим с текущей инфраструктурой

**Действия при rollback:**
1. Остановка работы
2. Фиксация проблемы в DECISIONS.log
3. Запрос уточнения у USER
4. Возврат к PLANNING mode

### Связанные документы
- `docs/06-IMPLEMENTATION/PHASE_ALPHA/SCOPE.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/UI_DESIGN_CANON.md`
- `implementation_plan.md`
- `task.md`

### Зависимости
- Существующий API (`apps/api`)
- Identity Service (JWT выдача)
- PostgreSQL (для данных)

### Риски
1. **Dashboard scope неясен** — требуется уточнение: новый или обновление существующего
2. **SSR + JWT** — возможны проблемы с Edge Runtime
3. **Browser testing** — не определено: делать или нет

---

## UI-CANON-001

**Дата:** 2026-02-03  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Создание UI_DESIGN_CANON.md v0.1 как обязательного нормативного документа для всех UI-задач.

### Ключевые требования
1. Шрифт: Geist
2. Заголовки: font-medium (weight: 500)
3. Основной текст: font-normal (weight: 400)
4. **ЗАПРЕЩЕНО:** font-bold, font-semibold
5. Светлая тема
6. Карточки: bg-white, border-black/10, rounded-2xl
7. Кнопки: rounded-2xl, font-medium
8. Inputs: rounded-lg, border-black/10

### Обоснование
- Отсутствие UI_DESIGN_CANON.md создавало архитектурную дыру
- ORCHESTRATOR PROMPT не является документом архитектуры
- Необходим единый источник истины для UI-решений

### Связанные документы
- `CANON.md`
- `ARCHITECTURAL_AXIOMS.md`
- `ANTIGRAVITY SOFTWARE FACTORY — ORCHESTRATOR PROMPT.md`

---

## GAMMA-SPRINT3-001

**Дата:** 2026-02-08  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Запустить Sprint 3 (Phase Gamma) с первым инкрементом: `Episodic Retrieval` и теневой контур advisory без пользовательского воздействия.

### Scope
- **Phase:** Gamma
- **Sprint:** 3
- **Компоненты:**
  - `apps/api/src/shared/memory/*`
  - `@rai/vector-store`
  - проектные чек-листы Gamma

### Технические ограничения
1. **Human-in-the-loop:** никаких автоматических действий на пользователя.
2. **Shadow-only:** retrieval и ранжирование работают в фоне, без UI/контроллеров.
3. **Multi-tenancy:** все обращения только через `companyId`.
4. **Architecture:** `Service = IO`, оркестрация и бизнес-решения не переносить в infra слой.
5. **Traceability:** каждый retrieval поддерживает `traceId`.

### Definition of Done
- [x] Реализован `EpisodicRetrievalService` с retrieval из `MemoryManager`.
- [x] Есть unit-тесты retrieval-сервиса (минимум 2 сценария).
- [x] Обновлены чек-листы Sprint 3 и документы планирования.
- [x] Нет изменений, которые публикуют рекомендации в продуктовый интерфейс.

### Rollback Conditions
Спринт останавливается, если:
- нарушена изоляция по `companyId`;
- retrieval приводит к пользовательским side effects;
- появляется обход Admission/Integrity принципов.

### Связанные документы
- `docs/06-IMPLEMENTATION/PHASE_GAMMA/SPRINT_3_CHECKLIST.md`
- `docs/06-IMPLEMENTATION/PHASE_GAMMA/EXECUTION_PLAN.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/ARCHITECTURAL_AXIOMS.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/FORBIDDEN.md`

### Зависимости
- `MemoryManager`
- `@rai/vector-store`
- `memory_entries` (pgvector)

### Риски
1. Низкое качество metadata для `POSITIVE/NEGATIVE` разметки.
2. Потенциальная деградация latency при большом объёме retrieval.
3. Drift в эмбеддингах без централизованной валидации.

---

## SECURITY-CANON-001

**Дата:** 2026-02-08  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Зафиксировать обязательный документ `SECURITY_CANON.md` как нормативный слой для security-check перед реализацией.

### Scope
- `docs/01-ARCHITECTURE/PRINCIPLES/SECURITY_CANON.md`
- процессы проверки TECHLEAD перед стартом задач

### Технические ограничения
1. Обязательная проверка tenant-изоляции (`companyId`).
2. Обязательная проверка audit trail для high-impact потоков.
3. Запрет обхода Admission/Integrity gate.
4. Запрет хранения секретов в коде/документах.

### Definition of Done
- [x] Создан `SECURITY_CANON.md` в слое `PRINCIPLES`.
- [x] Документ согласован с `CANON.md` и `ARCHITECTURAL_AXIOMS.md`.
- [x] Обновлены проектные чек-листы Sprint 3 и memory-bank.

### Связанные документы
- `docs/01-ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/ARCHITECTURAL_AXIOMS.md`
- `docs/ANTIGRAVITY SOFTWARE FACTORY — ORCHESTRATOR PROMPT.md`

---

## Формат записи

Каждое новое решение должно содержать:

```
## DECISION-ID

**Дата:** YYYY-MM-DD
**Автор:** ROLE (USER/TECHLEAD/CODER)
**Статус:** PENDING / ACCEPTED / REJECTED / DEPRECATED

### Решение
[Краткое описание решения]

### Scope
[Охват: Phase, Sprint, Компоненты]

### Технические ограничения
[Ключевые constraints]

### Definition of Done
[Критерии завершения]

### Rollback Conditions
[Условия отката]

### Связанные документы
[Ссылки на документы]

### Зависимости
[Внешние зависимости]

### Риски
[Известные риски]
```

---

## Правила работы с DECISIONS.log

1. **Обязательность:** Ни одна задача не принимается в работу без Decision-ID
2. **Фиксация:** Решение фиксируется ДО начала реализации
3. **Статусы:**
   - `PENDING` — ожидает утверждения USER
   - `ACCEPTED` — утверждено, можно реализовывать
   - `REJECTED` — отклонено
   - `DEPRECATED` — устарело, заменено новым решением
4. **Изменение:** Решение можно изменить только через новый Decision-ID
5. **Трассируемость:** Все изменения должны ссылаться на Decision-ID

---

## История изменений

### 2026-02-03
- Создан DECISIONS.log
- Добавлен SPRINT4-WEB-001 (PENDING)
- Добавлен UI-CANON-001 (ACCEPTED)
- Добавлены ARCH-DEBT-001, 002, 003 (Architecture Audit Sprint 4)

---

# ============================================================
# ARCHITECTURE DEBT (Sprint 4 Audit)
# ============================================================

## ARCH-DEBT-001

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 18:50  
**Автор:** Chief System Architect (AI)  
**Статус:** RESOLVED (Sprint 5a COMPLETE)
**Приоритет:** CRITICAL  
**Target:** Sprint 5a

### Решение
Multi-tenancy отсутствует в Auth Module

### Контекст
Architectural Audit Sprint 4 выявил критическое отсутствие multi-tenancy:
- `companyId` в JWT всегда `null`
- Нет фильтрации данных по `companyId` в Dashboard
- Все пользователи видят данные всех компаний

### Действия
Реализовать multi-tenancy в Sprint 5a:
1. Добавить relation `User -> Company` в Prisma schema
2. Заполнять `companyId` в JWT payload из `user.company`
3. Добавить фильтрацию по `companyId` во всех API endpoints
4. Обновить Dashboard для фильтрации данных по `companyId`

### Multi-tenancy Canon (КРИТИЧНО)
**Правило безопасности:**
- `companyId` ВСЕГДА извлекается из security context (JWT payload)
- `companyId` НИКОГДА не принимается из `body`, `query`, `params`
- Веб-интерфейс НЕ ИМЕЕТ ПРАВА формировать `companyId`

### Обоснование
Без multi-tenancy система непригодна для production.  
Это блокер для пилотного внедрения.

### Связанные документы
- `ARCH_AUDIT_SPRINT_4.md` (Section 2, 3)
- `implementation_plan.md` (Sprint 5a)

---

## ARCH-DEBT-002

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 18:50  
**Автор:** Chief System Architect (AI)  
**Статус:** RESOLVED (Sprint 5a COMPLETE)
**Приоритет:** HIGH  
**Target:** Sprint 5a

### Решение
Auth Repository отсутствует (Infrastructure Leak)

### Контекст
Auth Service напрямую использует `PrismaService` (infrastructure leak).  
Нет абстракции между Auth Service и БД.  
Это технический долг, усложняющий миграцию и тестирование.

### Действия
Создать UserRepository (Repository pattern):
1. Создать interface `IUserRepository`
2. Создать `UserRepository` с методами: `findByEmail`, `findById`
3. Инжектировать `UserRepository` в Auth Service
4. Убрать прямую зависимость от `PrismaService`

### Обоснование
Repository pattern обеспечивает:
- Абстракцию от конкретной БД
- Упрощение тестирования (mock repository)
- Возможность добавления кэша без изменения Auth Service

### Связанные документы
- `ARCH_AUDIT_SPRINT_4.md` (Section 2, 3)
- `implementation_plan.md` (Sprint 5a)

---

## ARCH-DEBT-003

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 18:50  
**Автор:** Chief System Architect (AI)  
**Статус:** DEFERRED (Sprint 6)  
**Приоритет:** MEDIUM  
**Target:** Sprint 6

### Решение
Web Orchestrator не реализован

### Контекст
Веб-интерфейс работает напрямую с API (fetch → render).  
Нет централизованной логики для сложных flow.  
Риск размазывания логики по компонентам при росте системы.

### Действия
Создать WebOrchestrator для управления веб-flow (API-layer, НЕ frontend):
1. Создать `WebOrchestrator` service в NestJS API
2. Переместить сложные сценарии из компонентов в Orchestrator
3. Использовать для multi-step forms, wizards, complex validations

**Важно:** WebOrchestrator — это API-layer (NestJS service), НЕ frontend.
Веб-интерфейс (Next.js) не имеет права содержать бизнес-логику или orchestration.

Альтернатива: использовать существующий `AgroOrchestrator`

### Обоснование
Orchestrator = Brain (канон RAI_EP).  
Централизация логики предотвращает деградацию архитектуры.  
Упрощает тестирование и поддержку.

### Связанные документы
- `ARCH_AUDIT_SPRINT_4.md` (Section 2, 3, 5)
- `implementation_plan.md` (Sprint 5a, DEFERRED)

## TRACK5-001

**Дата:** 2026-02-12
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED

### Решение
Реализация Track 5 — Yield & KPI Engine. Слой измерения производственной и финансовой эффективности на основе данных о сборе урожая. Добавление модели `HarvestResult` и сервисов расчета финансового результата (ROI, себестоимость).

### Scope
- **Phase:** Gamma
- **Sprint:** 7 (extension)
- **Компоненты:**
  - Prisma Schema (`HarvestResult`)
  - NestJS Services (`YieldService`, `KPIService`)
  - Next.js UI (`yield/page.tsx`, `plans/page.tsx` update)

### Технические ограничения
1. **Multi-tenancy:** Все данные `HarvestResult` и расчеты KPI строго изолированы по `companyId` из JWT.
2. **Audit:** Любые мутации `HarvestResult` логируются событием `HARVEST_RESULT_RECORDED`.
3. **UI Canon:** Шрифт Geist, веса 400/500, белый фон, `border-black/10`, `rounded-2xl`.
4. **Language:** Полная локализация интерфейса на русский язык.
5. **Decoupling:** `KPIService` использует `BudgetPlan` и `HarvestResult`, не обращаясь к `ExecutionService` напрямую.

### Definition of Done
- [x] Модель `HarvestResult` создана в БД.
- [x] `YieldService` обеспечивает CRUD сбор урожая (базовая логика).
- [x] `YieldService` интегрирован с `AuditService` (событие `HARVEST_RESULT_RECORDED`).
- [x] `KPIService` выполняет детерминированный расчет ROI и других KPI.
- [x] В Plan Cockpit добавлен блок Yield & KPI (интеграция в `plans/page.tsx`).
- [x] Проведены тесты расчетов и изоляции данных.

### Rollback Conditions
- Обнаружение возможности кросс-тенантного доступа к данным.
- Критические ошибки в формулах расчета финансовой эффективности.
- Нарушение отзывчивости интерфейса при расчете KPI.

### Связанные документы
- `docs/01-ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/UI_DESIGN_CANON.md`
- `f:\RAI_EP\Рабочая\implementation_plan.md`

---

## PHASE0-CORE-001

**Дата:** 2026-02-15
**Автор:** TECHLEAD (AI)
**Статус:** APPROVED
**Scope:** Global
**Binding:** HARD
**Enforcement:** Code + Audit

### Решение
Фиксация архитектурных инвариантов ("Laws of Physics") для ядра системы.

### Scope
- **Budget Integrity**: `techMapId` (NOT NULL), `version`, `hash`. Запрет ручного создания.
- **Execution Integrity**: Ссылка на `planId`, `plannedOperationId`. Запрет ad-hoc операций.
- **Ledger Immutability**: Append-only. Запрет UPDATE/DELETE. Corrections via reversal.
- **KPI Calculation**: Derived only. Запрет хранения в транзакционных таблицах.
- **Tenant Isolation**: `companyId` обязателен. Cross-tenant joins запрещены.
- **Versioning**: Запрет мутаций активных версий TechMap/Plan.

### Definition of Done
- Правила отражены в `PHASE 0 — ФИКСАЦИЯ ЯДРА СИСТЕМЫ.md`.
- Проведен аудит кода на соответствие (Gap Analysis).
- Все новые разработки следуют этим правилам (блокировка на уровне Code Review).

### Rollback Conditions
- Невозможность реализации технически (например, ограничения БД).
- Блокировка бизнес-процессов (выявляется на этапе аудита).

### Связанные документы
- `docs/01-ARCHITECTURE/PHASE 0 — ФИКСАЦИЯ ЯДРА СИСТЕМЫ.md`
- `docs/01-ARCHITECTURE/Финальный стратегический план.md`

---

## LEVEL-B-GEN-001

**Дата:** 2026-02-18
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED
**Приоритет:** CRITICAL
**Target:** Level B Implementation

### Решение
Реализация Generative Engine для Level B с полным покрытием инвариантов I15-I28, детерминированной генерацией (B1), immutability constraints и property-based testing.

### Scope
- **Phase:** Level B (Formal Verification)
- **Компоненты:**
  - `/generative-engine/domain/*` (DraftFactory, DeterministicGenerator, ExplainabilityBuilder, MetadataBuilder, ConstraintPropagator, EntropyController)
  - `/generative-engine/validation/*` (IntegrityGate, DeterminismValidator, ImmutabilityGuard)
  - `/generative-engine/fsm/*` (DraftStateManager)
  - `/generative-engine/simulation/*` (ScenarioExecutor)
  - `/generative-engine/record/*` (GenerationRecordService)
  - `/generative-engine/yield/*` (YieldForecastService, DeterministicForecastEngine)
  - `/generative-engine/probability/*` (ProbabilityDistributionBuilder, NormalizationEnforcer)
  - `/generative-engine/tests/*` (L3-L6 tests, PBT tests, Adversarial tests)

### Технические ограничения
1. **Invariant-First Development:** Каждый инвариант реализуется как Domain Rule → Validation Layer → Test Coverage → PBT Coverage
2. **Determinism by Construction (B1):**
   - Побайтово детерминированная генерация: `generate(P)₀ = generate(P)ₙ`
   - Запрет `Date.now()`, `Math.random()`, non-deterministic UUID
   - Централизованный контроль энтропии через `EntropyController`
3. **Immutability as Core Constraint:**
   - `GenerationRecord` — immutable после создания
   - Published `Strategy` — immutable (триггеры БД)
   - Hash — immutable
4. **Test-Driven Flow:**
   - Написать L4 тест → Написать PBT тест → Убедиться, что тест падает → Реализовать минимальный код → Добиться зелёного → Проверить adversarial
5. **Multi-tenancy:** Все данные изолированы через `companyId`
6. **Infrastructure Isolation:** Домен не зависит от БД/Redis напрямую (Repository pattern)

### Инварианты (I15-I28)
- **I15:** Изоляция генеративных черновиков (`status = 'GENERATED_DRAFT'`, только HUMAN может утвердить)
- **I16:** Провенанс генерации (`generationMetadata.modelId`, `modelVersion`, `generatedAt`, `seed`, `hash`)
- **I17:** Верховенство человеческого переопределения (`canReject`, `canEdit`)
- **I18:** Неизменяемость библиотеки стратегий (PUBLISHED стратегии immutable)
- **I19:** Детерминированная генерация B1 (`generate(P)₀ = generate(P)ₙ`)
- **I20:** Прослеживаемость модели урожайности (`modelVersion`, `inputData`, `forecastedAt`, `hash`)
- **I21:** Распространение ограничений (`∀ c ∈ strategy.constraints: c ∈ draft.constraints`)
- **I22:** Изоляция симуляций (`isProduction = false`, нет влияния на FSM)
- **I24:** Обязательная объяснимость (`limitationsDisclosed = true`, `explainability ≠ null`)
- **I25:** Нормализация вероятности (`|∫ p(y) dy - 1.0| < 0.001`)
- **I26:** Границы вероятности (`0 ≤ p(y) ≤ 1`)
- **I27:** Доверительный интервал (`0.8 ≤ confidence ≤ 0.99`, `lower < upper`)
- **I28:** Неизменяемость записи генерации (immutable после создания)

### Definition of Done
- [x] **100% Test Matrix проходит** (67 тестов: 53 базовых + 14 adversarial)
  - [x] 7 L3 тестов (схема БД)
  - [x] 26 L4 тестов (unit)
  - [x] 11 L5 тестов (integration, 10,000 образцов)
  - [x] 9 L6 тестов (E2E)
  - [x] 14 adversarial тестов (все атаки заблокированы)
- [x] **100% Property-Based проходит** (20 базовых свойств, 10,000 образцов)
- [x] **Cross-invariant свойства замкнуты** (5 свойств: CP-1 до CP-5)
- [x] **Нет failing counterexamples** (все 10,000 образцов проходят)
- [x] **Нет bypass adversarial сценариев**
- [x] **Hash стабилен** (детерминизм подтверждён)
- [x] **Повторяемость генерации подтверждена** (`generate(P)₀ = generate(P)ₙ`)
- [x] **Все спецификации обновлены до D4**
- [x] **Walkthrough создан с доказательствами работы**
- [x] **CI/CD настроен для автоматического запуска всех тестов**

### Этапы реализации (7 этапов)
1. **ЭТАП 1:** Domain Core (I15, I16, I17, I21) — 18 тестов
2. **ЭТАП 2:** Deterministic Engine (I19) — 7 тестов + 2 CP
3. **ЭТАП 3:** Immutability Layer (I18, I28) — 9 тестов + 1 CP
4. **ЭТАП 4:** Explainability Engine (I24) — 7 тестов
5. **ЭТАП 5:** Yield Model B1 (I20) — 4 тестов + 1 CP
6. **ЭТАП 6:** Simulation Module (I22) — 5 тестов + 1 CP
7. **ЭТАП 7:** Probability Layer (B2+) (I25-I27) — 9 тестов + 1 CP

### Rollback Conditions
- Невозможность достижения побайтового детерминизма для B1
- Failing counterexamples в PBT после 10,000 образцов
- Bypass adversarial тестов (security vulnerabilities)
- Нарушение multi-tenancy (кросс-тенантный доступ)
- Нарушение immutability constraints (изменение опубликованных сущностей)

### Связанные документы
- `docs/04_ENGINEERING/GENERATIVE_ENGINE_IMPLEMENTATION_PLAN.md`
- `docs/04_ENGINEERING/GENERATIVE_ENGINE_IMPLEMENTATION_CHECKLIST.md`
- `docs/05_TESTING/LEVEL_B_FORMAL_TEST_MATRIX.md` v2.0
- `docs/05_TESTING/PROPERTY_BASED_TEST_SPEC.md` v1.1
- `docs/01_ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01_ARCHITECTURE/PRINCIPLES/ARCHITECTURAL_AXIOMS.md`
- `docs/01_ARCHITECTURE/PRINCIPLES/SECURITY_CANON.md`

### Зависимости
- Prisma Schema (для `GenerationRecord`, `Strategy`, `YieldForecast`, `SimulationRun`)
- FSM (для `DraftStateManager`)
- Integrity Gate Service (для валидации)
- Audit Service (для трассировки)

### Риски
1. **Недетерминизм:** Скрытые источники энтропии (timestamp, random) — митигация через `EntropyController`
2. **Drift FSM:** Неправильные переходы — митигация через FSM unit tests
3. **Нарушение immutable:** Прямой доступ к БД — митигация через Guard layer + триггеры БД
4. **Probability drift:** Floating point errors — митигация через tolerance enforcement (0.001)
5. **Metadata loss:** Partial object serialization — митигация через strict schema validation

---

## LEVEL-C-GEN-001

**Дата:** 2026-02-18
**Автор:** TECHLEAD (AI)
**Статус:** PENDING
**Приоритет:** CRITICAL
**Target:** Level C Implementation

### Решение
Переход на Level C (Contradiction-Resilient Intelligence). Реализация механизмов устойчивости к конфликтам между ИИ и человеком, включая расчет риска переопределения (ΔRisk), контрфактуальное моделирование и отслеживание дивергенции решений.

### Scope
- **Phase:** Level C (Contradiction Resilience)
- **Компоненты:**
  - `/generative-engine/contradiction/*` (CounterfactualEngine, ConflictMatrix, DivergenceTracker)
  - `/generative-engine/risk/*` (OverrideRiskAnalyzer, RiskMetricCalculator)
  - `/generative-engine/invariants/*` (LevelCInvariants: I29-I32)
  - `/fsm/*` (Integration of Level C guards)

### Технические ограничения
1. **ΔRisk Calculation:** Любое переопределение (Human Override) ОБЯЗАНО сопровождаться расчетом разницы рисков между рекомендацией ИИ и выбором человека.
2. **Reproducibility:** Результаты контрфактуального моделирования должны быть воспроизводимы и детерминированы (в соответствии с B1).
3. **Explainability:** Любое расхождение (disagreement) должно иметь объяснение факторов (ExplainabilityBuilder).
4. **Non-Blocking:** ИИ не может блокировать решение человека, но делает его последствия прозрачными.

### Инварианты (I29-I32)
- **I29 (Risk Awareness):** `humanOverride → ΔRisk calculation mandatory`
- **I30 (Model Reproducibility):** `counterfactual(S, A)₀ = counterfactual(S, A)ₙ`
- **I31 (Conflict Tracking):** `∀ divergence: record(divergenceMetadata)`
- **I32 (Explainable Disagreement):** `divergence.explanation ≠ null`

### Definition of Done
- [x] Реализован `CounterfactualEngine` для моделирования альтернатив.
- [x] Реализован `OverrideRiskAnalyzer` для расчета ΔRisk.
- [x] Реализован `ConflictMatrix` для визуализации расхождений.
- [x] Все инварианты I29-I32 покрыты тестами (L4, PBT).
- [x] Интеграция в основной FSM (DraftStateManager).

### Rollback Conditions
- Нарушение детерминизма в контрфактуальном моделировании.
- Неточность или недостоверность расчета ΔRisk.
- Произвольное блокирование пользовательских действий со стороны ИИ.

### Связанные документы
- `docs/00_STRATEGY/EVOLUTION_ARCHITECTURE_MASTER_A_TO_F.md`
- `docs/01_ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/04_ENGINEERING/IMPLEMENTATION_PLAN_LEVEL_C.md`

---

## LEVEL-F-HARDENING-001

**Дата:** 2026-02-20
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED
**Приоритет:** CRITICAL
**Target:** Level F (Institutional Oracle Architecture)

### Решение
Полное формальное отвердение (Hardening) 12 документов архитектуры Level F до стандарта `10/10 Enterprise Institutional Grade`. Замена маркетинговых описаний на математические инварианты, криптографические протоколы (Ed25519, HSM, Merkle DAG) и жесткие банковские стандарты (Basel III, SEC 17a-4).

### Scope
- **Phase:** Level F (Trust Layer & Oracle Standardization)
- **Компоненты:**
  - `01_ARCHITECTURE/LEVEL_F/*` (Invariants, Security, Dispute, Privacy, Governance)
  - `04_ENGINEERING/LEVEL_F/*` (Snapshotter, Rating Engine, Cert Engine, Insurance API)
  - `05_TESTING/LEVEL_F_FORMAL_TEST_SPEC.md`
  - `06_METRICS/LEVEL_F/*` (Success Metrics, Risk Monitoring)
  - `07_EXECUTION/PHASE_DELTA/*` (Roadmap, Rollout, Approval, Implementation Checklist)

### Технические ограничения
1. **Canonical State:** Все снимки сериализуются через RFC 8785 (Canonical JSON) перед хешированием.
2. **Deterministic Output:** `F_RATING_ENGINE` действует как песочница без состояния. Работа с `Math.random` отключена, строгий IEEE-754.
3. **Off-Memory Signing:** `Ed25519` подписи для выдачи сертификатов выполняются строго внутри HSM анклавов. Root keys никогда не попадают в RAM.
4. **WORM Storage:** Хранение истории снимков в Object Lock S3 бакетах на 10 лет. Разрушительные мутации запрещены на уровне доступа.
5. **Zero-Trust Network Gate:** `F_INSURANCE_API` работает только по mTLS, идемпотентно фильтрует Replays через JWT Nonce и отвечает по формату RFC 7807 (Problem Details for HTTP APIs).

### Definition of Done
- [x] Все 12 документов переписаны на `10/10 Formal Specification`.
- [x] Создан полный `LEVEL_F_IMPLEMENTATION_CHECKLIST.md` в папке EXECUTION.
- [x] Утверждены формальные метрики (Brier Score <= 0.12, Z-Score >= 3.0).
- [x] Зафиксированы регламенты M-of-N Governance для обновления протокола.
- [x] Описан Hardcore Formal Test Spec для Level F (BFT-сценарии, атаки на L1, Zip bombs).

### Rollback Conditions
- Выявление недетерминированного поведения в алгоритме Score Calculation -> Переход в `SAFE_HALT`.
- Провал консенсуса M-of-N на церемонии запуска Genesis.

### Связанные документы
- `LEVEL_F_SECURITY_MODEL.md`
- `F_RATING_ENGINE_ARCH.md`
- `LEVEL_F_IMPLEMENTATION_CHECKLIST.md`

---

## LEVEL-F-EXEC-001

**Дата:** 2026-02-20
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED
**Приоритет:** CRITICAL
**Target:** Level F (Phase 4 & 5)

### Решение
Реализация Внешнего Шлюза (Institutional API Gateway) и Инфраструктуры Споров (Dispute & Immutable Audit) для стандарта Level F.

### Scope
- **Phase:** Level F (Execution - Phase 4, Phase 5, Phase 6)
- **Компоненты (API Gateway):**
  - `mTLS Firewall` (Tier-2/Tier-3 client certificate validation)
  - `TokenBucketRateLimitingGuard` (1000 req/min/Tenant, 10000 req/min/Subnet)
  - `SLA/SLO contract layer`
- **Компоненты (Dispute / Anchoring):**
  - `Deterministic Replay API`
  - `Smart Contract Anchoring` (Solidity/Testnet)
  - `Fallback Anchor Logic` (Node-Watcher)
  - `CRL Lifecycle (Revocations)`
- **Симуляции (Hardcore Test Specs):**
  - BFT Attack Test
  - Zip Bomb Test
  - Replay Cache Test
  - Panic Halt Test

### Технические ограничения
1. **Zero-Trust Network:** mTLS Firewall должен хард-реджектить любые пакеты без x.509.
2. **Infrastructure Isolation:** Домен не зависит от БД/Redis напрямую (Repository pattern).
3. **Multi-tenancy:** Все данные строго изолированы по `companyId` из JWT. 
4. **CRM-Bloat block:** Не добавлять в шлюз логику управления пользователями (только чистый auth/rate-limiting/security).
5. **Security Canon:** Никаких секретов в коде, логика работы с HSM анклавами.

### Definition of Done
- [x] Все пункты из Фазы 4 (Внешний Шлюз) реализованы и покрыты Security-тестами.
- [x] Все пункты из Фазы 5 (Инфраструктура Споров) реализованы.
- [x] Проведены Хардкорные Симуляции из Фазы 6 (Zip bomb, Replay, BFT).
- [x] Успешное выполнение локальных тестов.

### Rollback Conditions
- Выявление дыр в mTLS Firewall (доступ возможен без сертификата).
- Падение производительности из-за Bottleneck в Token Bucket Guard.
- Пробитие Security Canon.

### Связанные документы
- `docs/07_EXECUTION/PHASE_DELTA/LEVEL_F_HANDOFF.md`
- `docs/07_EXECUTION/PHASE_DELTA/LEVEL_F_IMPLEMENTATION_CHECKLIST.md`
## INSTITUTIONAL-ROADMAP-REF-001

**Дата:** 2026-02-21
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED
**Приоритет:** HIGH
**Target:** Global Architecture Documentation

### Решение
Глубокая модернизация и профессионализация `ARCHITECTURAL ROADMAP (Institutional Build Plan).md` до стандарта Level F Institutional Grade.

### Scope
- Документация дорожной карты исполнения.
- Формализация Definition of Done для всех 7 фаз.
- Интеграция Governance Core инвариантов в визуальные и текстовые модели.

### Технические ограничения
1. **Language Policy:** Весь текст на русском языке.
2. **Standard Alignment:** Соответствие Level F Formal Documentation.
3. **Roles:** Разделение уровней Build Plan (Execution) и Architecture (Design).

### Definition of Done
- Документ обновлен до версии 1.1.0.
- Добавлены DoD чек-листы для каждой фазы с учетом security и integrity.
- Визуализация Mermaid отражает "Governance Core First".
- Все ссылки на инварианты I29-I34 корректны.

### Связанные документы
- `docs/01_ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/07_EXECUTION/ARCHITECTURAL ROADMAP (Institutional Build Plan).md`

---

## AG-AI-CHAT-001

**Дата:** 2026-03-01
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED

### Решение
Реализация канонической архитектуры RAI Chat. Переход от мок-интерфейса в Next.js на централизованный API-модуль в NestJS с поддержкой виджетов и изоляцией тенантов.

### Scope
- **Phase:** Gamma
- **Sprint:** p0.1
- **Компоненты:**
  - `apps/api/src/modules/rai-chat/`
  - `apps/web/lib/stores/ai-chat-store.ts`
  - `apps/web/app/api/ai-chat/route.ts` (legacy proxy)

### Технические ограничения
1. **Tenant Isolation:** `companyId` извлекается строго через `TenantContextService`, не принимается в payload.
2. **Determinism:** Ответы чата на текущем этапе детерминированы (echo + widget) для валидации транспорта.
3. **Security:** Эндпоинт `/api/rai/chat` защищен `JwtAuthGuard`.

### Definition of Done
- [x] API отвечает на `POST /api/rai/chat`.
- [x] Веб-чат отображает ответ бэкенда.
- [x] Виджеты (placeholder) корректно рендерятся.
- [x] Изоляция по `companyId` верифицирована.
- [x] Unit-тесты контроллера пройдены.

### Rollback Conditions
- Нарушение изоляции данных между компаниями.
- Регрессия UI чата (невозможность отправки сообщений).

### Связанные документы
- `interagency/prompts/2026-03-01_p0-1_api-rai-chat.md`
- `docs/00_STRATEGY/STAGE 2/PROJECT_EXECUTION_CHECKLIST.md`
- `memory-bank/task.md` (Item 17)
