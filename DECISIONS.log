# DECISIONS LOG

> **Назначение:** Регистр архитектурных и процессных решений проекта.  
> **Формат:** Decision-ID | Дата | Решение | Статус | Автор

---

## SPRINT4-WEB-001

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 16:58  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Создание веб-интерфейса для RAI Enterprise Platform на базе Next.js 14 с JWT-аутентификацией.

### Scope
- **Phase:** Alpha
- **Sprint:** 4 (05.08 - 19.08)
- **Компоненты:**
  - Next.js 14 App Router
  - JWT-аутентификация через HttpOnly cookies
  - **Dashboard с метриками (НОВЫЙ)** — создаём в `apps/web/src/app/dashboard/page.tsx`
  - Форма создания задачи
  - UI Kit (Button, Card, Input)

### Dashboard Scope Resolution
**Решение USER (2026-02-03 16:58):**  
Создаём **новый Dashboard** в `apps/web`. Галочка в SCOPE.md была ошибочной или относилась к другому компоненту.

### Технические ограничения
1. **Auth:**
   - JWT хранится в HttpOnly cookies
   - Auth работает через Next.js Server Actions / Route Handlers
   - Axios используется ТОЛЬКО для client-side API calls
   - Middleware работает на Edge Runtime (ограничения Node.js API)

2. **UI:**
   - Соответствие UI_DESIGN_CANON.md v0.1
   - Шрифт: Geist
   - Заголовки: font-medium (НЕ bold)
   - Светлая тема

3. **Language:**
   - Все тексты интерфейса: СТРОГО НА РУССКОМ
   - Английский только для: файлов, переменных, API endpoints

4. **Multi-tenancy:**
   - Все API запросы включают companyId через JWT payload

### Definition of Done
Sprint 4 считается завершённым, если:
- [ ] Login → Dashboard → Create Task работает end-to-end
- [ ] UI Canon соблюдён (проверка font-weight в DevTools)
- [ ] Нет нарушений Language Policy (все тексты на русском)
- [ ] JWT корректно сохраняется в HttpOnly cookies
- [ ] Сессия сохраняется после перезагрузки страницы
- [ ] Build проходит без ошибок (`pnpm build`)
- [ ] Lint проходит без warnings (`pnpm lint`)

### Rollback Conditions
Спринт останавливается, если:
- API endpoints не готовы (отсутствуют `/auth/login`, `/users/me`, `/tasks`, `/fields`)
- JWT токены не стабильны (ошибки 401/403)
- Next.js 14 несовместим с текущей инфраструктурой

**Действия при rollback:**
1. Остановка работы
2. Фиксация проблемы в DECISIONS.log
3. Запрос уточнения у USER
4. Возврат к PLANNING mode

### Связанные документы
- `docs/06-IMPLEMENTATION/PHASE_ALPHA/SCOPE.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/UI_DESIGN_CANON.md`
- `implementation_plan.md`
- `task.md`

### Зависимости
- Существующий API (`apps/api`)
- Identity Service (JWT выдача)
- PostgreSQL (для данных)

### Риски
1. **Dashboard scope неясен** — требуется уточнение: новый или обновление существующего
2. **SSR + JWT** — возможны проблемы с Edge Runtime
3. **Browser testing** — не определено: делать или нет

---

## UI-CANON-001

**Дата:** 2026-02-03  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Создание UI_DESIGN_CANON.md v0.1 как обязательного нормативного документа для всех UI-задач.

### Ключевые требования
1. Шрифт: Geist
2. Заголовки: font-medium (weight: 500)
3. Основной текст: font-normal (weight: 400)
4. **ЗАПРЕЩЕНО:** font-bold, font-semibold
5. Светлая тема
6. Карточки: bg-white, border-black/10, rounded-2xl
7. Кнопки: rounded-2xl, font-medium
8. Inputs: rounded-lg, border-black/10

### Обоснование
- Отсутствие UI_DESIGN_CANON.md создавало архитектурную дыру
- ORCHESTRATOR PROMPT не является документом архитектуры
- Необходим единый источник истины для UI-решений

### Связанные документы
- `CANON.md`
- `ARCHITECTURAL_AXIOMS.md`
- `ANTIGRAVITY SOFTWARE FACTORY — ORCHESTRATOR PROMPT.md`

---

## GAMMA-SPRINT3-001

**Дата:** 2026-02-08  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Запустить Sprint 3 (Phase Gamma) с первым инкрементом: `Episodic Retrieval` и теневой контур advisory без пользовательского воздействия.

### Scope
- **Phase:** Gamma
- **Sprint:** 3
- **Компоненты:**
  - `apps/api/src/shared/memory/*`
  - `@rai/vector-store`
  - проектные чек-листы Gamma

### Технические ограничения
1. **Human-in-the-loop:** никаких автоматических действий на пользователя.
2. **Shadow-only:** retrieval и ранжирование работают в фоне, без UI/контроллеров.
3. **Multi-tenancy:** все обращения только через `companyId`.
4. **Architecture:** `Service = IO`, оркестрация и бизнес-решения не переносить в infra слой.
5. **Traceability:** каждый retrieval поддерживает `traceId`.

### Definition of Done
- [x] Реализован `EpisodicRetrievalService` с retrieval из `MemoryManager`.
- [x] Есть unit-тесты retrieval-сервиса (минимум 2 сценария).
- [x] Обновлены чек-листы Sprint 3 и документы планирования.
- [x] Нет изменений, которые публикуют рекомендации в продуктовый интерфейс.

### Rollback Conditions
Спринт останавливается, если:
- нарушена изоляция по `companyId`;
- retrieval приводит к пользовательским side effects;
- появляется обход Admission/Integrity принципов.

### Связанные документы
- `docs/06-IMPLEMENTATION/PHASE_GAMMA/SPRINT_3_CHECKLIST.md`
- `docs/06-IMPLEMENTATION/PHASE_GAMMA/EXECUTION_PLAN.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/ARCHITECTURAL_AXIOMS.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/FORBIDDEN.md`

### Зависимости
- `MemoryManager`
- `@rai/vector-store`
- `memory_entries` (pgvector)

### Риски
1. Низкое качество metadata для `POSITIVE/NEGATIVE` разметки.
2. Потенциальная деградация latency при большом объёме retrieval.
3. Drift в эмбеддингах без централизованной валидации.

---

## SECURITY-CANON-001

**Дата:** 2026-02-08  
**Автор:** TECHLEAD (AI)  
**Статус:** ACCEPTED  

### Решение
Зафиксировать обязательный документ `SECURITY_CANON.md` как нормативный слой для security-check перед реализацией.

### Scope
- `docs/01-ARCHITECTURE/PRINCIPLES/SECURITY_CANON.md`
- процессы проверки TECHLEAD перед стартом задач

### Технические ограничения
1. Обязательная проверка tenant-изоляции (`companyId`).
2. Обязательная проверка audit trail для high-impact потоков.
3. Запрет обхода Admission/Integrity gate.
4. Запрет хранения секретов в коде/документах.

### Definition of Done
- [x] Создан `SECURITY_CANON.md` в слое `PRINCIPLES`.
- [x] Документ согласован с `CANON.md` и `ARCHITECTURAL_AXIOMS.md`.
- [x] Обновлены проектные чек-листы Sprint 3 и memory-bank.

### Связанные документы
- `docs/01-ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/ARCHITECTURAL_AXIOMS.md`
- `docs/ANTIGRAVITY SOFTWARE FACTORY — ORCHESTRATOR PROMPT.md`

---

## Формат записи

Каждое новое решение должно содержать:

```
## DECISION-ID

**Дата:** YYYY-MM-DD
**Автор:** ROLE (USER/TECHLEAD/CODER)
**Статус:** PENDING / ACCEPTED / REJECTED / DEPRECATED

### Решение
[Краткое описание решения]

### Scope
[Охват: Phase, Sprint, Компоненты]

### Технические ограничения
[Ключевые constraints]

### Definition of Done
[Критерии завершения]

### Rollback Conditions
[Условия отката]

### Связанные документы
[Ссылки на документы]

### Зависимости
[Внешние зависимости]

### Риски
[Известные риски]
```

---

## Правила работы с DECISIONS.log

1. **Обязательность:** Ни одна задача не принимается в работу без Decision-ID
2. **Фиксация:** Решение фиксируется ДО начала реализации
3. **Статусы:**
   - `PENDING` — ожидает утверждения USER
   - `ACCEPTED` — утверждено, можно реализовывать
   - `REJECTED` — отклонено
   - `DEPRECATED` — устарело, заменено новым решением
4. **Изменение:** Решение можно изменить только через новый Decision-ID
5. **Трассируемость:** Все изменения должны ссылаться на Decision-ID

---

## История изменений

### 2026-02-03
- Создан DECISIONS.log
- Добавлен SPRINT4-WEB-001 (PENDING)
- Добавлен UI-CANON-001 (ACCEPTED)
- Добавлены ARCH-DEBT-001, 002, 003 (Architecture Audit Sprint 4)

---

# ============================================================
# ARCHITECTURE DEBT (Sprint 4 Audit)
# ============================================================

## ARCH-DEBT-001

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 18:50  
**Автор:** Chief System Architect (AI)  
**Статус:** RESOLVED (Sprint 5a COMPLETE)
**Приоритет:** CRITICAL  
**Target:** Sprint 5a

### Решение
Multi-tenancy отсутствует в Auth Module

### Контекст
Architectural Audit Sprint 4 выявил критическое отсутствие multi-tenancy:
- `companyId` в JWT всегда `null`
- Нет фильтрации данных по `companyId` в Dashboard
- Все пользователи видят данные всех компаний

### Действия
Реализовать multi-tenancy в Sprint 5a:
1. Добавить relation `User -> Company` в Prisma schema
2. Заполнять `companyId` в JWT payload из `user.company`
3. Добавить фильтрацию по `companyId` во всех API endpoints
4. Обновить Dashboard для фильтрации данных по `companyId`

### Multi-tenancy Canon (КРИТИЧНО)
**Правило безопасности:**
- `companyId` ВСЕГДА извлекается из security context (JWT payload)
- `companyId` НИКОГДА не принимается из `body`, `query`, `params`
- Веб-интерфейс НЕ ИМЕЕТ ПРАВА формировать `companyId`

### Обоснование
Без multi-tenancy система непригодна для production.  
Это блокер для пилотного внедрения.

### Связанные документы
- `ARCH_AUDIT_SPRINT_4.md` (Section 2, 3)
- `implementation_plan.md` (Sprint 5a)

---

## ARCH-DEBT-002

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 18:50  
**Автор:** Chief System Architect (AI)  
**Статус:** RESOLVED (Sprint 5a COMPLETE)
**Приоритет:** HIGH  
**Target:** Sprint 5a

### Решение
Auth Repository отсутствует (Infrastructure Leak)

### Контекст
Auth Service напрямую использует `PrismaService` (infrastructure leak).  
Нет абстракции между Auth Service и БД.  
Это технический долг, усложняющий миграцию и тестирование.

### Действия
Создать UserRepository (Repository pattern):
1. Создать interface `IUserRepository`
2. Создать `UserRepository` с методами: `findByEmail`, `findById`
3. Инжектировать `UserRepository` в Auth Service
4. Убрать прямую зависимость от `PrismaService`

### Обоснование
Repository pattern обеспечивает:
- Абстракцию от конкретной БД
- Упрощение тестирования (mock repository)
- Возможность добавления кэша без изменения Auth Service

### Связанные документы
- `ARCH_AUDIT_SPRINT_4.md` (Section 2, 3)
- `implementation_plan.md` (Sprint 5a)

---

## ARCH-DEBT-003

**Дата:** 2026-02-03  
**Обновлено:** 2026-02-03 18:50  
**Автор:** Chief System Architect (AI)  
**Статус:** DEFERRED (Sprint 6)  
**Приоритет:** MEDIUM  
**Target:** Sprint 6

### Решение
Web Orchestrator не реализован

### Контекст
Веб-интерфейс работает напрямую с API (fetch → render).  
Нет централизованной логики для сложных flow.  
Риск размазывания логики по компонентам при росте системы.

### Действия
Создать WebOrchestrator для управления веб-flow (API-layer, НЕ frontend):
1. Создать `WebOrchestrator` service в NestJS API
2. Переместить сложные сценарии из компонентов в Orchestrator
3. Использовать для multi-step forms, wizards, complex validations

**Важно:** WebOrchestrator — это API-layer (NestJS service), НЕ frontend.
Веб-интерфейс (Next.js) не имеет права содержать бизнес-логику или orchestration.

Альтернатива: использовать существующий `AgroOrchestrator`

### Обоснование
Orchestrator = Brain (канон RAI_EP).  
Централизация логики предотвращает деградацию архитектуры.  
Упрощает тестирование и поддержку.

### Связанные документы
- `ARCH_AUDIT_SPRINT_4.md` (Section 2, 3, 5)
- `implementation_plan.md` (Sprint 5a, DEFERRED)

## TRACK5-001

**Дата:** 2026-02-12
**Автор:** TECHLEAD (AI)
**Статус:** ACCEPTED

### Решение
Реализация Track 5 — Yield & KPI Engine. Слой измерения производственной и финансовой эффективности на основе данных о сборе урожая. Добавление модели `HarvestResult` и сервисов расчета финансового результата (ROI, себестоимость).

### Scope
- **Phase:** Gamma
- **Sprint:** 7 (extension)
- **Компоненты:**
  - Prisma Schema (`HarvestResult`)
  - NestJS Services (`YieldService`, `KPIService`)
  - Next.js UI (`yield/page.tsx`, `plans/page.tsx` update)

### Технические ограничения
1. **Multi-tenancy:** Все данные `HarvestResult` и расчеты KPI строго изолированы по `companyId` из JWT.
2. **Audit:** Любые мутации `HarvestResult` логируются событием `HARVEST_RESULT_RECORDED`.
3. **UI Canon:** Шрифт Geist, веса 400/500, белый фон, `border-black/10`, `rounded-2xl`.
4. **Language:** Полная локализация интерфейса на русский язык.
5. **Decoupling:** `KPIService` использует `BudgetPlan` и `HarvestResult`, не обращаясь к `ExecutionService` напрямую.

### Definition of Done
- [x] Модель `HarvestResult` создана в БД.
- [x] `YieldService` обеспечивает CRUD сбор урожая (базовая логика).
- [x] `YieldService` интегрирован с `AuditService` (событие `HARVEST_RESULT_RECORDED`).
- [x] `KPIService` выполняет детерминированный расчет ROI и других KPI.
- [x] В Plan Cockpit добавлен блок Yield & KPI (интеграция в `plans/page.tsx`).
- [x] Проведены тесты расчетов и изоляции данных.

### Rollback Conditions
- Обнаружение возможности кросс-тенантного доступа к данным.
- Критические ошибки в формулах расчета финансовой эффективности.
- Нарушение отзывчивости интерфейса при расчете KPI.

### Связанные документы
- `docs/01-ARCHITECTURE/PRINCIPLES/CANON.md`
- `docs/01-ARCHITECTURE/PRINCIPLES/UI_DESIGN_CANON.md`
- `f:\RAI_EP\Рабочая\implementation_plan.md`

---

## PHASE0-CORE-001

**Дата:** 2026-02-15
**Автор:** TECHLEAD (AI)
**Статус:** APPROVED
**Scope:** Global
**Binding:** HARD
**Enforcement:** Code + Audit

### Решение
Фиксация архитектурных инвариантов ("Laws of Physics") для ядра системы.

### Scope
- **Budget Integrity**: `techMapId` (NOT NULL), `version`, `hash`. Запрет ручного создания.
- **Execution Integrity**: Ссылка на `planId`, `plannedOperationId`. Запрет ad-hoc операций.
- **Ledger Immutability**: Append-only. Запрет UPDATE/DELETE. Corrections via reversal.
- **KPI Calculation**: Derived only. Запрет хранения в транзакционных таблицах.
- **Tenant Isolation**: `companyId` обязателен. Cross-tenant joins запрещены.
- **Versioning**: Запрет мутаций активных версий TechMap/Plan.

### Definition of Done
- Правила отражены в `PHASE 0 — ФИКСАЦИЯ ЯДРА СИСТЕМЫ.md`.
- Проведен аудит кода на соответствие (Gap Analysis).
- Все новые разработки следуют этим правилам (блокировка на уровне Code Review).

### Rollback Conditions
- Невозможность реализации технически (например, ограничения БД).
- Блокировка бизнес-процессов (выявляется на этапе аудита).

### Связанные документы
- `docs/01-ARCHITECTURE/PHASE 0 — ФИКСАЦИЯ ЯДРА СИСТЕМЫ.md`
- `docs/01-ARCHITECTURE/Финальный стратегический план.md`
