generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Multi-tenancy Models ---

model Company {
  id        String   @id @default(cuid())
  name      String
  clients   Client[]
  users     User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]

  @@map("companies")
}

model Client {
  id        String   @id @default(cuid())
  name      String
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  fields    Field[]
  users     User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]

  @@map("clients")
}

// --- User Management ---

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  role         UserRole  @default(USER)
  phone        String?
  telegramId   String?   @unique
  
  emailVerified        Boolean  @default(false)
  emailVerificationToken String?  @unique
  emailVerificationExpiresAt DateTime?
  
  companyId    String?
  company      Company?  @relation(fields: [companyId], references: [id])
  clientId     String?
  client       Client?   @relation(fields: [clientId], references: [id])

  accessLevel     UserAccessLevel  @default(DEMO)
  invitedBy       String?          // ID того, кто пригласил
  invitedAt       DateTime?
  activatedAt     DateTime?        // Когда активирован FULL доступ
  demoExpiresAt   DateTime?        // Срок демо-доступа (7 дней)

  // Связи
  invitations     Invitation[]     @relation("Invitee")
  sentInvitations Invitation[]     @relation("Inviter")

  // Business Core интеграция
  coreUserId   String?   @unique
  coreWalletId String?   @unique
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  @@map("users")
}

model Invitation {
  id              String        @id @default(cuid())
  
  // Идентификаторы инвайта
  token           String        @unique  // UUID для email ссылок
  shortCode       String        @unique  // 6 цифр для Telegram
  
  // Получатель (один из двух обязателен)
  email           String?       // Если инвайт по email
  telegramId      String?       // Если инвайт через TG PUSH
  
  // Отправитель и назначение
  inviterId       String        // Кто пригласил
  inviter         User          @relation("Inviter", fields: [inviterId], references: [id])
  
  inviteeId       String?       // Кого пригласили (если user уже есть)
  invitee         User?         @relation("Invitee", fields: [inviteeId], references: [id])
  
  // Параметры доступа
  role            UserRole      // Роль в системе
  accessLevel     UserAccessLevel @default(INVITED)
  
  // Привязка к структуре
  companyId       String        // В какую компанию
  company         Company       @relation(fields: [companyId], references: [id])
  clientId        String?       // В какое хозяйство (опционально)
  client          Client?       @relation(fields: [clientId], references: [id])
  
  // Статус и сроки
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime      // Действует 72 часа
  createdAt       DateTime      @default(now())
  acceptedAt      DateTime?     // Когда приняли
  activationIp    String?       // IP адрес активации
  activationUserAgent String?   // User-Agent при активации
  
  // Индексы
  @@index([token])
  @@index([shortCode])
  @@index([email])
  @@index([telegramId])
  @@index([status])
  @@index([expiresAt])
  @@index([inviterId])
  
  @@map("invitations")
}

// --- Agri Entities ---

// --- Agri Entities ---

model Field {
  id             String        @id @default(cuid())
  cadastreNumber String        @unique
  name           String?
  area           Float         // в гектарах
  coordinates    Json          // GeoJSON Polygon
  centroid       Json?         // GeoJSON Point
  soilType       SoilType
  status         FieldStatus   @default(ACTIVE)
  
  clientId       String
  client         Client        @relation(fields: [clientId], references: [id])

  // Business Core интеграция
  coreObjectId   String?       @unique
  
  seasons        Season[]
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@index([coordinates])
  @@index([clientId])
  @@map("fields")
}

model Rapeseed {
  id                String   @id @default(cuid())
  name              String   // Пшеница, кукуруза, рапс
  variety           String?  // Сорт рапса
  reproduction      String?  // Репродукция (Элита, РС1, РС2)
  type              RapeseedType // Озимый, яровой
  
  oilContent        Float?   // Масличность, %
  erucicAcid        Float?   // Эруковая кислота, %
  glucosinolates    Float?   // Глюкозинолаты, мкмоль/г

  vegetationPeriod  Int      // Дней от посева до уборки
  sowingNormMin     Float?   // кг/га мин
  sowingNormMax     Float?   // кг/га макс
  sowingDepthMin    Float?   // см мин
  sowingDepthMax    Float?   // см макс
  
  // Версионирование параметров
  version           Int      @default(1)
  isLatest          Boolean  @default(true)
  
  companyId         String?  // Multi-tenancy (если NULL - системная культура)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  seasons           Season[]
  history           RapeseedHistory[]
  
  @@unique([name, companyId, version]) // Уникальность имени в рамках компании и версии
  @@index([companyId])
  @@map("rapeseeds")
}

model RapeseedHistory {
  id           String   @id @default(cuid())
  rapeseedId   String
  rapeseed     Rapeseed     @relation(fields: [rapeseedId], references: [id])
  version      Int
  changeReason String?  // Почему изменили параметры
  changedBy    String?  // User ID
  snapshot     Json     // Полный слепок параметров
  
  createdAt    DateTime @default(now())

  @@index([rapeseedId, version])
  @@map("rapeseed_history")
}

// --- Production Cycle & Planning ---

model Season {
  id               String       @id @default(cuid())
  year             Int
  status           SeasonStatus @default(PLANNING)
  
  fieldId          String
  field            Field        @relation(fields: [fieldId], references: [id])
  
  cropId           String?      // BACKWARD COMPATIBILITY (Temporary)
  rapeseedId       String
  rapeseed         Rapeseed     @relation(fields: [rapeseedId], references: [id])
  
  technologyCardId String?
  technologyCard   TechnologyCard? @relation(fields: [technologyCardId], references: [id])

  // Yield Tracking
  expectedYield    Float?       // Ожидаемая урожайность (т/га)
  actualYield      Float?       // Фактическая урожайность (т/га)
  
  // Immutable Pattern
  isLocked         Boolean      @default(false)
  lockedAt         DateTime?
  lockedBy         String?      // User ID

  startDate        DateTime?
  endDate          DateTime?

  // Business Core интеграция
  coreProcessId    String?      @unique
  companyId        String       // Denormalized for performance
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  history          SeasonHistory[]
  snapshots        SeasonSnapshot[]

  @@index([id, companyId])          // Для быстрой валидации доступа
  @@index([fieldId, year])          // Для севооборота
  @@index([companyId, year])         // Для отчетов по годам
  @@index([companyId, status])      // Для дашбордов
  @@index([status, companyId])      // Для быстрых фильтров
  @@index([rapeseedId, companyId])  // Для фильтрации по тенанту
  @@map("seasons")
}

model SeasonSnapshot {
  id               String   @id @default(cuid())
  seasonId         String
  season           Season   @relation(fields: [seasonId], references: [id])
  
  // Данные на момент фиксации
  year             Int
  status           SeasonStatus
  fieldId          String
  rapeseedId       String
  
  expectedYield    Float?
  actualYield      Float?
  
  startDate        DateTime?
  endDate          DateTime?
  
  // Дополнительные метаданные
  snapshotData     Json     // Полный дамп всех связанных данных (удобрения, операции и т.д.)
  
  companyId        String
  createdBy        String   // User ID
  createdAt        DateTime @default(now())

  @@index([seasonId])
  @@index([companyId])
  @@index([createdAt])
  @@index([seasonId, createdAt])
  @@index([companyId, year])
  @@index([rapeseedId, year])
  @@map("season_snapshots")
}

model AuditFailure {
  id               String   @id @default(cuid())
  event            String
  userId           String?
  metadata         String   @db.Text
  error            String   @db.Text
  attempt          Int
  createdAt        DateTime @default(now())

  @@map("audit_failures")
}

model SeasonHistory {
  id           String   @id @default(cuid())
  seasonId     String
  season       Season   @relation(fields: [seasonId], references: [id])
  
  action       String   // CREATE, UPDATE, COMPLETE, LOCK, YIELD_UPDATE
  changes      Json     // Diff изменений
  
  userId       String?
  createdAt    DateTime @default(now())

  @@index([seasonId])
  @@map("season_history")
}

// --- Business Rules ---

model BusinessRule {
  id             String   @id @default(cuid())
  code           String   // UNIQUE_CODE (e.g. MIN_SEASON_LENGTH)
  name           String
  description    String?
  
  params         Json     // Параметры правила (числа, диапазоны)
  isActive       Boolean  @default(true)
  severity       RuleSeverity @default(ERROR) // ERROR, WARNING
  
  companyId      String?  // Если NULL - системное правило
  
  version        Int      @default(1)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([code, companyId, version])
  @@map("business_rules")
}

// --- Existing Models ---

model TechnologyCard {
  id          String   @id @default(cuid())
  name        String
  description String?
  operations  TechnologyCardOperation[]
  seasons     Season[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("technology_cards")
}

model TechnologyCardOperation {
  id               String   @id @default(cuid())
  name             String
  sequence         Int
  technologyCardId String
  technologyCard   TechnologyCard @relation(fields: [technologyCardId], references: [id])
  
  // Параметры операции (заглушка для будущего)
  description      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([technologyCardId])
  @@map("technology_card_operations")
}

// --- Enums ---

enum UserRole {
  ADMIN
  MANAGER
  AGRONOMIST
  FIELD_WORKER
  CLIENT_ADMIN
  USER
}

enum SoilType {
  CHERNOZEM
  LOAM
  SANDY
  CLAY
  PODZOLIC
  SODDY
  GRAY_FOREST
  CHESTNUT
}

enum FieldStatus {
  ACTIVE
  ARCHIVED
  IN_PROCESSING
}

enum RapeseedType {
  WINTER      // Озимый
  SPRING      // Яровой
}



enum SeasonStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RuleSeverity {
  ERROR
  WARNING
  INFO
}

enum UserAccessLevel {
  DEMO
  INVITED
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // INVITATION_ACTIVATED, FIELD_CREATED, RAPESEED_ROTATION_VIOLATION
  userId      String?
  ip          String?
  userAgent   String?
  metadata    Json?    // Дополнительные детали
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ApiUsage {
  id        String   @id @default(cuid())
  userId    String?
  ip        String?
  action    String
  count     Int      @default(0)
  date      DateTime @default(now())

  @@unique([userId, action, date])
  @@unique([ip, action, date])
  @@map("api_usage")
}

model MemoryEntry {
  id          String   @id @default(cuid())
  content     String
  embedding   Unsupported("vector(1536)")?
  metadata    Json?
  companyId   String
  memoryType  String   // CONTEXT | KNOWLEDGE | STRATEGY | PROCESS
  source      String   // system | user | import | llm
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([companyId, memoryType])
  @@map("memory_entries")
}
