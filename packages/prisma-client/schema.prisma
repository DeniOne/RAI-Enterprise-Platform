generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Multi-tenancy Models ---

model Company {
  id        String   @id @default(cuid())
  name      String
  clients   Client[]
  holdings  Holding[]
  users     User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]
  
  roleDefinitions RoleDefinition[]
  employeeProfiles EmployeeProfile[]
  fields      Field[]
  technologyCards TechnologyCard[]
  tasks       Task[]
  
  // CRM Relations
  deals            Deal[]
  scoreCards       ScoreCard[]
  contracts        Contract[]
  
  // Tech Map & CMR Relations
  techMaps         TechMap[]
  deviationReviews DeviationReview[]
  cmrDecisions     CmrDecision[]
  cmrRisks         CmrRisk[]
  insuranceCoverages InsuranceCoverage[]
  
  // HR Control Plane
  pulseSurveys      PulseSurvey[]
  humanAssessmentSnapshots HumanAssessmentSnapshot[]
  okrCycles         OkrCycle[]
  hrKpiIndicators   HrKPIIndicator[]

  @@map("companies")
}


model Client {
  id        String   @id @default(cuid())
  name      String
  
  // CRM Fields
  inn       String?  @unique
  type      ClientType @default(FARMER)
  riskLevel RiskLevel  @default(LOW)

  // Ownership & Structure
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  holdingId String?
  holding   Holding? @relation(fields: [holdingId], references: [id])
  
  fields    Field[]
  users     User[]
  
  // CRM Relations
  deals      Deal[]
  scoreCards ScoreCard[]
  contracts  Contract[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]

  @@map("clients")
}

model Holding {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  // Tenant Isolation
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  
  clients     Client[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("holdings")
}


// --- User Management ---

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  role         UserRole  @default(USER)
  phone        String?
  telegramId   String?   @unique
  
  emailVerified        Boolean  @default(false)
  emailVerificationToken String?  @unique
  emailVerificationExpiresAt DateTime?
  
  companyId    String   // ARCH-DEBT-001: Multi-tenancy (NOT NULL)
  company      Company  @relation(fields: [companyId], references: [id])
  clientId     String?
  client       Client?   @relation(fields: [clientId], references: [id])

  accessLevel     UserAccessLevel  @default(DEMO)
  invitedBy       String?          // ID того, кто пригласил
  invitedAt       DateTime?
  activatedAt     DateTime?        // Когда активирован FULL доступ
  demoExpiresAt   DateTime?        // Срок демо-доступа (7 дней)

  // Связи
  invitations     Invitation[]     @relation("Invitee")
  sentInvitations Invitation[]     @relation("Inviter")

  // Business Core интеграция
  coreUserId   String?   @unique
  coreWalletId String?   @unique
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  tasks        Task[]
  // HR & CMR Relations
  employeeProfile EmployeeProfile?
  cmrDecisions    CmrDecision[]

  @@map("users")
}



model Invitation {
  id              String        @id @default(cuid())
  
  // Идентификаторы инвайта
  token           String        @unique  // UUID для email ссылок
  shortCode       String        @unique  // 6 цифр для Telegram
  
  // Получатель (один из двух обязателен)
  email           String?       // Если инвайт по email
  telegramId      String?       // Если инвайт через TG PUSH
  
  // Отправитель и назначение
  inviterId       String        // Кто пригласил
  inviter         User          @relation("Inviter", fields: [inviterId], references: [id])
  
  inviteeId       String?       // Кого пригласили (если user уже есть)
  invitee         User?         @relation("Invitee", fields: [inviteeId], references: [id])
  
  // Параметры доступа
  role            UserRole      // Роль в системе
  accessLevel     UserAccessLevel @default(INVITED)
  
  // Привязка к структуре
  companyId       String        // В какую компанию
  company         Company       @relation(fields: [companyId], references: [id])
  clientId        String?       // В какое хозяйство (опционально)
  client          Client?       @relation(fields: [clientId], references: [id])
  
  // Статус и сроки
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime      // Действует 72 часа
  createdAt       DateTime      @default(now())
  acceptedAt      DateTime?     // Когда приняли
  activationIp    String?       // IP адрес активации
  activationUserAgent String?   // User-Agent при активации
  
  // Индексы
  @@index([token])
  @@index([shortCode])
  @@index([email])
  @@index([telegramId])
  @@index([status])
  @@index([expiresAt])
  @@index([inviterId])
  
  @@map("invitations")
}

// --- Agri Entities ---

// --- Agri Entities ---

model Field {
  id             String        @id @default(cuid())
  cadastreNumber String        @unique
  name           String?
  area           Float         // в гектарах
  coordinates    Json          // GeoJSON Polygon
  centroid       Json?         // GeoJSON Point
  soilType       SoilType
  status         FieldStatus   @default(ACTIVE)
  
  clientId       String
  client         Client        @relation(fields: [clientId], references: [id])

  companyId      String
  company        Company       @relation(fields: [companyId], references: [id])

  // Business Core интеграция
  coreObjectId   String?       @unique
  
  seasons        Season[]
  tasks          Task[]
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@index([coordinates])
  @@index([clientId])
  @@index([companyId])
  @@map("fields")
}

model Rapeseed {
  id                String   @id @default(cuid())
  name              String   // Пшеница, кукуруза, рапс
  variety           String?  // Сорт рапса
  reproduction      String?  // Репродукция (Элита, РС1, РС2)
  type              RapeseedType // Озимый, яровой
  
  oilContent        Float?   // Масличность, %
  erucicAcid        Float?   // Эруковая кислота, %
  glucosinolates    Float?   // Глюкозинолаты, мкмоль/г

  vegetationPeriod  Int      // Дней от посева до уборки
  sowingNormMin     Float?   // кг/га мин
  sowingNormMax     Float?   // кг/га макс
  sowingDepthMin    Float?   // см мин
  sowingDepthMax    Float?   // см макс
  
  // Версионирование параметров
  version           Int      @default(1)
  isLatest          Boolean  @default(true)
  
  companyId         String?  // Multi-tenancy (если NULL - системная культура)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  seasons           Season[]
  history           RapeseedHistory[]
  
  @@unique([name, companyId, version]) // Уникальность имени в рамках компании и версии
  @@index([companyId])
  @@map("rapeseeds")
}

model RapeseedHistory {
  id           String   @id @default(cuid())
  rapeseedId   String
  rapeseed     Rapeseed     @relation(fields: [rapeseedId], references: [id])
  version      Int
  changeReason String?  // Почему изменили параметры
  changedBy    String?  // User ID
  snapshot     Json     // Полный слепок параметров
  
  createdAt    DateTime @default(now())

  @@index([rapeseedId, version])
  @@map("rapeseed_history")
}

// --- Production Cycle & Planning ---

model Season {
  id               String       @id @default(cuid())
  year             Int
  status           SeasonStatus @default(PLANNING)
  
  fieldId          String
  field            Field        @relation(fields: [fieldId], references: [id])
  
  cropId           String?      // BACKWARD COMPATIBILITY (Temporary)
  rapeseedId       String
  rapeseed         Rapeseed     @relation(fields: [rapeseedId], references: [id])
  
  technologyCardId String?
  technologyCard   TechnologyCard? @relation(fields: [technologyCardId], references: [id])

  // Yield Tracking
  expectedYield    Float?       // Ожидаемая урожайность (т/га)
  actualYield      Float?       // Фактическая урожайность (т/га)
  
  // Immutable Pattern
  isLocked         Boolean      @default(false)
  lockedAt         DateTime?
  lockedBy         String?      // User ID

  startDate        DateTime?
  endDate          DateTime?

  // Business Core интеграция
  coreProcessId    String?      @unique
  companyId        String       // Denormalized for performance
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  currentStageId   String?      // ID текущего этапа (micro-state)
  stageProgress    SeasonStageProgress[]
  
  history          SeasonHistory[]
  snapshots        SeasonSnapshot[]
  tasks            Task[]
  
  // Tech Map Integration
  techMap          TechMap?
  deviationReviews DeviationReview[]
  cmrDecisions     CmrDecision[]
  cmrRisks         CmrRisk[]


  @@index([id, companyId])          // Для быстрой валидации доступа
  @@index([fieldId, year])          // Для севооборота
  @@index([companyId, year])         // Для отчетов по годам
  @@index([companyId, status])      // Для дашбордов
  @@index([status, companyId])      // Для быстрых фильтров
  @@index([rapeseedId, companyId])  // Для фильтрации по тенанту
  @@map("seasons")
}

model SeasonSnapshot {
  id               String   @id @default(cuid())
  seasonId         String
  season           Season   @relation(fields: [seasonId], references: [id])
  
  // Данные на момент фиксации
  year             Int
  status           SeasonStatus
  fieldId          String
  rapeseedId       String
  
  expectedYield    Float?
  actualYield      Float?
  
  startDate        DateTime?
  endDate          DateTime?
  
  // Дополнительные метаданные
  snapshotData     Json     // Полный дамп всех связанных данных (удобрения, операции и т.д.)
  
  companyId        String
  createdBy        String   // User ID
  createdAt        DateTime @default(now())

  @@index([seasonId])
  @@index([companyId])
  @@index([createdAt])
  @@index([seasonId, createdAt])
  @@index([companyId, year])
  @@index([rapeseedId, year])
  @@map("season_snapshots")
}

model AuditFailure {
  id               String   @id @default(cuid())
  event            String
  userId           String?
  metadata         String   @db.Text
  error            String   @db.Text
  attempt          Int
  createdAt        DateTime @default(now())

  @@map("audit_failures")
}
model SeasonStageProgress {
  id           String   @id @default(cuid())
  seasonId     String
  season       Season   @relation(fields: [seasonId], references: [id])
  
  stageId      String   // ID этапа (например, '04_SOWING')
  completedAt  DateTime @default(now())
  
  metadata     Json?    // Факты и контекст этапа (влажность, дата посева и т.д.)
  
  @@index([seasonId])
  @@index([stageId])
  @@map("season_stage_progress")
}

model SeasonHistory {
  id           String   @id @default(cuid())
  seasonId     String
  season       Season   @relation(fields: [seasonId], references: [id])
  
  action       String   // CREATE, UPDATE, COMPLETE, LOCK, YIELD_UPDATE
  changes      Json     // Diff изменений
  
  userId       String?
  createdAt    DateTime @default(now())

  @@index([seasonId])
  @@map("season_history")
}

// --- Business Rules ---

model BusinessRule {
  id             String   @id @default(cuid())
  code           String   // UNIQUE_CODE (e.g. MIN_SEASON_LENGTH)
  name           String
  description    String?
  
  params         Json     // Параметры правила (числа, диапазоны)
  isActive       Boolean  @default(true)
  severity       RuleSeverity @default(ERROR) // ERROR, WARNING
  
  companyId      String?  // Если NULL - системное правило
  
  version        Int      @default(1)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([code, companyId, version])
  @@map("business_rules")
}

// --- Existing Models ---

model TechnologyCard {
  id          String   @id @default(cuid())
  name        String
  description String?
  operations  TechnologyCardOperation[]
  seasons     Season[]
  
  companyId   String   // Изоляция карт на уровне тенанта
  company     Company  @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@map("technology_cards")
}

model TechnologyCardOperation {
  id               String   @id @default(cuid())
  name             String
  sequence         Int
  technologyCardId String
  technologyCard   TechnologyCard @relation(fields: [technologyCardId], references: [id])
  
  stageId          String?  // Ссылка на этап APL (например, '04_SOWING')
  resources        TechnologyCardResource[]
  
  description      String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([technologyCardId])
  @@index([stageId])
  @@map("technology_card_operations")
  tasks            Task[]
}

model TechnologyCardResource {
  id               String   @id @default(cuid())
  operationId      String
  operation        TechnologyCardOperation @relation(fields: [operationId], references: [id])
  
  type             String   // FERTILIZER, SEED, FUEL, CHEMICAL
  name             String   // "Карбамид", "Рапс Озёрный"
  dosage           Float    // Количество
  unit             String   // кг/га, л/га
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([operationId])
  @@map("technology_card_resources")
}

// --- Task Engine Models ---

model Task {
  id               String   @id @default(cuid())
  name             String
  status           TaskStatus @default(PENDING)
  
  // Context
  seasonId         String
  season           Season   @relation(fields: [seasonId], references: [id])
  
  operationId      String?
  operation        TechnologyCardOperation? @relation(fields: [operationId], references: [id])
  
  fieldId          String
  field            Field    @relation(fields: [fieldId], references: [id])
  
  // Assignment
  assigneeId       String?
  assignee         User?    @relation(fields: [assigneeId], references: [id])
  
  // Dates
  plannedDate      DateTime?
  completedAt      DateTime?
  
  // Tenant Isolation
  companyId        String
  company          Company  @relation(fields: [companyId], references: [id])
  
  // Actual Resources
  actualResources  TaskResourceActual[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([seasonId])
  @@index([companyId])
  @@index([assigneeId])
  @@index([fieldId])
  @@map("tasks")
}

model TaskResourceActual {
  id               String   @id @default(cuid())
  taskId           String
  task             Task     @relation(fields: [taskId], references: [id])
  
  type             String   // FERTILIZER, SEED, FUEL, CHEMICAL
  name             String
  amount           Float
  unit             String
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([taskId])
  @@map("task_resource_actuals")
}

// --- Enums ---

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum UserRole {
  ADMIN
  MANAGER
  AGRONOMIST
  FIELD_WORKER
  CLIENT_ADMIN
  USER
}

enum SoilType {
  CHERNOZEM
  LOAM
  SANDY
  CLAY
  PODZOLIC
  SODDY
  GRAY_FOREST
  CHESTNUT
}

enum FieldStatus {
  ACTIVE
  ARCHIVED
  IN_PROCESSING
}

enum RapeseedType {
  WINTER      // Озимый
  SPRING      // Яровой
}



enum SeasonStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RuleSeverity {
  ERROR
  WARNING
  INFO
}

enum UserAccessLevel {
  DEMO
  INVITED
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// --- Identity Registry Models ---

model EmployeeProfile {
  id           String   @id @default(cuid())
  
  // Link to external HRIS (1C:ZUP / etc)
  externalId   String?  @unique
  
  userId       String?  @unique
  user         User?    @relation(fields: [userId], references: [id])
  
  // Management Context: Reference to structural unit (Department / Brigade / etc)
  orgUnitId    String?  
  
  // Org Position
  roleId       String
  role         RoleDefinition @relation(fields: [roleId], references: [id])
  
  // Link to Development
  requiredRoleCompetencyRef String? 
  
  // Multi-tenant Boundaries
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id])
  
  holdingId    String?
  clientId     String?
  
  // --- Contour 1: Foundation (Lifecycle Projects) ---
  onboardingPlan HrOnboardingPlan?
  supportCases    HrSupportCase[]
  
  // --- Contour 2: Incentive (Alignment) ---
  objectives      Objective[]        // Owner of objective
  recognitionEvents HrRecognitionEvent[]
  rewardEvents    HrRewardEvent[]
  
  // --- Contour 3: Development (Strategic Signals) ---
  surveyResponses SurveyResponse[]
  assessmentSnapshots HumanAssessmentSnapshot[] 
  competencyStates    PersonalCompetencyState[]
  developmentPlan     HrDevelopmentPlan?
  
  // Identity lifecycle
  status       LifecycleStatus @default(ACTIVE)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([companyId])
  @@index([roleId])
  @@map("employee_profiles")
}

model HrOnboardingPlan {
  id          String   @id @default(cuid())
  employeeId  String   @unique
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  
  stages      Json     // Array of { title: string, completed: boolean, dueDate: DateTime? }
  progress    Float    @default(0.0)
  
  startDate   DateTime @default(now())
  completedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("hr_onboarding_plans")
}

model HrSupportCase {
  id          String   @id @default(cuid())
  employeeId  String
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  
  type        String   // "ADMIN", "TECH", "WELLBEING"
  subject     String
  status      String   @default("OPEN")
  
  createdAt   DateTime @default(now())
  closedAt    DateTime?
  
  @@map("hr_support_cases")
}

model RoleDefinition {
  id          String   @id @default(cuid())
  name        String   // e.g. "Chief Agronomist"
  description String?
  
  // Tenant Ownership
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  
  profiles    EmployeeProfile[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, companyId])
  @@map("role_definitions")
}

enum LifecycleStatus {
  ACTIVE
  ARCHIVED
  TERMINATED
}


model AuditLog {
  id          String   @id @default(cuid())
  action      String   // INVITATION_ACTIVATED, FIELD_CREATED, RAPESEED_ROTATION_VIOLATION
  userId      String?
  ip          String?
  userAgent   String?
  metadata    Json?    // Дополнительные детали
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ApiUsage {
  id        String   @id @default(cuid())
  userId    String?
  ip        String?
  action    String
  count     Int      @default(0)
  date      DateTime @default(now())

  @@unique([userId, action, date])
  @@unique([ip, action, date])
  @@map("api_usage")
}

model MemoryEntry {
  id          String   @id @default(cuid())
  content     String
  embedding   Unsupported("vector(1536)")?
  metadata    Json?
  companyId   String
  memoryType  String   // CONTEXT | KNOWLEDGE | STRATEGY | PROCESS
  source      String   // system | user | import | llm
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([companyId, memoryType])
  @@map("memory_entries")
}

// --- CRM Models ---

model Deal {
  id            String    @id @default(cuid())
  name          String
  stage         DealStage @default(LEAD)
  amount        Float     @default(0)
  probability   Float     @default(0)
  expectedDate  DateTime?

  clientId      String
  client        Client    @relation(fields: [clientId], references: [id])
  
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id])

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([companyId])
  @@index([clientId])
  @@map("crm_deals")
}

model ScoreCard {
  id              String   @id @default(cuid())
  clientId        String   @unique
  client          Client   @relation(fields: [clientId], references: [id])

  financialHealth Float?   // 0-100 score
  agroPotential   Float?   // Land bank * Productivity proxy
  reliability     Float?   // History/Risk score
  ltvPrediction   Float?   // 3-year projected revenue

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])

  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@index([companyId])
  @@map("crm_scorecards")
}

model Contract {
  id          String   @id @default(cuid())
  number      String
  type        String   // SUPPLY, PURCHASE, SERVICE
  status      String   // ACTIVE, COMPLETED, CANCELLED
  startDate   DateTime
  endDate     DateTime?
  amount      Float?

  clientId    String
  client      Client   @relation(fields: [clientId], references: [id])
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([clientId])
  @@map("crm_contracts")
}

// --- CRM Enums ---

enum ClientType {
  FARMER
  DEALER
  HOLDING
  PARTNER
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DealStage {
  LEAD
  QUALIFICATION
  OFFER
  CONTRACT
  CLOSED_WON
  CLOSED_LOST
}

// --- Tech Map Domain (Detailed Operational Planning) ---

model TechMap {
  id          String   @id @default(cuid())
  
  seasonId    String   @unique // 1-to-1 with Season
  season      Season   @relation(fields: [seasonId], references: [id])
  
  stages      MapStage[]
  
  // Metadata for AI Generation
  soilType    SoilType?
  moisture    Float?   // Initial moisture %
  precursor   String?  // Предшественник
  
  status      TechMapStatus @default(DRAFT)
  
  // Versioning
  version     Int      @default(1)
  isLatest    Boolean  @default(true)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@map("tech_maps")
}

model MapStage {
  id          String   @id @default(cuid())
  name        String
  sequence    Int
  
  techMapId   String
  techMap     TechMap  @relation(fields: [techMapId], references: [id])
  
  operations  MapOperation[]
  
  // Integration with APL
  aplStageId  String?  // '04_SOWING' etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([techMapId])
  @@map("tech_map_stages")
}

model MapOperation {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  mapStageId  String
  mapStage    MapStage @relation(fields: [mapStageId], references: [id])
  
  // Detailed Planning
  plannedStartTime DateTime?
  plannedEndTime   DateTime?
  durationHours    Int?
  
  resources   MapResource[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([mapStageId])
  @@map("tech_map_operations")
}

model MapResource {
  id             String   @id @default(cuid())
  mapOperationId String
  mapOperation   MapOperation @relation(fields: [mapOperationId], references: [id])
  
  type           String   // FERTILIZER, etc.
  name           String
  amount         Float
  unit           String
  
  costPerUnit    Float?   // Planned cost
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([mapOperationId])
  @@map("tech_map_resources")
}

enum TechMapStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// --- Consulting Control Plane (CMR) ---

model DeviationReview {
  id              String   @id @default(cuid())
  
  // Context
  seasonId        String
  season          Season   @relation(fields: [seasonId], references: [id])
  
  stageId         String?  // Optional link to APL stage
  
  // Content
  deviationSummary    String   // Fact vs Plan
  aiImpactAssessment  String   // Risk analysis
  techConclusion      String?  // Agronomist's input
  proposedActions     String?  // Correction plan
  
  // Client Interaction
  clientResponseStatus ClientResponseStatus @default(PENDING)
  clientComment        String?
  clientRespondedAt    DateTime?
  
  // Responsibility
  responsibilityMode   ResponsibilityMode @default(SHARED)
  
  // SLA
  slaExpiration        DateTime?
  liabilityShiftStatus String?    // "SHIFTED_TO_CLIENT", "SUSPENDED"
  
  status          ReviewStatus @default(OPEN)
  
  risks           CmrRisk[]
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([seasonId])
  @@index([companyId])
  @@index([status])
  @@map("cmr_deviation_reviews")
}

model CmrDecision {
  id              String   @id @default(cuid())
  
  seasonId        String
  season          Season   @relation(fields: [seasonId], references: [id])
  
  action          String   // e.g., "ADJUST_SOWING_DATE"
  reason          String
  actor           String   // AI, MANAGER, CLIEN
  
  // Strategic Amplifiers
  confidenceLevel ConfidenceLevel @default(HIGH)
  alternatives    Json?    // Counterfactuals
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])
  
  createdAt       DateTime @default(now())
  
  // Strict Ownership
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([seasonId])
  @@index([userId])
  @@map("cmr_decisions")
}

model CmrRisk {
  id              String   @id @default(cuid())
  
  seasonId        String
  season          Season   @relation(fields: [seasonId], references: [id])
  
  type            RiskType
  description     String
  
  probability     RiskLevel // LOW, MEDIUM, HIGH
  impact          RiskLevel // LOW, MEDIUM, HIGH
  
  controllability Controllability // WHO controls this risk?
  liabilityMode   LiabilityMode   // WHO pays for it?
  
  mitigationPlan  String?
  
  // Link to Deviation Review (if this risk triggered a review)
  deviationReviewId String?
  deviationReview   DeviationReview? @relation(fields: [deviationReviewId], references: [id])
  
  status          String    // OPEN, MITIGATED, REALIZED
  
  // Insurance
  insuranceId     String?
  insurance       InsuranceCoverage? @relation(fields: [insuranceId], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([seasonId])
  @@index([type])
  @@map("cmr_risks")
}

model InsuranceCoverage {
  id              String   @id @default(cuid())
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])
  
  insurer         String   // Name of insurance company
  type            InsuranceType
  
  status          String   // ACTIVE, CLAIMED, EXPIRED
  
  insuredAmount   Float
  deductible      Float?
  
  startDate       DateTime
  endDate         DateTime
  
  // Risks covered by this policy
  coveredRisks    CmrRisk[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@map("cmr_insurance_coverages")
}

// --- CMR Enums ---

enum RiskType {
  AGRONOMIC
  CLIMATE
  OPERATIONAL
  REGULATORY
  MARKET
}

enum Controllability {
  CONSULTANT
  CLIENT
  SHARED
  FORCE_MAJEURE
}

enum LiabilityMode {
  CONSULTANT_ONLY
  CLIENT_ONLY
  SHARED
  INSURABLE
  LIABILITY_SUSPENDED
}

enum InsuranceType {
  YIELD_LOSS
  WEATHER_INDEX
  REGULATORY
}

enum ResponsibilityMode {
  SHARED
  CLIENT_ONLY
  CONSULTANT_ONLY
  LIABILITY_SUSPENDED
}

enum ClientResponseStatus {
  PENDING
  AGREED
  DISAGREED
  IGNORED
}

enum ReviewStatus {
  OPEN
  RESOLVED
  ESCALATED
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

// ==========================================
// BLOCK 5.2: HR CONTROL PLANE (Canon)
// ==========================================

// ==========================================
// BLOCK 5.2: HR CONTROL PLANE (Canon 3-Contour)
// ==========================================

// ------------------------------------------
// CONTOUR 2: INCENTIVE LAYER (Alignment)
// ------------------------------------------

model OkrCycle {
  id          String   @id @default(cuid())
  title       String   
  startDate   DateTime
  endDate     DateTime
  status      String   @default("ACTIVE")
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  objectives  Objective[]
  @@map("hr_okr_cycles")
}

model Objective {
  id          String   @id @default(cuid())
  title       String
  cycleId     String
  cycle       OkrCycle @relation(fields: [cycleId], references: [id])
  ownerId     String?  
  owner       EmployeeProfile? @relation(fields: [ownerId], references: [id])
  progress    Float    @default(0.0)
  keyResults  KeyResult[]
  createdAt   DateTime @default(now())
  @@map("hr_objectives")
}

model KeyResult {
  id          String   @id @default(cuid())
  title       String
  objectiveId String
  objective   Objective @relation(fields: [objectiveId], references: [id])
  targetValue Float
  currentValue Float   @default(0.0)
  metricSource String? 
  lastUpdated DateTime @updatedAt
  @@map("hr_key_results")
}

model HrKPIIndicator {
  id          String   @id @default(cuid())
  externalKey String   // e.g. "YIELD_PER_HA"
  title       String
  value       Float
  capturedAt  DateTime @default(now())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  @@map("hr_kpi_indicators")
}

model HrRecognitionEvent {
  id          String   @id @default(cuid())
  employeeId  String
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  type        String   // "PEER", "MANAGER", "SYSTEM"
  message     String
  createdAt   DateTime @default(now())
  @@map("hr_recognition_events")
}

model HrRewardEvent {
  id          String   @id @default(cuid())
  employeeId  String
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  type        String   // "BONUS", "EQUITY", "PERK"
  amount      Float?
  reason      String
  createdAt   DateTime @default(now())
  @@map("hr_reward_events")
}

// ------------------------------------------
// CONTOUR 3: DEVELOPMENT LAYER (Strategic)
// ------------------------------------------

model PulseSurvey {
  id          String   @id @default(cuid())
  title       String
  questions   Json     
  status      String   @default("DRAFT")
  startDate   DateTime?
  endDate     DateTime?
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  responses   SurveyResponse[]
  createdAt   DateTime @default(now())
  @@map("hr_pulse_surveys")
}

model SurveyResponse {
  id          String   @id @default(cuid())
  pulseSurveyId String
  pulseSurvey   PulseSurvey @relation(fields: [pulseSurveyId], references: [id])
  respondentId  String    
  respondent    EmployeeProfile @relation(fields: [respondentId], references: [id])
  answers       Json      // Immutable
  submittedAt   DateTime  @default(now())
  @@index([pulseSurveyId])
  @@map("hr_survey_responses")
}

model HumanAssessmentSnapshot {
  id          String   @id @default(cuid())
  employeeId  String
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  
  burnoutRisk       RiskLevel 
  engagementLevel   Float     // 0.0 - 1.0
  ethicalAlignment  Float     // 0.0 - 1.0
  controllability   Float     // 0.0 - 1.0 (Consumed by CMR)
  confidenceLevel   Float     @default(1.0) // 0.0 - 1.0 (Probabilistic accuracy)
  
  validFrom   DateTime @default(now())
  validTo     DateTime? 
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  
  createdAt   DateTime @default(now())
  @@index([employeeId])
  @@map("hr_human_assessment_snapshots")
}

model PersonalCompetencyState {
  id          String   @id @default(cuid())
  employeeId  String
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  competencyId String  // Ref to definition
  level       Float    // current mastery
  updatedAt   DateTime @updatedAt
  @@map("hr_competency_states")
}

model HrDevelopmentPlan {
  id          String   @id @default(cuid())
  employeeId  String   @unique
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id])
  actions     HrDevelopmentAction[]
  createdAt   DateTime @default(now())
  @@map("hr_development_plans")
}

model HrDevelopmentAction {
  id          String   @id @default(cuid())
  planId      String
  plan        HrDevelopmentPlan @relation(fields: [planId], references: [id])
  type        String   // "MENTORSHIP", "TRAINING", "ENV_CHANGE"
  description String
  status      String   @default("PLANNED")
  createdAt   DateTime @default(now())
  @@map("hr_development_actions")
}
