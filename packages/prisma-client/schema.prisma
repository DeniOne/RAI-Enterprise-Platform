generator client {
  provider        = "prisma-client-js"
  output          = "./generated-client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// --- Multi-tenancy Models ---

model Company {
  id          String       @id @default(cuid())
  name        String
  accounts    Account[]
  holdings    Holding[]
  users       User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]

  roleDefinitions   RoleDefinition[]
  employeeProfiles  EmployeeProfile[]
  technologyCards   TechnologyCard[]
  fields            Field[]
  tasks             Task[]
  fieldObservations FieldObservation[]

  // CRM Relations
  deals                Deal[]
  scoreCards           ScoreCard[]
  contracts            Contract[]
  harvestPlans         HarvestPlan[]
  performanceContracts PerformanceContract[]

  // Tech Map & CMR Relations
  techMaps           TechMap[]
  deviationReviews   DeviationReview[]
  budgetPlans        BudgetPlan[]
  cmrDecisions       CmrDecision[]
  cmrRisks           CmrRisk[]
  insuranceCoverages InsuranceCoverage[]
  harvestResults     HarvestResult[]

  // HR Control Plane
  pulseSurveys             PulseSurvey[]
  humanAssessmentSnapshots HumanAssessmentSnapshot[]
  okrCycles                OkrCycle[]
  hrKpiIndicators          HrKPIIndicator[]

  // Finance & Economy
  economicEvents    EconomicEvent[]
  ledgerEntries     LedgerEntry[]
  cashAccounts      CashAccount[]
  accountBalances   AccountBalance[]
  tenantStates      TenantState[]
  budgets           Budget[]
  budgetItems       BudgetItem[]
  // Legal & GR relations
  legalDocuments    LegalDocument[]
  legalRequirements LegalRequirement[]
  regulatoryBodies  RegulatoryBody[]
  complianceChecks  ComplianceCheck[]
  grInteractions    GrInteraction[]
  policySignals     PolicySignal[]
  researchPrograms  ResearchProgram[]

  // High-Level Risk Models
  riskSignals      RiskSignal[]
  riskAssessments  RiskAssessment[]
  riskStateHistory RiskStateHistory[]
  decisionRecords  DecisionRecord[]

  // Knowledge Graph (Sprint 2)
  knowledgeNodes KnowledgeNode[]
  knowledgeEdges KnowledgeEdge[]

  // Vision AI Baseline (Sprint 2)
  visionObservations VisionObservation[]

  executionRecords ExecutionRecord[]

  // Satellite Ingestion (Sprint 2)
  satelliteObservations SatelliteObservation[]

  // Asset Registries
  machinery                 Machinery[]
  stockItems                StockItem[]
  stockTransactions         StockTransaction[]
  jurisdictions             Jurisdiction[]
  regulatoryProfiles        RegulatoryProfile[]
  parties                   Party[]
  partyRelations            PartyRelation[]
  assetPartyRoles           AssetPartyRole[]
  commerceContracts         CommerceContract[]
  commerceContractRoles     CommerceContractPartyRole[]
  commerceObligations       CommerceObligation[]
  budgetReservations        BudgetReservation[]
  paymentSchedules          PaymentSchedule[]
  commerceFulfillmentEvents CommerceFulfillmentEvent[]
  stockMoves                StockMove[]
  revenueRecognitionEvents  RevenueRecognitionEvent[]
  invoices                  Invoice[]
  payments                  Payment[]
  paymentAllocations        PaymentAllocation[]
  regulatoryArtifacts       RegulatoryArtifact[]

  // Phase 4: Strategic OS
  strategicGoals StrategicGoal[]

  // Level B: Generative Engine
  agronomicStrategies AgronomicStrategy[]
  generationRecords   GenerationRecord[]

  // Level C: Contradiction-Resilient Intelligence
  governanceConfigs GovernanceConfig[]
  divergenceRecords DivergenceRecord[]
  // Level D: Adaptive Self-Learning
  modelVersions     ModelVersion[]
  trainingRuns      TrainingRun[]
  driftReports      DriftReport[]
  learningEvents    LearningEvent[]

  // Level E: Regenerative Optimization
  soilMetrics             SoilMetric[]
  sustainabilityBaselines SustainabilityBaseline[]
  biodiversityMetrics     BiodiversityMetric[]
  governanceLocks         GovernanceLock[]
  overrideRequests        OverrideRequest[]
  auditLogs               AuditLog[]

  // Level F: Institutional Oracle Standard
  levelFCertAudits     LevelFCertAudit[]
  governanceCommittees GovernanceCommittee[]
  quorumProcesses      QuorumProcess[]

  // Institutional Exploration Module (IEM)
  strategicSignals      StrategicSignal[]
  explorationCases      ExplorationCase[]
  warRoomSessions       WarRoomSession[]
  warRoomDecisionEvents WarRoomDecisionEvent[]
  impactAuditRecords    ImpactAuditRecord[]
  rewardRecords         RewardRecord[]
  labCapacityConfigs    LabCapacityConfig[]
  externalSourceEntries ExternalSourceAllowlist[]
  aiScanRunLogs         AIScanRunLog[]
 
  // Agro Domain
  agroEventDrafts     AgroEventDraft[]
  agroEventCommitted  AgroEventCommitted[]
  agroEscalations     AgroEscalation[]
 
  @@map("companies")
}

model Account {
  id   String @id @default(cuid())
  name String

  // CRM Fields
  inn    String?       @unique
  type   AccountType   @default(NOT_SET)
  status AccountStatus @default(ACTIVE)

  jurisdiction   String?
  riskCategory   RiskCategory   @default(LOW)
  strategicValue StrategicValue @default(C)

  // Ownership & Structure
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  holdingId String?
  holding   Holding? @relation(fields: [holdingId], references: [id])

  fields Field[]
  users  User[]

  // CRM Relations
  contacts     Contact[]
  interactions Interaction[]
  obligations  Obligation[]

  deals        Deal[]
  scoreCards   ScoreCard[]
  contracts    Contract[]
  harvestPlans HarvestPlan[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]

  // Asset Registries
  machinery  Machinery[]
  stockItems StockItem[]

  @@map("accounts")
}

model Contact {
  id        String  @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  firstName      String
  lastName       String?
  role           ContactRole @default(OPERATIONAL)
  influenceLevel Int? // 1-10

  email  String?
  phone  String?
  source String?

  interactions Interaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@map("crm_contacts")
}

model Interaction {
  id        String   @id @default(cuid())
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  type    InteractionType
  summary String          @db.Text
  date    DateTime        @default(now())

  // Links
  relatedEventId String? // Polymorphic ID (RiskEvent, LegalRequirement)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([contactId])
  @@map("crm_interactions")
}

model Obligation {
  id        String  @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  description String
  dueDate     DateTime

  responsibleUserId String?
  responsibleUser   User?   @relation("ObligationResponsible", fields: [responsibleUserId], references: [id])

  status ObligationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([status])
  @@map("crm_obligations")
}

enum AccountType {
  NOT_SET
  CLIENT
  PARTNER
  REGULATOR
  SUPPLIER
  INVESTOR
  OTHER
}

enum AccountStatus {
  ACTIVE
  FROZEN
  RISK
}

enum RiskCategory {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  NONE
}

enum StrategicValue {
  A
  B
  C
}

enum ContactRole {
  DECISION_MAKER
  LEGAL
  OPERATIONAL
}

enum InteractionType {
  MEETING
  CORRESPONDENCE
  CALL
  DOC_SUBMISSION
  REQUEST_RESPONSE
}

enum ObligationStatus {
  PENDING
  FULFILLED
  BREACHED
}

model Holding {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Tenant Isolation
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  accounts Account[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("holdings")
}

// --- Asset Registry Domain (Equipments, Chemicals, etc) ---

model Machinery {
  id           String        @id @default(cuid())
  name         String
  brand        String?
  serialNumber String? // [IDEMPOTENCY] Physical serial
  type         MachineryType
  status       AssetStatus   @default(PENDING_CONFIRMATION)

  idempotencyKey String? // [REFINEMENT] Removed @unique for AI flexibility

  // Multi-tenancy
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Accountability & Reject Path
  confirmedByUserId String?
  confirmedByUser   User?     @relation("MachineryConfirmedBy", fields: [confirmedByUserId], references: [id])
  confirmedAt       DateTime?

  archivedAt      DateTime?
  rejectionReason String?

  @@index([companyId])
  @@index([accountId, idempotencyKey]) // [REFINEMENT] Logical index
  @@map("machinery")
}

model StockItem {
  id     String        @id @default(cuid())
  name   String
  type   StockItemType
  status AssetStatus   @default(PENDING_CONFIRMATION)

  quantity Float  @default(0)
  unit     String

  idempotencyKey String? // [REFINEMENT] Removed @unique for AI flexibility

  // Multi-tenancy
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  transactions StockTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Accountability & Reject Path
  confirmedByUserId String?
  confirmedByUser   User?     @relation("StockItemConfirmedBy", fields: [confirmedByUserId], references: [id])
  confirmedAt       DateTime?

  archivedAt      DateTime?
  rejectionReason String?

  @@index([companyId])
  @@index([accountId, idempotencyKey]) // [REFINEMENT] Logical index
  @@map("stock_items")
}

model StockTransaction {
  id     String    @id @default(cuid())
  itemId String
  item   StockItem @relation(fields: [itemId], references: [id])

  type   StockTransactionType
  amount Float
  date   DateTime             @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Track 4: Execution Engine Link
  executionId String?
  execution   ExecutionRecord? @relation(fields: [executionId], references: [id])

  // Resource Details (Snapshot for audit)
  resourceType String?
  resourceName String?
  unit         String?
  costPerUnit  Float?
  totalCost    Float?

  orchLogId String?
  orchLog   ExecutionOrchestrationLog? @relation(fields: [orchLogId], references: [id])

  budgetItemId String?
  budgetItem   BudgetItem? @relation(fields: [budgetItemId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  @@index([executionId])
  @@index([budgetItemId])
  @@index([orchLogId])
  @@index([companyId])
  @@map("stock_transactions")
}

enum MachineryType {
  TRACTOR
  SPRAYER
  HARVESTER
  ATTACHMENT
  TRUCK
}

enum AssetStatus {
  ACTIVE
  REPAIR
  OFFLINE
  PENDING_CONFIRMATION
  REJECTED
  ARCHIVED
}

enum StockItemType {
  CHEMICAL
  FERTILIZER
  SEED
  FUEL
}

enum StockTransactionType {
  PROCUREMENT
  CONSUMPTION
  ADJUSTMENT
}

// --- User Management ---

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String?
  role       UserRole @default(USER)
  phone      String?
  telegramId String?  @unique

  emailVerified              Boolean   @default(false)
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?

  companyId String // ARCH-DEBT-001: Multi-tenancy (NOT NULL)
  company   Company  @relation(fields: [companyId], references: [id])
  accountId String?
  account   Account? @relation(fields: [accountId], references: [id])

  accessLevel   UserAccessLevel @default(DEMO)
  invitedBy     String? // ID того, кто пригласил
  invitedAt     DateTime?
  activatedAt   DateTime? // Когда активирован FULL доступ
  demoExpiresAt DateTime? // Срок демо-доступа (7 дней)

  // Связи
  invitations     Invitation[] @relation("Invitee")
  sentInvitations Invitation[] @relation("Inviter")

  // Business Core интеграция
  coreUserId   String? @unique
  coreWalletId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignedTasks       Task[]               @relation("TaskAssignee")
  responsibleTasks    Task[]               @relation("TaskResponsible")
  fieldObservations   FieldObservation[]
  managementDecisions ManagementDecision[]

  // HR & CMR Relations
  employeeProfile  EmployeeProfile?
  cmrDecisions     CmrDecision[]
  responsibleRisks CmrRisk[]        @relation("RiskResponsible")

  // Asset Accountability
  confirmedMachinery  Machinery[]        @relation("MachineryConfirmedBy")
  confirmedStockItems StockItem[]        @relation("StockItemConfirmedBy")
  stockTransactions   StockTransaction[]
  executionRecords    ExecutionRecord[]

  // CRM Relations
  obligations Obligation[] @relation("ObligationResponsible")

  // Level E: Regenerative Optimization
  soilMetrics       SoilMetric[]
  authoredOverrides OverrideRequest[]
  approvedOverrides OverrideRequest[] @relation("OverrideApprover")

  // Phase 2.5: Escalation Signatures
  governanceSignatures GovernanceSignature[]

  // Institutional Exploration Module (IEM)
  initiatedStrategicSignals StrategicSignal[] @relation("StrategicSignalInitiator")
  initiatedExplorationCases ExplorationCase[] @relation("ExplorationCaseInitiator")
  ownedExplorationCases     ExplorationCase[] @relation("ExplorationCaseOwner")
  facilitatedWarRooms       WarRoomSession[]  @relation("WarRoomFacilitator")
  warRoomDecisionEvents     WarRoomDecisionEvent[]
  initiatedRewardRecords    RewardRecord[]    @relation("RewardRecordInitiator")
  approvedRewardRecords     RewardRecord[]    @relation("RewardRecordApprover")

  @@map("users")
}

model Invitation {
  id String @id @default(cuid())

  // Идентификаторы инвайта
  token     String @unique // UUID для email ссылок
  shortCode String @unique // 6 цифр для Telegram

  // Получатель (один из двух обязателен)
  email      String? // Если инвайт по email
  telegramId String? // Если инвайт через TG PUSH

  // Отправитель и назначение
  inviterId String // Кто пригласил
  inviter   User   @relation("Inviter", fields: [inviterId], references: [id])

  inviteeId String? // Кого пригласили (если user уже есть)
  invitee   User?   @relation("Invitee", fields: [inviteeId], references: [id])

  // Параметры доступа
  role        UserRole // Роль в системе
  accessLevel UserAccessLevel @default(INVITED)

  // Привязка к структуре
  companyId String // В какую компанию
  company   Company  @relation(fields: [companyId], references: [id])
  clientId  String? // В какое хозяйство (опционально)
  client    Account? @relation(fields: [clientId], references: [id])

  // Статус и сроки
  status              InvitationStatus @default(PENDING)
  expiresAt           DateTime // Действует 72 часа
  createdAt           DateTime         @default(now())
  acceptedAt          DateTime? // Когда приняли
  activationIp        String? // IP адрес активации
  activationUserAgent String? // User-Agent при активации

  // Индексы
  @@index([token])
  @@index([shortCode])
  @@index([email])
  @@index([telegramId])
  @@index([status])
  @@index([expiresAt])
  @@index([inviterId])
  @@map("invitations")
}

// --- Agri Entities ---

// --- Agri Entities ---

model Field {
  id             String      @id @default(cuid())
  cadastreNumber String      @unique
  name           String?
  area           Float // в гектарах
  coordinates    Json // GeoJSON Polygon
  centroid       Json? // GeoJSON Point
  soilType       SoilType
  status         FieldStatus @default(ACTIVE)

  clientId String
  client   Account @relation(fields: [clientId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Business Core интеграция
  coreObjectId String? @unique

  seasons           Season[]
  tasks             Task[]
  fieldObservations FieldObservation[]
  harvestResults    HarvestResult[]
  techMaps          TechMap[]

  // Level E: Regenerative Optimization
  soilMetrics            SoilMetric[]
  sustainabilityBaseline SustainabilityBaseline?
  governanceLock         GovernanceLock?
  overrideRequests       OverrideRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coordinates])
  @@index([clientId])
  @@index([companyId])
  @@map("fields")
}

model Rapeseed {
  id           String       @id @default(cuid())
  name         String // Пшеница, кукуруза, рапс
  variety      String? // Сорт рапса
  reproduction String? // Репродукция (Элита, РС1, РС2)
  type         RapeseedType // Озимый, яровой

  oilContent     Float? // Масличность, %
  erucicAcid     Float? // Эруковая кислота, %
  glucosinolates Float? // Глюкозинолаты, мкмоль/г

  vegetationPeriod Int // Дней от посева до уборки
  sowingNormMin    Float? // кг/га мин
  sowingNormMax    Float? // кг/га макс
  sowingDepthMin   Float? // см мин
  sowingDepthMax   Float? // см макс

  // Версионирование параметров
  version  Int     @default(1)
  isLatest Boolean @default(true)

  companyId String? // Multi-tenancy (если NULL - системная культура)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seasons Season[]
  history RapeseedHistory[]

  @@unique([name, companyId, version]) // Уникальность имени в рамках компании и версии
  @@index([companyId])
  @@map("rapeseeds")
}

model RapeseedHistory {
  id           String   @id @default(cuid())
  rapeseedId   String
  rapeseed     Rapeseed @relation(fields: [rapeseedId], references: [id])
  version      Int
  changeReason String? // Почему изменили параметры
  changedBy    String? // User ID
  snapshot     Json // Полный слепок параметров

  createdAt DateTime @default(now())

  @@index([rapeseedId, version])
  @@map("rapeseed_history")
}

// --- Production Cycle & Planning ---

model Season {
  id     String       @id @default(cuid())
  year   Int
  status SeasonStatus @default(PLANNING)

  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])

  cropId     String? // BACKWARD COMPATIBILITY (Temporary)
  rapeseedId String
  rapeseed   Rapeseed @relation(fields: [rapeseedId], references: [id])

  technologyCardId String?
  technologyCard   TechnologyCard? @relation(fields: [technologyCardId], references: [id])

  // Yield Tracking
  expectedYield Float? // Ожидаемая урожайность (т/га)
  actualYield   Float? // Фактическая урожайность (т/га)

  // Immutable Pattern
  isLocked Boolean   @default(false)
  lockedAt DateTime?
  lockedBy String? // User ID

  startDate DateTime?
  endDate   DateTime?

  // Business Core интеграция
  coreProcessId String? @unique
  companyId     String // Denormalized for performance

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  currentStageId String? // ID текущего этапа (micro-state)
  stageProgress  SeasonStageProgress[]

  history           SeasonHistory[]
  snapshots         SeasonSnapshot[]
  tasks             Task[]
  fieldObservations FieldObservation[]

  harvestPlans HarvestPlan[]

  // Level E: Regenerative Optimization
  biodiversityMetric BiodiversityMetric?

  // Tech Map Integration
  techMaps         TechMap[]
  deviationReviews DeviationReview[]
  budgetPlans      BudgetPlan[]
  cmrDecisions     CmrDecision[]
  cmrRisks         CmrRisk[]
  harvestResults   HarvestResult[]
  strategicGoals   StrategicGoal[]

  @@index([id, companyId]) // Для быстрой валидации доступа
  @@index([fieldId, year]) // Для севооборота
  @@index([companyId, year]) // Для отчетов по годам
  @@index([companyId, status]) // Для дашбордов
  @@index([status, companyId]) // Для быстрых фильтров
  @@index([rapeseedId, companyId]) // Для фильтрации по тенанту
  @@map("seasons")
}

model SeasonSnapshot {
  id       String @id @default(cuid())
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  // Данные на момент фиксации
  year       Int
  status     SeasonStatus
  fieldId    String
  rapeseedId String

  expectedYield Float?
  actualYield   Float?

  startDate DateTime?
  endDate   DateTime?

  // Дополнительные метаданные
  snapshotData Json // Полный дамп всех связанных данных (удобрения, операции и т.д.)

  companyId String
  createdBy String // User ID
  createdAt DateTime @default(now())

  @@index([seasonId])
  @@index([companyId])
  @@index([createdAt])
  @@index([seasonId, createdAt])
  @@index([companyId, year])
  @@index([rapeseedId, year])
  @@map("season_snapshots")
}

model AuditFailure {
  id        String   @id @default(cuid())
  event     String
  userId    String?
  metadata  String   @db.Text
  error     String   @db.Text
  attempt   Int
  createdAt DateTime @default(now())

  @@map("audit_failures")
}

model SeasonStageProgress {
  id       String @id @default(cuid())
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  stageId     String // ID этапа (например, '04_SOWING')
  completedAt DateTime @default(now())

  metadata Json? // Факты и контекст этапа (влажность, дата посева и т.д.)

  @@index([seasonId])
  @@index([stageId])
  @@map("season_stage_progress")
}

model SeasonHistory {
  id       String @id @default(cuid())
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  action  String // CREATE, UPDATE, COMPLETE, LOCK, YIELD_UPDATE
  changes Json // Diff изменений

  userId    String?
  createdAt DateTime @default(now())

  @@index([seasonId])
  @@map("season_history")
}

// --- Business Rules ---

model BusinessRule {
  id          String  @id @default(cuid())
  code        String // UNIQUE_CODE (e.g. MIN_SEASON_LENGTH)
  name        String
  description String?

  params   Json // Параметры правила (числа, диапазоны)
  isActive Boolean      @default(true)
  severity RuleSeverity @default(ERROR) // ERROR, WARNING

  companyId String? // Если NULL - системное правило

  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code, companyId, version])
  @@map("business_rules")
}

// --- Existing Models ---

model TechnologyCard {
  id          String                    @id @default(cuid())
  name        String
  description String?
  operations  TechnologyCardOperation[]
  seasons     Season[]

  companyId String // Изоляция карт на уровне тенанта
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("technology_cards")
}

model TechnologyCardOperation {
  id               String         @id @default(cuid())
  name             String
  sequence         Int
  technologyCardId String
  technologyCard   TechnologyCard @relation(fields: [technologyCardId], references: [id])

  stageId   String? // Ссылка на этап APL (например, '04_SOWING')
  resources TechnologyCardResource[]

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks     Task[]

  @@index([technologyCardId])
  @@index([stageId])
  @@map("technology_card_operations")
}

model TechnologyCardResource {
  id          String                  @id @default(cuid())
  operationId String
  operation   TechnologyCardOperation @relation(fields: [operationId], references: [id])

  type   String // FERTILIZER, SEED, FUEL, CHEMICAL
  name   String // "Карбамид", "Рапс Озёрный"
  dosage Float // Количество
  unit   String // кг/га, л/га

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([operationId])
  @@map("technology_card_resources")
}

// --- Task Engine Models ---

model Task {
  id     String     @id @default(cuid())
  name   String
  status TaskStatus @default(PENDING)

  // Context
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  operationId String?
  operation   TechnologyCardOperation? @relation(fields: [operationId], references: [id])

  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])

  // Assignment
  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id])

  responsibleId String?
  responsible   User?   @relation("TaskResponsible", fields: [responsibleId], references: [id])

  // Dates
  plannedDate   DateTime?
  slaExpiration DateTime?
  completedAt   DateTime?

  // Tenant Isolation
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Actual Resources
  actualResources   TaskResourceActual[]
  fieldObservations FieldObservation[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  cmrRisks  CmrRisk[]

  @@index([seasonId])
  @@index([companyId])
  @@index([assigneeId])
  @@index([fieldId])
  @@map("tasks")
}

model TaskResourceActual {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id])

  type   String // FERTILIZER, SEED, FUEL, CHEMICAL
  name   String
  amount Float
  unit   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@map("task_resource_actuals")
}

// --- Enums ---

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum UserRole {
  ADMIN
  CEO
  MANAGER
  AGRONOMIST
  FIELD_WORKER
  CFO
  CLIENT_ADMIN
  USER
}

enum SoilType {
  CHERNOZEM
  LOAM
  SANDY
  CLAY
  PODZOLIC
  SODDY
  GRAY_FOREST
  CHESTNUT
}

enum FieldStatus {
  ACTIVE
  ARCHIVED
  IN_PROCESSING
}

enum RapeseedType {
  WINTER // Озимый
  SPRING // Яровой
}

enum SeasonStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RuleSeverity {
  ERROR
  WARNING
  INFO
}

enum UserAccessLevel {
  DEMO
  INVITED
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// --- Identity Registry Models ---

model EmployeeProfile {
  id String @id @default(cuid())

  // Link to external HRIS (1C:ZUP / etc)
  externalId String? @unique

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Management Context: Reference to structural unit (Department / Brigade / etc)
  orgUnitId String?

  // Org Position
  roleId String
  role   RoleDefinition @relation(fields: [roleId], references: [id])

  // Link to Development
  requiredRoleCompetencyRef String?

  // Multi-tenant Boundaries
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  holdingId String?
  clientId  String?

  // --- Contour 1: Foundation (Lifecycle Projects) ---
  onboardingPlan HrOnboardingPlan?
  supportCases   HrSupportCase[]

  // --- Contour 2: Incentive (Alignment) ---
  objectives        Objective[] // Owner of objective
  recognitionEvents HrRecognitionEvent[]
  rewardEvents      HrRewardEvent[]

  // --- Contour 3: Development (Strategic Signals) ---
  surveyResponses     SurveyResponse[]
  assessmentSnapshots HumanAssessmentSnapshot[]
  competencyStates    PersonalCompetencyState[]
  developmentPlan     HrDevelopmentPlan?

  // Identity lifecycle
  status LifecycleStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([roleId])
  @@map("employee_profiles")
}

model HrOnboardingPlan {
  id         String          @id @default(cuid())
  employeeId String          @unique
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  stages   Json // Array of { title: string, completed: boolean, dueDate: DateTime? }
  progress Float @default(0.0)

  startDate   DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hr_onboarding_plans")
}

model HrSupportCase {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  type    String // "ADMIN", "TECH", "WELLBEING"
  subject String
  status  String @default("OPEN")

  createdAt DateTime  @default(now())
  closedAt  DateTime?

  @@map("hr_support_cases")
}

model RoleDefinition {
  id          String  @id @default(cuid())
  name        String // e.g. "Chief Agronomist"
  description String?

  // Tenant Ownership
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  profiles EmployeeProfile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, companyId])
  @@map("role_definitions")
}

enum LifecycleStatus {
  ACTIVE
  ARCHIVED
  TERMINATED
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String // INVITATION_ACTIVATED, FIELD_CREATED, RAPESEED_ROTATION_VIOLATION
  userId    String?
  companyId String // Multi-tenancy requirement
  company   Company  @relation(fields: [companyId], references: [id])
  ip        String?
  userAgent String?
  metadata  Json? // Дополнительные детали
  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([companyId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ApiUsage {
  id     String   @id @default(cuid())
  userId String?
  ip     String?
  action String
  count  Int      @default(0)
  date   DateTime @default(now())

  @@unique([userId, action, date])
  @@unique([ip, action, date])
  @@map("api_usage")
}

model MemoryEntry {
  id         String                       @id @default(cuid())
  content    String
  embedding  Unsupported("vector(1536)")?
  metadata   Json?
  companyId  String
  memoryType String // CONTEXT | KNOWLEDGE | STRATEGY | PROCESS
  source     String // system | user | import | llm
  expiresAt  DateTime?
  createdAt  DateTime                     @default(now())

  @@index([companyId, memoryType])
  @@map("memory_entries")
}

// --- CRM Models ---

model Deal {
  id           String    @id @default(cuid())
  name         String
  stage        DealStage @default(LEAD)
  amount       Float     @default(0)
  probability  Float     @default(0)
  expectedDate DateTime?

  clientId String
  client   Account @relation(fields: [clientId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([clientId])
  @@map("crm_deals")
}

model ScoreCard {
  id       String  @id @default(cuid())
  clientId String  @unique
  client   Account @relation(fields: [clientId], references: [id])

  financialHealth Float? // 0-100 score
  agroPotential   Float? // Land bank * Productivity proxy
  reliability     Float? // History/Risk score
  ltvPrediction   Float? // 3-year projected revenue

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([companyId])
  @@map("crm_scorecards")
}

model Contract {
  id        String    @id @default(cuid())
  number    String
  type      String // SUPPLY, PURCHASE, SERVICE
  status    String // ACTIVE, COMPLETED, CANCELLED
  startDate DateTime
  endDate   DateTime?
  amount    Float?

  clientId String
  client   Account @relation(fields: [clientId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([clientId])
  @@map("crm_contracts")
}

// --- CRM Enums ---

enum ClientType {
  FARMER
  DEALER
  HOLDING
  PARTNER
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DealStage {
  LEAD
  QUALIFICATION
  OFFER
  CONTRACT
  CLOSED_WON
  CLOSED_LOST
}

// --- Harvest Management Domain (Strategic Consulting) ---

enum HarvestPlanStatus {
  DRAFT
  REVIEW
  APPROVED
  ACTIVE
  DONE
  ARCHIVE
}

model HarvestPlan {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  contextSnapshot Json? // Snapshot of conditions at planning
  targetMetric    String? // e.g. "YIELD_QPH"
  period          String? // e.g. "SEASON_2026"

  seasonId String?
  season   Season? @relation(fields: [seasonId], references: [id])

  minValue      Float?
  optValue      Float?
  maxValue      Float?
  baselineValue Float?

  status HarvestPlanStatus @default(DRAFT)

  techMaps            TechMap[]
  performanceContract PerformanceContract?

  activeTechMapId String?  @unique
  activeTechMap   TechMap? @relation("ActiveTechMap", fields: [activeTechMapId], references: [id])

  activeBudgetPlanId String?     @unique
  activeBudgetPlan   BudgetPlan? @relation("ActiveBudgetPlan", fields: [activeBudgetPlanId], references: [id])

  budgetPlans      BudgetPlan[]
  deviationReviews DeviationReview[]
  harvestResults   HarvestResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([accountId])
  @@map("harvest_plans")
}

model PerformanceContract {
  id String @id @default(cuid())

  harvestPlanId String      @unique
  harvestPlan   HarvestPlan @relation(fields: [harvestPlanId], references: [id])

  modelType        String // e.g. "FIXED", "SUCCESS_FEE"
  feeRules         Json?
  safetyNetRules   Json?
  settlementStatus String @default("PENDING")

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("harvest_performance_contracts")
}

// --- Tech Map Domain (Detailed Operational Planning) ---

model TechMap {
  id String @id @default(cuid())

  harvestPlanId String // Mandatory link per canon
  harvestPlan   HarvestPlan @relation(fields: [harvestPlanId], references: [id])

  seasonId String // Allowed multiple maps per season (versions)
  season   Season @relation(fields: [seasonId], references: [id])

  harvestPlanActive HarvestPlan? @relation("ActiveTechMap")

  crop String // Denormalization for uniqueness index

  stages MapStage[]

  // Metadata for AI Generation
  soilType  SoilType?
  moisture  Float? // Initial moisture %
  precursor String? // Предшественник

  approvedAt DateTime?

  // Snapshots for Production Gate (Immutable)
  operationsSnapshot    Json?
  resourceNormsSnapshot Json?

  // Level B: Generative Engine
  generationMetadata Json? // { modelId, modelVersion, generatedAt, seed, hash }
  generationRecordId String?           @unique
  generationRecord   GenerationRecord? @relation(fields: [generationRecordId], references: [id])

  status TechMapStatus @default(DRAFT)

  // Versioning
  version  Int     @default(1)
  isLatest Boolean @default(true)

  fieldId String // Denormalization for uniqueness index
  field   Field  @relation(fields: [fieldId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  budgetPlanSnapshots BudgetPlan[] @relation("BudgetPlanTechMapSnapshot")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fieldId, crop, seasonId, companyId, version])
  @@index([companyId])
  @@index([harvestPlanId])
  @@map("tech_maps")
}

model MapStage {
  id       String @id @default(cuid())
  name     String
  sequence Int

  techMapId String
  techMap   TechMap @relation(fields: [techMapId], references: [id])

  operations MapOperation[]

  // Integration with APL
  aplStageId String? // '04_SOWING' etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([techMapId])
  @@map("tech_map_stages")
}

model MapOperation {
  id          String  @id @default(cuid())
  name        String
  description String?

  mapStageId String
  mapStage   MapStage @relation(fields: [mapStageId], references: [id])

  // Detailed Planning
  plannedStartTime DateTime?
  plannedEndTime   DateTime?
  durationHours    Int?

  resources MapResource[]

  requiredMachineryType MachineryType?

  executionRecord ExecutionRecord?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mapStageId])
  @@map("tech_map_operations")
}

model MapResource {
  id             String       @id @default(cuid())
  mapOperationId String
  mapOperation   MapOperation @relation(fields: [mapOperationId], references: [id])

  type   String // FERTILIZER, etc.
  name   String
  amount Float
  unit   String

  costPerUnit Float? // Planned cost

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mapOperationId])
  @@map("tech_map_resources")
}

enum TechMapStatus {
  GENERATED_DRAFT
  DRAFT
  REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
  OVERRIDE_ANALYSIS // Level C: Анализ человеческого оверрайда (I29–I33)
}

// --- Level B: Agronomic Strategy Library ---

enum StrategyStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model AgronomicStrategy {
  id             String         @id @default(cuid())
  name           String
  description    String?
  cropId         String
  regionId       String?
  operations     Json // OperationTemplate[]
  constraints    Json // Constraint[]
  status         StrategyStatus @default(DRAFT)
  version        Int            @default(1)
  hash           String? // SHA-256(canonical(operations + constraints))
  publishedAt    DateTime?
  archivedAt     DateTime? // Soft-archive timestamp
  explainability Json?
  companyId      String
  company        Company        @relation(fields: [companyId], references: [id])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([name, companyId, version])
  @@index([companyId])
  @@index([cropId])
  @@map("agronomic_strategies")
}

// --- Level B: Generation Records (Immutable I28) ---

model GenerationRecord {
  id                   String   @id @default(cuid())
  techMap              TechMap?
  inputParams          Json // GenerationParams snapshot
  canonicalizedPayload Json // canonical(inputParams) — frozen
  modelId              String   @default("generative-engine-v1")
  modelVersion         String   @default("1.0.0")
  engineVersion        String   @default("1.0.0") // Frozen engine version
  seed                 String // SHA-256-derived seed string for determinism proof
  canonicalHash        String   @unique // SHA-256(canonical + modelVersion + seed) — UNIQUE
  result               String // 'SUCCESS' | 'FAILED'
  errorDetails         Json?
  explainability       Json?
  limitationsDisclosed Boolean  @default(true)
  companyId            String
  company              Company  @relation(fields: [companyId], references: [id])
  createdAt            DateTime @default(now())

  @@index([companyId])
  @@index([canonicalHash])
  @@index([createdAt])
  @@map("generation_records")
}

// --- Level C: Contradiction-Resilient Intelligence (I29–I33) ---

/// GovernanceConfig — Append-Only конфигурация весов DIS.
/// ИНВАРИАНТ I31: UPDATE/DELETE запрещены DB-триггером.
model GovernanceConfig {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  versionId   String   @unique // Уникальный ID версии конфига
  weights     Json // {w1, w2, w3, w4} — веса DIS
  description String?
  createdAt   DateTime @default(now())

  divergenceRecords DivergenceRecord[]

  @@index([companyId])
  @@map("governance_configs")
}

/// DivergenceRecord — Иммутабельный лог расхождений AI/Human.
/// ИНВАРИАНТ I31: Append-Only. UPDATE/DELETE запрещены DB-триггером.
/// ИНВАРИАНТ I32: explanation NOT NULL.
model DivergenceRecord {
  id               String           @id @default(cuid())
  companyId        String
  company          Company          @relation(fields: [companyId], references: [id])
  draftId          String
  draftVersion     Int
  disVersion       String // FK → GovernanceConfig.versionId
  governanceConfig GovernanceConfig @relation(fields: [disVersion], references: [versionId])
  weightsSnapshot  Json // Снимок весов на момент записи
  disScore         Float // Divergence Impact Score ∈ [0, 1]
  simulationHash   String // SHA256, 64 chars (I30)
  deltaRisk        Float // ΔRisk ∈ [-1, 1] (I29)
  conflictVector   Json // ConflictVector
  humanAction      Json // Что сделал человек
  explanation      String // I32: обязательно NOT NULL
  simulationMode   String // 'DETERMINISTIC' | 'MONTE_CARLO'
  idempotencyKey   String           @unique // SHA256(RFC8785(canonical))
  policyVersion    String? // Версия RiskEscalationPolicy
  createdAt        DateTime         @default(now())

  @@unique([draftId, draftVersion])
  @@index([companyId])
  @@index([createdAt])
  @@map("divergence_records")
}

enum ExecutionStatus {
  PLANNED
  IN_PROGRESS
  DONE
  MISSED
}

model ExecutionRecord {
  id String @id @default(cuid())

  operationId String       @unique
  operation   MapOperation @relation(fields: [operationId], references: [id])

  status      ExecutionStatus @default(PLANNED)
  plannedDate DateTime?
  actualDate  DateTime?

  performedById String?
  performedBy   User?   @relation(fields: [performedById], references: [id])

  notes   String? @db.Text
  version Int     @default(1) // Optimistic Locking

  // Phase 0: Execution Integrity Snapshots (Immutable Context)
  budgetPlanId   String? // Link to the budget plan active at the time of execution
  budgetVersion  Int? // Version of the budget plan active at the time of execution
  techMapId      String? // Link to the TechMap active at the time of execution
  techMapVersion Int? // Version of the TechMap active at the time of execution

  stockTransactions StockTransaction[]

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  ledgerEntries LedgerEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orchestrationLogs ExecutionOrchestrationLog[]

  @@index([companyId])
  @@map("consulting_execution_records")
}

model ExecutionOrchestrationLog {
  id          String          @id @default(cuid())
  executionId String
  execution   ExecutionRecord @relation(fields: [executionId], references: [id])

  event  String // e.g. "OperationCompleted"
  status String // "SUCCESS", "WARNING", "FAILURE"

  budgetApplied    Boolean @default(false)
  deviationCreated Boolean @default(false)

  warnings String[]
  error    String?  @db.Text

  metadata Json? // Context dump

  transactions StockTransaction[] // Audit Trail: what was created during this orchestration

  createdAt DateTime @default(now())

  @@index([executionId])
  @@map("consulting_execution_logs")
}

// --- Consulting Control Plane (CMR) ---

enum DeviationStatus {
  DETECTED
  ANALYZING
  DECIDED
  CLOSED
}

enum DeviationType {
  AGRONOMIC
  FINANCIAL
  OPERATIONAL
}

model DeviationReview {
  id   String        @id @default(cuid())
  type DeviationType @default(AGRONOMIC)

  // Context
  harvestPlanId String // Mandatory link to Plan per Phase 1 Refinement
  harvestPlan   HarvestPlan @relation(fields: [harvestPlanId], references: [id])

  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  stageId String? // Optional link to APL stage

  // Content
  deviationSummary   String // Fact vs Plan
  aiImpactAssessment String // Risk analysis
  techConclusion     String? // Agronomist's input
  proposedActions    String? // Correction plan

  // Traceability
  telegramThreadId String? // Link to specific discussion thread
  observations     FieldObservation[]

  // Client Interaction
  clientResponseStatus ClientResponseStatus @default(PENDING)
  clientComment        String?
  clientRespondedAt    DateTime?

  // Responsibility
  responsibilityMode ResponsibilityMode @default(SHARED)

  // SLA
  slaExpiration        DateTime?
  liabilityShiftStatus String? // "SHIFTED_TO_CLIENT", "SUSPENDED"

  status DeviationStatus @default(DETECTED)

  // Management Layer Integration
  budgetItemId String?
  budgetItem   BudgetItem? @relation(fields: [budgetItemId], references: [id])

  reasonCategory String? // e.g. "MARKET_PRICE_CHANGE", "WEATHER", "TECHNOLOGY_BREACH"
  severity       String  @default("MEDIUM") // LOW, MEDIUM, HIGH

  decisions ManagementDecision[]

  risks CmrRisk[]

  budgetPlanId String?
  budgetPlan   BudgetPlan? @relation(fields: [budgetPlanId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
  @@index([harvestPlanId])
  @@index([budgetPlanId])
  @@index([companyId])
  @@index([status])
  @@map("cmr_deviation_reviews")
}

model CmrDecision {
  id String @id @default(cuid())

  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  action String // e.g., "ADJUST_SOWING_DATE"
  reason String
  actor  String // AI, MANAGER, CLIEN

  // Strategic Amplifiers
  confidenceLevel ConfidenceLevel @default(HIGH)
  alternatives    Json? // Counterfactuals

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  // Strict Ownership
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@index([seasonId])
  @@index([userId])
  @@map("cmr_decisions")
}

model CmrRisk {
  id String @id @default(cuid())

  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  type        RiskType
  description String

  probability RiskLevel // LOW, MEDIUM, HIGH
  impact      RiskLevel // LOW, MEDIUM, HIGH

  controllability Controllability // WHO controls this risk?
  liabilityMode   LiabilityMode // WHO pays for it?

  mitigationPlan String?

  // Link to Deviation Review (if this risk triggered a review)
  deviationReviewId String?
  deviationReview   DeviationReview? @relation(fields: [deviationReviewId], references: [id])

  budgetPlanId String?
  budgetPlan   BudgetPlan? @relation(fields: [budgetPlanId], references: [id])

  status String // OPEN, MITIGATED, REALIZED

  // Traceability (Law Requirement)
  taskId        String?
  task          Task?             @relation(fields: [taskId], references: [id])
  observationId String?
  observation   FieldObservation? @relation(fields: [observationId], references: [id])
  responsibleId String?
  responsible   User?             @relation("RiskResponsible", fields: [responsibleId], references: [id])

  // Insurance
  insuranceId String?
  insurance   InsuranceCoverage? @relation(fields: [insuranceId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
  @@index([type])
  @@index([taskId])
  @@index([observationId])
  @@index([responsibleId])
  @@index([insuranceId])
  @@map("cmr_risks")
}

model InsuranceCoverage {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  insurer String // Name of insurance company
  type    InsuranceType

  status String // ACTIVE, CLAIMED, EXPIRED

  insuredAmount Float
  deductible    Float?

  startDate DateTime
  endDate   DateTime

  // Risks covered by this policy
  coveredRisks CmrRisk[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("cmr_insurance_coverages")
}

// --- CMR Enums ---

enum RiskType {
  AGRONOMIC
  CLIMATE
  OPERATIONAL
  REGULATORY
  MARKET
}

enum Controllability {
  CONSULTANT
  CLIENT
  SHARED
  FORCE_MAJEURE
}

enum LiabilityMode {
  CONSULTANT_ONLY
  CLIENT_ONLY
  SHARED
  INSURABLE
  LIABILITY_SUSPENDED
}

enum InsuranceType {
  YIELD_LOSS
  WEATHER_INDEX
  REGULATORY
}

enum ResponsibilityMode {
  SHARED
  CLIENT_ONLY
  CONSULTANT_ONLY
  LIABILITY_SUSPENDED
}

enum ClientResponseStatus {
  PENDING
  AGREED
  DISAGREED
  IGNORED
}

// ReviewStatus decommissioned in favor of DeviationStatus

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

// --- Field Observation (Integrity Sensory Plane) ---

model FieldObservation {
  id              String            @id @default(cuid())
  type            ObservationType
  intent          ObservationIntent @default(MONITORING)
  integrityStatus IntegrityStatus   @default(NO_EVIDENCE)

  // Evidence Content
  content       String? @db.Text // Quantitative/Manual entry
  photoUrl      String?
  voiceUrl      String?
  telemetryJson Json? // GPS path, etc.
  coordinates   Json? // GeoJSON Point

  // Integrity Traceability (Ariadne's Thread)
  taskId   String?
  task     Task?   @relation(fields: [taskId], references: [id])
  fieldId  String?
  field    Field?  @relation(fields: [fieldId], references: [id])
  seasonId String
  season   Season  @relation(fields: [seasonId], references: [id])

  deviationReviewId String?
  deviationReview   DeviationReview? @relation(fields: [deviationReviewId], references: [id])

  budgetPlanId String?
  budgetPlan   BudgetPlan? @relation(fields: [budgetPlanId], references: [id])

  // Ownership
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  cmrRisks  CmrRisk[]

  @@index([companyId])
  @@index([seasonId])
  @@index([fieldId])
  @@index([taskId])
  @@index([deviationReviewId])
  @@index([budgetPlanId])
  @@index([authorId])
  @@index([type])
  @@index([intent])
  @@map("field_observations")
}

enum ObservationType {
  PHOTO
  GEO_WALK
  VOICE_NOTE
  CALL_LOG
  MEASUREMENT
  SOS_SIGNAL
}

enum ObservationIntent {
  MONITORING
  INCIDENT
  CONSULTATION
  CALL
  CONFIRMATION
  DELAY
}

enum IntegrityStatus {
  STRONG_EVIDENCE
  WEAK_EVIDENCE
  NO_EVIDENCE
}

// ==========================================
// BLOCK 5.2: HR CONTROL PLANE (Canon)
// ==========================================

// ==========================================
// BLOCK 5.2: HR CONTROL PLANE (Canon 3-Contour)
// ==========================================

// ------------------------------------------
// CONTOUR 2: INCENTIVE LAYER (Alignment)
// ------------------------------------------

model OkrCycle {
  id         String      @id @default(cuid())
  title      String
  startDate  DateTime
  endDate    DateTime
  status     String      @default("ACTIVE")
  companyId  String
  company    Company     @relation(fields: [companyId], references: [id])
  objectives Objective[]

  @@map("hr_okr_cycles")
}

model Objective {
  id         String           @id @default(cuid())
  title      String
  cycleId    String
  cycle      OkrCycle         @relation(fields: [cycleId], references: [id])
  ownerId    String?
  owner      EmployeeProfile? @relation(fields: [ownerId], references: [id])
  progress   Float            @default(0.0)
  keyResults KeyResult[]
  createdAt  DateTime         @default(now())

  @@map("hr_objectives")
}

model KeyResult {
  id           String    @id @default(cuid())
  title        String
  objectiveId  String
  objective    Objective @relation(fields: [objectiveId], references: [id])
  targetValue  Float
  currentValue Float     @default(0.0)
  metricSource String?
  lastUpdated  DateTime  @updatedAt

  @@map("hr_key_results")
}

model HrKPIIndicator {
  id          String   @id @default(cuid())
  externalKey String // e.g. "YIELD_PER_HA"
  title       String
  value       Float
  capturedAt  DateTime @default(now())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  @@map("hr_kpi_indicators")
}

model HrRecognitionEvent {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])
  type       String // "PEER", "MANAGER", "SYSTEM"
  message    String
  createdAt  DateTime        @default(now())

  @@map("hr_recognition_events")
}

model HrRewardEvent {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])
  type       String // "BONUS", "EQUITY", "PERK"
  amount     Float?
  reason     String
  createdAt  DateTime        @default(now())

  @@map("hr_reward_events")
}

// ------------------------------------------
// CONTOUR 3: DEVELOPMENT LAYER (Strategic)
// ------------------------------------------

model PulseSurvey {
  id        String           @id @default(cuid())
  title     String
  questions Json
  status    String           @default("DRAFT")
  startDate DateTime?
  endDate   DateTime?
  companyId String
  company   Company          @relation(fields: [companyId], references: [id])
  responses SurveyResponse[]
  createdAt DateTime         @default(now())

  @@map("hr_pulse_surveys")
}

model SurveyResponse {
  id            String          @id @default(cuid())
  pulseSurveyId String
  pulseSurvey   PulseSurvey     @relation(fields: [pulseSurveyId], references: [id])
  respondentId  String
  respondent    EmployeeProfile @relation(fields: [respondentId], references: [id])
  answers       Json // Immutable
  submittedAt   DateTime        @default(now())

  @@index([pulseSurveyId])
  @@map("hr_survey_responses")
}

model HumanAssessmentSnapshot {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  burnoutRisk      RiskLevel
  engagementLevel  Float // 0.0 - 1.0
  ethicalAlignment Float // 0.0 - 1.0
  controllability  Float // 0.0 - 1.0 (Consumed by CMR)
  confidenceLevel  Float     @default(1.0) // 0.0 - 1.0 (Probabilistic accuracy)

  validFrom DateTime  @default(now())
  validTo   DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@map("hr_human_assessment_snapshots")
}

model PersonalCompetencyState {
  id           String          @id @default(cuid())
  employeeId   String
  employee     EmployeeProfile @relation(fields: [employeeId], references: [id])
  competencyId String // Ref to definition
  level        Float // current mastery
  updatedAt    DateTime        @updatedAt

  @@map("hr_competency_states")
}

model HrDevelopmentPlan {
  id         String                @id @default(cuid())
  employeeId String                @unique
  employee   EmployeeProfile       @relation(fields: [employeeId], references: [id])
  actions    HrDevelopmentAction[]
  createdAt  DateTime              @default(now())

  @@map("hr_development_plans")
}

model HrDevelopmentAction {
  id          String            @id @default(cuid())
  planId      String
  plan        HrDevelopmentPlan @relation(fields: [planId], references: [id])
  type        String // "MENTORSHIP", "TRAINING", "ENV_CHANGE"
  description String
  status      String            @default("PLANNED")
  createdAt   DateTime          @default(now())

  @@map("hr_development_actions")
}

// ==========================================
// BLOCK B3: FINANCE & ECONOMY (CFO Control Plane)
// ==========================================

enum EconomicEventType {
  COST_INCURRED
  REVENUE_RECOGNIZED
  OBLIGATION_CREATED
  OBLIGATION_SETTLED
  RESERVE_ALLOCATED
  ADJUSTMENT
  BOOTSTRAP // Phase 5: Initial balance support
  OTHER
}

enum BudgetStatus {
  DRAFT
  APPROVED
  LOCKED
  ACTIVE
  EXHAUSTED
  BLOCKED
  CLOSED
}

enum TenantMode {
  ACTIVE
  READ_ONLY
  HALTED
}

model TenantState {
  companyId String     @id
  company   Company    @relation(fields: [companyId], references: [id])
  mode      TenantMode @default(ACTIVE)

  updatedAt DateTime @updatedAt

  @@map("tenant_states")
}

model EconomicEvent {
  id        String            @id @default(cuid())
  type      EconomicEventType
  currency  String            @default("RUB")
  replayKey String?
  metadata  Json? // Source data (taskId, employeeId, techMapId, etc.)

  // Attribution Context
  fieldId    String?
  seasonId   String?
  employeeId String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  ledgerEntries LedgerEntry[]

  createdAt DateTime @default(now())

  @@unique([companyId, id])
  @@unique([companyId, replayKey])
  @@index([companyId])
  @@index([type])
  @@index([seasonId])
  @@index([fieldId])
  @@index([employeeId])
  @@map("economic_events")
}

model LedgerEntry {
  id             String @id @default(cuid())
  sequenceNumber Int    @default(1)

  economicEventId String
  economicEvent   EconomicEvent @relation(fields: [economicEventId], references: [id])

  amount      Decimal @db.Decimal(18, 4)
  type        String // DEBIT / CREDIT
  accountCode String // Chart of Accounts (CoA) mapping

  // Tenant & Context
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // Phase 2.3: Traceability
  executionId String?
  execution   ExecutionRecord? @relation(fields: [executionId], references: [id])

  // Phase 5: Cash Flow Projection
  cashFlowType  CashFlowType?
  cashImpact    Boolean        @default(false)
  cashDirection CashDirection?
  dueDate       DateTime? // Projection timeline
  cashAccountId String?
  cashAccount   CashAccount?   @relation(fields: [cashAccountId], references: [id])

  isImmutable Boolean @default(true) // Derived fact projection

  createdAt DateTime @default(now())

  @@unique([economicEventId, sequenceNumber])
  @@index([companyId])
  @@index([accountCode])
  @@index([cashAccountId])
  @@index([executionId])
  @@map("ledger_entries")
}

model AccountBalance {
  companyId   String
  accountCode String
  balance     Decimal  @default(0) @db.Decimal(18, 4)
  updatedAt   DateTime @default(now()) @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@id([companyId, accountCode])
  @@map("account_balances")
}

model CashAccount {
  id       String  @id @default(uuid())
  name     String // e.g. "Main Sberbank", "Petty Cash"
  balance  Decimal @default(0) @db.Decimal(18, 4)
  version  Int     @default(1)
  currency String  @default("RUB")
  isActive Boolean @default(true)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  ledgerEntries LedgerEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("consulting_cash_accounts")
}

enum CashFlowType {
  OPERATING
  INVESTING
  FINANCING
}

enum CashDirection {
  INFLOW
  OUTFLOW
}

model Budget {
  id        String  @id @default(cuid())
  name      String
  limit     Decimal @db.Decimal(18, 4)
  consumed  Decimal @default(0) @db.Decimal(18, 4)
  remaining Decimal @default(0) @db.Decimal(18, 4)

  status BudgetStatus @default(DRAFT)

  periodStart DateTime
  periodEnd   DateTime

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  lines BudgetLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("budgets")
}

model BudgetLine {
  id       String @id @default(cuid())
  budgetId String
  budget   Budget @relation(fields: [budgetId], references: [id])

  category String // e.g. "FUEL", "FERTILIZER"
  limit    Float
  consumed Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("budget_lines")
}

// --- Legal & GR Models ---

model RegulatoryBody {
  id          String        @id @default(cuid())
  name        String
  description String?
  type        RegulatorType

  // Power & Scope
  scope     String? @db.Text
  powers    String? @db.Text
  sanctions String? @db.Text

  // Multi-tenancy (Monitoring context)
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  documents    LegalDocument[]
  interactions GrInteraction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("regulatory_bodies")
}

model LegalDocument {
  id             String       @id @default(cuid())
  title          String
  externalId     String? // Номер акта, например "ФЗ-123"
  type           DocumentType
  sourceUrl      String?
  effectiveDate  DateTime?
  expirationDate DateTime?
  version        String       @default("1.0")

  // Relationships
  regulatorId String?
  regulator   RegulatoryBody? @relation(fields: [regulatorId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  norms         LegalNorm[]
  externalFeeds ExternalLegalFeed[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([externalId])
  @@index([regulatorId])
  @@map("legal_documents")
}

model LegalNorm {
  id         String        @id @default(cuid())
  documentId String
  document   LegalDocument @relation(fields: [documentId], references: [id])

  paragraph String // Номер статьи/пункта
  content   String @db.Text

  requirements LegalRequirement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
  @@map("legal_norms")
}

model LegalRequirement {
  id     String    @id @default(cuid())
  normId String
  norm   LegalNorm @relation(fields: [normId], references: [id])

  summary String           @db.Text // Интерпретация нормы
  type    RequirementType
  status  ComplianceStatus @default(UNKNOWN)

  // Impact Mapping (Dynamic Context)
  targetType ImpactTargetType // CONTRACT, HR_POLICY, TRANSACTION, etc.

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  obligations      LegalObligation[]
  complianceChecks ComplianceCheck[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
  @@map("legal_requirements")
}

model LegalObligation {
  id            String           @id @default(cuid())
  requirementId String
  requirement   LegalRequirement @relation(fields: [requirementId], references: [id])

  description String                @db.Text
  dueDate     DateTime?
  ownerId     String? // User ID или Role ID
  status      LegalObligationStatus @default(PENDING)

  sanctions Sanction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requirementId])
  @@index([ownerId])
  @@map("legal_obligations")
}

model Sanction {
  id           String          @id @default(cuid())
  obligationId String
  obligation   LegalObligation @relation(fields: [obligationId], references: [id])

  type        SanctionType
  amount      Decimal?     @db.Decimal(18, 2) // Повышенная точность для штрафов
  description String?      @db.Text

  createdAt DateTime @default(now())

  @@map("legal_sanctions")
}

model ComplianceCheck {
  id            String           @id @default(cuid())
  requirementId String
  requirement   LegalRequirement @relation(fields: [requirementId], references: [id])

  status                ComplianceStatus
  observation           String?          @db.Text
  confidenceLevel       Float            @default(1.0)
  checkedAgainstVersion String? // Версионирование проверки (ссылка на LegalDocument.version)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  checkedAt DateTime @default(now())

  @@index([companyId])
  @@index([requirementId])
  @@map("compliance_checks")
}

model GrInteraction {
  id          String         @id @default(cuid())
  regulatorId String
  regulator   RegulatoryBody @relation(fields: [regulatorId], references: [id])

  type    GrInteractionType
  subject String
  content String?           @db.Text
  date    DateTime

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([regulatorId])
  @@map("gr_interactions")
}

model PolicySignal {
  id           String      @id @default(cuid())
  subject      String
  description  String?     @db.Text
  probability  Float       @default(0.5)
  impactLevel  ImpactLevel
  expectedDate DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@map("policy_signals")
}

model ExternalLegalFeed {
  id         String        @id @default(cuid())
  documentId String
  document   LegalDocument @relation(fields: [documentId], references: [id])

  source      String // GIGALEGAL, GARANT, PRAVO_GOV
  externalRef String?
  rawContent  Json
  lastSync    DateTime @default(now())

  @@map("external_legal_feeds")
}

// --- Legal & GR Enums ---

enum RegulatorType {
  FISCAL // Налоговая, Таможня
  SUPERVISORY // Россельхознадзор, Санэпидем
  EXECUTIVE // Минсельхоз, Исполкомы
  LEGISLATIVE // Парламент
  ASSOCIATION // Отраслевые союзы
}

enum DocumentType {
  STATUTORY_LAW // Законы
  REGULATION // Постановления, Приказы
  TECHNICAL_NORM // ГОСТ, Техрегламенты
  CONTRACT // Договоры
  JUDICIAL_ACT // Судебная практика
}

enum RequirementType {
  MANDATORY
  RESTRICTIVE
  PERMISSIVE
  PROHIBITIVE
}

enum ComplianceStatus {
  COMPLIANT
  AT_RISK
  VIOLATED
  UNKNOWN
}

enum ImpactTargetType {
  CONTRACT
  SEASON
  TRANSACTION
  EMPLOYEE
  LAND_PARCEL
  RND_EXPERIMENT
  RND_PROTOCOL
}

enum LegalObligationStatus {
  PENDING
  COMPLETED
  OVERDUE
  WAIVED
}

enum SanctionType {
  PENALTY
  FINE
  LICENSE_REVOCATION
  SUSPENSION
  REPUTATIONAL
}

enum GrInteractionType {
  MEETING
  INSPECTION
  LETTER
  WORKING_GROUP
}

enum ImpactLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// --- R&D Engine Enums ---

enum ProgramStatus {
  ACTIVE
  COMPLETED
  SUSPENDED
  ARCHIVED
}

enum ExperimentState {
  IDEA
  HYPOTHESIS_DEFINED
  PROTOCOL_DRAFT
  SCIENTIFIC_REVIEW
  LEGAL_APPROVAL
  EXPERIMENT_APPROVED
  RUNNING
  DATA_COLLECTION
  ANALYSIS
  PEER_REVIEW
  CONCLUSION_ISSUED
  ARCHIVED
}

enum ProtocolStatus {
  DRAFT
  REVIEW
  APPROVED
  SUPERSEDED
}

enum ExperimentType {
  DRUG
  TECH
  METHOD
  COMPARATIVE
  FIELD
  METRIC
}

enum MeasurementSource {
  SENSOR
  MANUAL
  LAB
}

// --- R&D Engine Models ---

model ResearchProgram {
  id          String        @id @default(cuid())
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id])
  name        String
  objective   String        @db.Text
  hypothesis  String?       @db.Text
  status      ProgramStatus
  createdAt   DateTime      @default(now())
  archivedAt  DateTime?
  experiments Experiment[]

  @@index([companyId])
  @@map("research_programs")
}

model Experiment {
  id               String          @id @default(cuid())
  programId        String
  program          ResearchProgram @relation(fields: [programId], references: [id])
  name             String
  type             ExperimentType
  state            ExperimentState
  activeProtocolId String?         @unique
  protocol         Protocol?       @relation("ActiveProtocol", fields: [activeProtocolId], references: [id])

  protocols  Protocol[]          @relation("ExperimentProtocols")
  trials     Trial[]
  result     ResearchResult?
  conclusion ResearchConclusion?

  createdAt DateTime @default(now())

  @@index([programId])
  @@map("experiments")
}

model Protocol {
  id              String         @id @default(cuid())
  experimentId    String
  experiment      Experiment     @relation("ExperimentProtocols", fields: [experimentId], references: [id])
  version         Int
  methodology     Json
  variables       Json
  successCriteria Json
  status          ProtocolStatus @default(DRAFT)
  approvedAt      DateTime?
  approvedBy      String? // JSON или строка подписей

  activeInExperiment Experiment? @relation("ActiveProtocol")

  createdAt DateTime @default(now())

  @@unique([experimentId, version])
  @@map("research_protocols")
}

model Trial {
  id           String        @id @default(cuid())
  experimentId String
  experiment   Experiment    @relation(fields: [experimentId], references: [id])
  location     String?
  conditions   String?       @db.Text
  startDate    DateTime
  endDate      DateTime?
  deviations   String?       @db.Text // Отклонения от протокола
  measurements Measurement[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([experimentId])
  @@map("research_trials")
}

model Measurement {
  id         String   @id @default(cuid())
  trialId    String
  trial      Trial    @relation(fields: [trialId], references: [id])
  variable   String
  value      Float
  unit       String
  measuredAt DateTime @default(now())
  locked     Boolean  @default(false)

  @@index([trialId])
  @@map("research_measurements")
}

model ResearchResult {
  id           String     @id @default(cuid())
  experimentId String     @unique
  experiment   Experiment @relation(fields: [experimentId], references: [id])
  analysis     Json
  significance Float?
  createdAt    DateTime   @default(now())

  @@map("research_results")
}

model ResearchConclusion {
  id            String     @id @default(cuid())
  experimentId  String     @unique
  experiment    Experiment @relation(fields: [experimentId], references: [id])
  conclusion    String     @db.Text
  applicability Json
  limitations   String?    @db.Text
  createdAt     DateTime   @default(now())

  @@map("research_conclusions")
}

// --- Knowledge Graph (Sprint 2 / MVP) ---

model KnowledgeNode {
  id     String              @id @default(cuid())
  type   KnowledgeNodeType
  label  String
  source KnowledgeNodeSource

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  outgoingEdges KnowledgeEdge[] @relation("KnowledgeEdgeFrom")
  incomingEdges KnowledgeEdge[] @relation("KnowledgeEdgeTo")

  @@index([companyId])
  @@index([type])
  @@map("knowledge_nodes")
}

model KnowledgeEdge {
  id         String                @id @default(cuid())
  fromNodeId String
  toNodeId   String
  relation   KnowledgeEdgeRelation
  confidence Float
  source     KnowledgeEdgeSource

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  fromNode KnowledgeNode @relation("KnowledgeEdgeFrom", fields: [fromNodeId], references: [id])
  toNode   KnowledgeNode @relation("KnowledgeEdgeTo", fields: [toNodeId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([fromNodeId])
  @@index([toNodeId])
  @@map("knowledge_edges")
}

enum KnowledgeNodeType {
  CONCEPT
  ENTITY
  METRIC
  DOCUMENT
}

enum KnowledgeNodeSource {
  MANUAL
  INGESTION
  AI
}

enum KnowledgeEdgeRelation {
  IMPLEMENTS
  DEPENDS_ON
  MEASURED_BY
  MEASURES
  REFERENCES
}

enum KnowledgeEdgeSource {
  MANUAL
  INGESTION
  AI
}

// --- Vision AI Baseline (Sprint 2) ---

model VisionObservation {
  id          String                    @id @default(cuid())
  source      VisionObservationSource
  assetId     String
  timestamp   DateTime
  modality    VisionObservationModality
  rawFeatures Json?
  metadata    Json?
  confidence  Float

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([assetId])
  @@index([timestamp])
  @@index([source])
  @@index([modality])
  @@map("vision_observations")
}

enum VisionObservationSource {
  SATELLITE
  DRONE
  PHOTO
}

enum VisionObservationModality {
  RGB
  MULTISPECTRAL
}

// --- Satellite Ingestion (Sprint 2) ---

model SatelliteObservation {
  id            String             @id @default(cuid())
  assetId       String
  timestamp     DateTime
  indexType     SatelliteIndexType
  value         Float
  source        SatelliteSource
  resolution    Float
  cloudCoverage Float
  tileId        String?
  confidence    Float

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([assetId])
  @@index([timestamp])
  @@index([indexType])
  @@index([source])
  @@map("satellite_observations")
}

enum SatelliteIndexType {
  NDVI
  NDRE
}

enum SatelliteSource {
  SENTINEL2
  LANDSAT8
  LANDSAT9
}

// --- Risk Engine Models (B6) ---

model RiskSignal {
  id          String       @id @default(cuid())
  source      RiskSource
  severity    RiskSeverity
  reasonCode  String
  description String?      @db.Text

  referenceType RiskReferenceType
  referenceId   String

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([source])
  @@map("risk_signals")
}

model RiskAssessment {
  id         String         @id @default(cuid())
  targetType RiskTargetType
  targetId   String

  verdict     RiskVerdict
  score       Int?
  explanation Json

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  assessedAt DateTime @default(now())

  @@index([companyId])
  @@index([verdict])
  @@map("risk_assessments")
}

model RiskStateHistory {
  id         String         @id @default(cuid())
  targetType RiskTargetType
  targetId   String

  fromState RiskFsmState
  toState   RiskFsmState
  reason    String?      @db.Text

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([targetId])
  @@map("risk_state_history")
}

model DecisionRecord {
  id         String @id @default(cuid())
  actionType String // e.g., START_SEASON, SCALE_TECH
  targetId   String

  riskVerdict RiskVerdict
  riskState   RiskFsmState
  explanation Json // Snapshot of RiskAssessment.explanation

  traceId String? // Correlation ID

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  decidedAt DateTime @default(now())

  @@index([companyId])
  @@index([actionType])
  @@index([targetId])
  @@map("decision_records")
}

enum RiskSource {
  LEGAL
  RND
  OPS
  FINANCE
  REGENERATIVE
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskVerdict {
  ALLOWED
  CONDITIONAL
  RESTRICTED
  BLOCKED
}

enum RiskFsmState {
  CLEAR
  OBSERVED
  ELEVATED
  CRITICAL
  BLOCKED
  RESOLVED
}

enum RiskTargetType {
  ACTION
  TECHNOLOGY
  CLIENT
  SEASON
}

enum RiskReferenceType {
  EXPERIMENT
  REQUIREMENT
  TASK
  TRANSACTION
}

// ==========================================
// TRACK 2: BUDGET VERTICAL SLICE
// ==========================================

enum BudgetType {
  OPERATIONAL
  ADMINISTRATIVE
}

model BudgetPlan {
  id String @id @default(cuid())

  harvestPlanId String
  harvestPlan   HarvestPlan @relation(fields: [harvestPlanId], references: [id])

  harvestPlanActive HarvestPlan? @relation("ActiveBudgetPlan")

  version Int          @default(1)
  type    BudgetType   @default(OPERATIONAL)
  status  BudgetStatus @default(DRAFT)

  totalPlannedAmount Decimal @db.Decimal(18, 4)
  totalActualAmount  Decimal @default(0) @db.Decimal(18, 4)

  techMapSnapshotId String?
  techMapSnapshot   TechMap? @relation("BudgetPlanTechMapSnapshot", fields: [techMapSnapshotId], references: [id])

  items BudgetItem[]

  // Traceability
  deviationReviews DeviationReview[]
  risks            CmrRisk[]
  observations     FieldObservation[]

  // Phase 0: Integrity Invariants
  derivationHash String? // SHA-256 hash of (ActiveTechMap + Prices + Rules)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([harvestPlanId, version])
  @@index([companyId])
  @@index([harvestPlanId])
  @@map("consulting_budget_plans")
}

model OutboxMessage {
  id            String       @id @default(uuid())
  type          String // finance.economic_event.created
  aggregateId   String? // For event ordering/traceability
  aggregateType String? // For context (e.g. ExecutionRecord)
  payload       Json
  status        OutboxStatus @default(PENDING)
  attempts      Int          @default(0)
  nextRetryAt   DateTime?
  lastAttemptAt DateTime?
  deadLetterAt  DateTime?
  error         String?      @db.Text
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([status, nextRetryAt, createdAt])
  @@map("outbox_messages")
}

model EventConsumption {
  id          String   @id @default(cuid())
  consumer    String
  eventId     String
  eventType   String
  aggregateId String?
  companyId   String?
  processedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@unique([consumer, eventId])
  @@index([consumer, eventType, processedAt])
  @@index([companyId, processedAt])
  @@map("event_consumptions")
}

enum OutboxStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

model BudgetItem {
  id           String     @id @default(cuid())
  budgetPlanId String
  budgetPlan   BudgetPlan @relation(fields: [budgetPlanId], references: [id])

  category      BudgetCategory
  plannedNorm   Decimal        @default(0) @db.Decimal(18, 4) // Snapshot from TechMap at generation
  plannedPrice  Decimal        @default(0) @db.Decimal(18, 4) // Snapshot from Registry at generation
  plannedAmount Decimal        @db.Decimal(18, 4)
  actualAmount  Decimal        @default(0) @db.Decimal(18, 4)

  stockTransactions StockTransaction[]

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  deviationReviews DeviationReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([budgetPlanId])
  @@map("consulting_budget_items")
}

model ManagementDecision {
  id           String               @id @default(uuid())
  version      Int                  @default(1)
  supersedesId String?
  supersedes   ManagementDecision?  @relation("DecisionHistory", fields: [supersedesId], references: [id])
  history      ManagementDecision[] @relation("DecisionHistory")

  status      DecisionStatus @default(DRAFT)
  confirmedAt DateTime?

  deviationId String
  deviation   DeviationReview @relation(fields: [deviationId], references: [id])

  description    String  @db.Text
  expectedEffect String? @db.Text

  // Security & Versioning Hardening
  isActive     Boolean? // null for history, true for active version
  decisionHash String? // payload digest for tamper detection

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([deviationId, version])
  @@unique([deviationId, isActive]) // Multi-bypass protection: only one active decision per deviation
  @@map("consulting_management_decisions")
}

enum DecisionStatus {
  DRAFT
  CONFIRMED
  SUPERSEDED
}

enum BudgetCategory {
  SEEDS
  FERTILIZER
  FUEL
  LABOR
  MACHINERY
  OTHER
}

model HarvestResult {
  id        String      @id @default(cuid())
  planId    String
  plan      HarvestPlan @relation(fields: [planId], references: [id])
  seasonId  String
  season    Season      @relation(fields: [seasonId], references: [id])
  companyId String
  company   Company     @relation(fields: [companyId], references: [id])

  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])
  crop    String

  plannedYield Decimal? @db.Decimal(18, 4) // ц/га
  actualYield  Decimal? @db.Decimal(18, 4) // ц/га

  harvestedArea Decimal? @db.Decimal(18, 4) // га
  totalOutput   Decimal? @db.Decimal(18, 4) // тонн
  marketPrice   Decimal? @db.Decimal(18, 4) // цена реализации за тонну

  // Budget Snapshot at Harvest (Fix: Deterministic KPI)
  costSnapshot  Decimal? @db.Decimal(18, 4) // фактические затраты на момент фиксации урожая
  budgetPlanId  String? // ссылка на план, с которого снят снепшот
  budgetVersion Int? // версия бюджета

  qualityClass String?
  harvestDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId, seasonId, companyId])
  @@index([fieldId])
  @@map("harvest_results")
}

// --- Phase 4: Strategic Feedback Loop ---

model StrategicGoal {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  seasonId  String
  season    Season  @relation(fields: [seasonId], references: [id])

  goalType    GoalType
  targetValue Decimal  @db.Decimal(18, 4)

  // Versioning & Lifecycle
  version      Int        @default(1)
  supersedesId String? // Link to previous version
  status       GoalStatus @default(DRAFT)

  description String? @db.Text

  // Security & Conflict Protection
  isActive    Boolean? // null for history, true for the active guidance
  activatedAt DateTime?
  archivedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, seasonId, goalType, isActive]) // Protection: Only one active goal of a type per season
  @@map("consulting_strategic_goals")
}

enum GoalType {
  EBITDA_TARGET
  ROI_TARGET
  COST_LIMIT
  YIELD_TARGET
}

enum GoalStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// --- Level D: Adaptive Self-Learning Domain ---

model ModelVersion {
  id         String      @id @default(cuid())
  name       String
  version    Int
  hash       String      @unique // SHA256
  parentHash String? // Lineage chain
  signature  String // Ed25519
  status     ModelStatus @default(SHADOW)

  artifactPath String // S3 URI

  companyId     String
  company       Company      @relation(fields: [companyId], references: [id])
  trainingRunId String?
  trainingRun   TrainingRun? @relation(fields: [trainingRunId], references: [id])

  driftReports     DriftReport[]
  approvalRequests ApprovalRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name, version])
  @@index([companyId])
  @@index([hash])
  @@map("rai_model_versions")
}

model TrainingRun {
  id        String         @id @default(cuid())
  featureId String // e.g. "rapeseed_yield_prediction"
  status    TrainingStatus @default(PENDING)

  config  Json?
  metrics Json?

  models ModelVersion[]

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyId])
  @@index([status])
  @@map("rai_training_runs")
}

model DriftReport {
  id             String       @id @default(cuid())
  modelVersionId String
  modelVersion   ModelVersion @relation(fields: [modelVersionId], references: [id])

  psiScore     Float?
  klDivergence Float?
  ksTestStat   Float?

  status  DriftStatus @default(NORMAL)
  payload Json

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([modelVersionId])
  @@map("rai_drift_reports")
}

model LearningEvent {
  id        String @id @default(cuid())
  featureId String
  event     String // Required by AuditService
  payload   Json
  signature String

  processedAt DateTime?
  createdAt   DateTime  @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([featureId])
  @@map("rai_learning_events")
}

enum ModelStatus {
  DRAFT
  SHADOW
  CANARY
  ACTIVE
  ARCHIVED
  FAILED
  QUARANTINED
  ROLLED_BACK
}

enum TrainingStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum DriftStatus {
  NORMAL
  WARNING
  CRITICAL
}

// --- Level E: Regenerative Optimization Domain ---

model SoilMetric {
  id        String   @id @default(cuid())
  fieldId   String
  companyId String
  authorId  String // createdBy
  timestamp DateTime @default(now())

  // Physical-Chemical
  sri Float // Soil Regeneration Index [0.0 - 1.0]
  om  Float // Organic Matter %
  ph  Float // pH Level

  // Provenance & Trust (Hardened)
  source             DataSourceType
  signature          Bytes? // RSA/Ed25519 signature
  publicKeyId        String?
  trustScoreSnapshot Float              @default(1.0)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?

  field   Field   @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])

  @@index([companyId, fieldId, timestamp])
  @@map("rai_soil_metrics")
}

model SustainabilityBaseline {
  id        String   @id @default(cuid())
  fieldId   String   @unique
  companyId String
  version   Int      @default(1)
  locked    Boolean  @default(true)
  createdAt DateTime @default(now())

  initialSri Float
  targetSRI  Float

  // Trust Context (Audit)
  genesisHash   String // Link to Genesis Ledger
  trustSnapshot Json // Snapshot of trust context at creation

  field   Field   @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, fieldId, version])
  @@map("rai_sustainability_baselines")
}

model BiodiversityMetric {
  id        String @id @default(cuid())
  seasonId  String @unique
  companyId String

  bps          Float // Biodiversity Pressure Score [0.0 - 1.0]
  shannonIndex Float
  monoPenalty  Float

  season  Season  @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, seasonId])
  @@map("rai_biodiversity_metrics")
}

model GovernanceLock {
  id        String               @id @default(cuid())
  fieldId   String               @unique
  companyId String
  isActive  Boolean              @default(false)
  lockedAt  DateTime             @default(now())
  reason    GovernanceLockReason

  recoverySeasons Int @default(0)

  field   Field   @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, fieldId])
  @@map("rai_governance_locks")
}

model OverrideRequest {
  id         String           @id @default(cuid())
  companyId  String
  fieldId    String
  strategyId String
  authorId   String // createdBy
  approverId String?
  status     OverrideStatus   @default(PENDING)
  category   OverrideCategory
  createdAt  DateTime         @default(now())

  deltaSRI   Float
  confidence Float // Model confidence at time of request

  // Financial Link
  transactionId String? // ID of the economic event / ledger entry

  field    Field   @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  author   User    @relation(fields: [authorId], references: [id])
  approver User?   @relation("OverrideApprover", fields: [approverId], references: [id])

  @@index([companyId, fieldId, createdAt])
  @@map("rai_override_requests")
}

model ApprovalRequest {
  id            String       @id @default(cuid())
  modelId       String
  model         ModelVersion @relation(fields: [modelId], references: [id])
  requesterId   String
  reviewerId    String?
  status        String       @default("PENDING") // PENDING, APPROVED, REJECTED
  notes         String?      @db.Text
  reviewComment String?      @db.Text
  reviewedAt    DateTime?
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@map("rai_approval_requests")
}

enum DataSourceType {
  SATELLITE
  LAB
  SENSOR
  USER_INPUT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
}

enum GovernanceLockReason {
  DEGRADATION_I34
  BIO_PRESSURE_I36
  FORCE_MAJEURE
}

enum OverrideStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}

enum OverrideCategory {
  FINANCIAL_PRESSURE
  MODEL_DISTRUST
  EXTREME_WEATHER
}

// --- Level F: Institutional Oracle Standard ---

model LevelFCertAudit {
  id               String          @id @default(cuid())
  timestamp        DateTime        @default(now())
  initiatorProcess String
  snapshotHash     String // Хэш снимка данных Level E
  kidUsed          String // ID ключа HSM
  quorumReceipt    String? // Ссылка на Multisig-tx (если Governance)
  status           CertAuditStatus @default(SIGNATURE_INTENT)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, snapshotHash])
  @@index([timestamp])
  @@map("level_f_cert_audit")
}

// --- Phase 2.5: Institutional Escalation Core ---

model GovernanceCommittee {
  id              String @id @default(cuid())
  name            String
  version         Int    @default(1)
  members         Json // Array of { userId: string, weight: float }
  quorumThreshold Float  @default(0.66)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  quorumProcesses QuorumProcess[]

  @@unique([name, companyId, version])
  @@map("governance_committees")
}

model QuorumProcess {
  id      String       @id @default(cuid())
  traceId String       @unique
  status  QuorumStatus @default(COLLECTING)

  committeeId      String
  committeeVersion Int
  committee        GovernanceCommittee @relation(fields: [committeeId], references: [id])

  signatures GovernanceSignature[]

  // Optional links for context (Traceability)
  cmrRiskId        String?
  decisionRecordId String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?

  @@index([traceId])
  @@map("governance_quorum_processes")
}

model GovernanceSignature {
  id          String @id @default(cuid())
  signature   String // Ed25519 hex
  pubKey      String // hex
  payloadHash String // sha256

  signerId String
  signer   User   @relation(fields: [signerId], references: [id])

  quorumProcessId String
  quorumProcess   QuorumProcess @relation(fields: [quorumProcessId], references: [id])

  createdAt DateTime @default(now())

  @@map("governance_signatures")
}

enum CertAuditStatus {
  SIGNATURE_INTENT
  SIGNATURE_COMPLETED
  ERROR
}

enum QuorumStatus {
  COLLECTING
  MET
  REJECTED
  EXPIRED
}

// --- Institutional Exploration Module (IEM) ---

model StrategicSignal {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  initiatorId String?
  initiator   User?   @relation("StrategicSignalInitiator", fields: [initiatorId], references: [id])

  source          SignalSource
  rawPayload      Json
  confidenceScore Int          @default(0)

  duplicateOfId String?
  duplicateOf   StrategicSignal?  @relation("StrategicSignalDuplicateChain", fields: [duplicateOfId], references: [id])
  duplicates    StrategicSignal[] @relation("StrategicSignalDuplicateChain")

  status    SignalStatus @default(RAW)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  explorationCases ExplorationCase[]

  @@index([companyId])
  @@index([companyId, status])
  @@index([companyId, source])
  @@index([duplicateOfId])
  @@map("exploration_strategic_signals")
}

model ExplorationCase {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  signalId String?
  signal   StrategicSignal? @relation(fields: [signalId], references: [id])

  initiatorId String?
  initiator   User?   @relation("ExplorationCaseInitiator", fields: [initiatorId], references: [id])

  explorationMode ExplorationMode
  type            ExplorationType
  status          ExplorationCaseStatus @default(DRAFT)
  triageConfig    Json?

  economicImpactEstimate Decimal? @db.Decimal(18, 4)
  riskScore               Int?
  resourceCost            Decimal? @db.Decimal(18, 4)
  expectedROI             Decimal? @db.Decimal(18, 4)
  ownerId                 String?
  owner                   User?    @relation("ExplorationCaseOwner", fields: [ownerId], references: [id])
  timeboxDeadline         DateTime?
  timeboxStatus           TimeboxStatus @default(ON_TRACK)

  riskLevel           ExplorationRiskLevel?
  budgetImpact        Decimal? @db.Decimal(18, 4)
  requiresBoardReview Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  warRoomSessions   WarRoomSession[]
  impactAuditRecord ImpactAuditRecord[]
  rewardRecords     RewardRecord[]

  @@index([companyId])
  @@index([companyId, status])
  @@index([companyId, explorationMode])
  @@index([signalId])
  @@index([timeboxDeadline])
  @@map("exploration_cases")
}

model WarRoomSession {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  explorationCaseId String
  explorationCase   ExplorationCase @relation(fields: [explorationCaseId], references: [id])

  facilitatorId String
  facilitator   User   @relation("WarRoomFacilitator", fields: [facilitatorId], references: [id])

  participants Json
  deadline     DateTime
  status       WarRoomStatus @default(ACTIVE)
  resolutionLog Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  decisionEvents WarRoomDecisionEvent[]

  @@index([companyId])
  @@index([explorationCaseId])
  @@index([companyId, status])
  @@index([deadline])
  @@map("war_room_sessions")
}

model WarRoomDecisionEvent {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  warRoomSessionId String
  warRoomSession   WarRoomSession @relation(fields: [warRoomSessionId], references: [id])

  participantId String
  participant   User   @relation(fields: [participantId], references: [id])

  decisionData  Json
  signatureHash String
  createdAt     DateTime @default(now())

  @@index([companyId])
  @@index([warRoomSessionId])
  @@index([participantId])
  @@index([companyId, createdAt])
  @@map("war_room_decision_events")
}

model ImpactAuditRecord {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  explorationCaseId String
  explorationCase   ExplorationCase @relation(fields: [explorationCaseId], references: [id])

  auditWindowDays Int
  expectedROI     Decimal   @db.Decimal(18, 4)
  actualROI       Decimal   @db.Decimal(18, 4)
  actualRoiSource RoiSource
  evidenceRefs    Json
  delta           Decimal   @db.Decimal(18, 4)
  verdict         ImpactVerdict
  auditedAt       DateTime  @default(now())
  createdAt       DateTime  @default(now())

  rewardRecords RewardRecord[]

  @@index([companyId])
  @@index([explorationCaseId])
  @@index([companyId, verdict])
  @@map("impact_audit_records")
}

model RewardRecord {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  explorationCaseId String
  explorationCase   ExplorationCase @relation(fields: [explorationCaseId], references: [id])

  initiatorId String
  initiator   User   @relation("RewardRecordInitiator", fields: [initiatorId], references: [id])

  impactAuditId String
  impactAudit   ImpactAuditRecord @relation(fields: [impactAuditId], references: [id])

  rewardType   RewardType
  rewardAmount Decimal? @db.Decimal(18, 4)
  formula      String
  status       RewardStatus @default(PENDING)

  approvedBy String?
  approver   User?   @relation("RewardRecordApprover", fields: [approvedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([initiatorId])
  @@index([status])
  @@index([impactAuditId])
  @@map("reward_records")
}

model LabCapacityConfig {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  maxActiveSEU    Int @default(5)
  maxActiveCDU    Int @default(10)
  overdueGraceDays Int @default(14)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId])
  @@map("lab_capacity_configs")
}

model ExternalSourceAllowlist {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  sourceName      String
  baseUrl         String?
  status          AllowlistStatus @default(ACTIVE)
  lastValidatedAt DateTime?
  metadata        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scanRuns AIScanRunLog[]

  @@unique([companyId, sourceName])
  @@index([companyId, status])
  @@map("external_source_allowlist")
}

model AIScanRunLog {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  sourceAllowlistId String?
  sourceAllowlist   ExternalSourceAllowlist? @relation(fields: [sourceAllowlistId], references: [id])

  status AIScanRunStatus @default(STARTED)

  runStartedAt  DateTime @default(now())
  runFinishedAt DateTime?
  scannedItems  Int      @default(0)
  createdSignals Int     @default(0)
  errorMessage  String?
  metadata      Json?

  @@index([companyId])
  @@index([status])
  @@index([sourceAllowlistId])
  @@index([companyId, runStartedAt])
  @@map("ai_scan_run_logs")
}

enum SignalSource {
  MARKET
  CLIENT
  AI
  INTERNAL
}

enum SignalStatus {
  RAW
  TRIAGED
  ARCHIVED
}

enum TriageStatus {
  PENDING
  ACCEPTED
  DUPLICATE
  REJECTED
}

enum ExplorationMode {
  SEU
  CDU
}

enum ExplorationType {
  PROBLEM
  IDEA
  RESEARCH
  REGULATORY
  OPPORTUNITY
}

enum ExplorationCaseStatus {
  DRAFT
  IN_TRIAGE
  BOARD_REVIEW
  ACTIVE_EXPLORATION
  WAR_ROOM
  RESOLVED
  REJECTED
  IMPLEMENTED
  POST_AUDIT
  ARCHIVED
}

enum ExplorationRiskLevel {
  R1
  R2
  R3
  R4
}

enum TimeboxStatus {
  ON_TRACK
  WARNING
  OVERDUE
  ARCHIVED_TIMEOUT
}

enum WarRoomStatus {
  ACTIVE
  RESOLVED_WITH_DECISION
  TIMEOUT
}

enum RoiSource {
  LEDGER
  FINANCE_REPORT
  MANUAL_CONFIRMED
}

enum ImpactVerdict {
  SUCCESS
  PARTIAL
  FAILED
}

enum RewardType {
  BONUS
  EQUITY_SHARE
  CAREER_UPGRADE
  RECOGNITION
}

enum RewardStatus {
  PENDING
  APPROVED
  PAID
}

enum AllowlistStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum AIScanRunStatus {
  STARTED
  COMPLETED
  FAILED
}

// --- Institutional Commerce Core ---

enum PartyRelationType {
  OWNERSHIP
  COMMERCIAL
  AFFILIATION
}

enum PartyEntityType {
  HOLDING
  LEGAL_ENTITY
  IP
  KFH
  MANAGEMENT_CO
  BANK
  INSURER
}

enum PartyEntityStatus {
  ACTIVE
  FROZEN
}

enum AssetLinkType {
  FARM
  FIELD
  OBJECT
}

enum AssetPartyRoleType {
  OWNER
  OPERATOR
  LESSEE
  MANAGER
  BENEFICIARY
}

enum CommerceContractStatus {
  DRAFT
  SIGNED
  TERMINATED
}

enum CommerceContractPartyRoleType {
  SELLER
  BUYER
  LESSOR
  LESSEE
  AGENT
  PRINCIPAL
  PAYER
  BENEFICIARY
}

enum CommerceObligationType {
  DELIVER
  PAY
  PERFORM
}

enum CommerceObligationStatus {
  OPEN
  PARTIAL
  FULFILLED
}

enum CommerceEventDomain {
  COMMERCIAL
  PRODUCTION
  LOGISTICS
  FINANCE_ADJ
}

enum CommerceEventType {
  GOODS_SHIPMENT
  SERVICE_ACT
  LEASE_USAGE
  MATERIAL_CONSUMPTION
  HARVEST
  INTERNAL_TRANSFER
  WRITE_OFF
}

enum InvoiceDirection {
  AR
  AP
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  POSTED
  PARTIALLY_PAID
  PAID
  CLOSED
  VOID
}

enum PaymentStatus {
  DRAFT
  CONFIRMED
  REVERSED
}

enum RegulatoryArtifactStatus {
  PENDING
  ISSUED
  REJECTED
  ACCEPTED
}

enum ArtifactSourceType {
  INVOICE
  FULFILLMENT_EVENT
}

model Jurisdiction {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code String
  name String

  parties            Party[]
  regulatoryProfiles RegulatoryProfile[]
  contracts          CommerceContract[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@unique([companyId, code])
  @@map("commerce_jurisdictions")
}

model RegulatoryProfile {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code           String
  name           String
  jurisdictionId String
  jurisdiction   Jurisdiction @relation(fields: [companyId, jurisdictionId], references: [companyId, id])
  rulesJson      Json?

  isSystemPreset Boolean   @default(false)
  effectiveFrom  DateTime?
  effectiveTo    DateTime?
  vatRate        Decimal?
  currencyCode   String?


  parties           Party[]
  contracts         CommerceContract[]
  fulfillmentEvents CommerceFulfillmentEvent[]
  revenueRecEvents  RevenueRecognitionEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@unique([companyId, code])
  @@map("commerce_regulatory_profiles")
}

model Party {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  type                PartyEntityType   @default(LEGAL_ENTITY)
  legalName           String
  shortName           String?
  jurisdictionId      String
  jurisdiction        Jurisdiction       @relation(fields: [companyId, jurisdictionId], references: [companyId, id])
  status              PartyEntityStatus  @default(ACTIVE)
  comment             String?
  regulatoryProfileId String?
  regulatoryProfile   RegulatoryProfile? @relation(fields: [companyId, regulatoryProfileId], references: [companyId, id])
  registrationData    Json?

  sourceRelations PartyRelation[] @relation("PartyRelationSource")
  targetRelations PartyRelation[] @relation("PartyRelationTarget")
  assetRoles      AssetPartyRole[]

  contractRoles    CommerceContractPartyRole[]
  outboundPayments Payment[]                   @relation("PaymentPayer")
  inboundPayments  Payment[]                   @relation("PaymentPayee")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@index([companyId, legalName])
  @@map("commerce_parties")
}

model AssetPartyRole {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  assetId   String
  assetType AssetLinkType
  partyId   String
  party     Party @relation(fields: [companyId, partyId], references: [companyId, id])

  role      AssetPartyRoleType
  validFrom DateTime
  validTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@index([companyId, partyId, assetType])
  @@index([companyId, assetId, assetType])
  @@map("commerce_asset_party_roles")
}

model PartyRelation {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  sourcePartyId String
  sourceParty   Party  @relation("PartyRelationSource", fields: [companyId, sourcePartyId], references: [companyId, id])
  targetPartyId String
  targetParty   Party  @relation("PartyRelationTarget", fields: [companyId, targetPartyId], references: [companyId, id])

  relationType PartyRelationType
  validFrom    DateTime
  validTo      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@index([companyId, sourcePartyId, targetPartyId, relationType])
  @@map("commerce_party_relations")
}

model CommerceContract {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  number              String
  type                String
  status              CommerceContractStatus @default(DRAFT)
  validFrom           DateTime
  validTo             DateTime?
  jurisdictionId      String
  jurisdiction        Jurisdiction           @relation(fields: [companyId, jurisdictionId], references: [companyId, id])
  regulatoryProfileId String?
  regulatoryProfile   RegulatoryProfile?     @relation(fields: [companyId, regulatoryProfileId], references: [companyId, id])

  roles              CommerceContractPartyRole[]
  obligations        CommerceObligation[]
  budgetReservations BudgetReservation[]
  paymentSchedules   PaymentSchedule[]
  invoices           Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@unique([companyId, number])
  @@map("commerce_contracts")
}

model CommerceContractPartyRole {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  contractId String
  contract   CommerceContract              @relation(fields: [companyId, contractId], references: [companyId, id])
  partyId    String
  party      Party                         @relation(fields: [companyId, partyId], references: [companyId, id])
  role       CommerceContractPartyRoleType
  isPrimary  Boolean                       @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@unique([companyId, contractId, partyId, role])
  @@map("commerce_contract_party_roles")
}

model CommerceObligation {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  contractId String
  contract   CommerceContract         @relation(fields: [companyId, contractId], references: [companyId, id])
  type       CommerceObligationType
  status     CommerceObligationStatus @default(OPEN)
  dueDate    DateTime?
  termsJson  Json?

  fulfillmentEvents  CommerceFulfillmentEvent[]
  budgetReservations BudgetReservation[]
  paymentSchedules   PaymentSchedule[]
  invoices           Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_obligations")
}

model BudgetReservation {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  contractId   String?
  contract     CommerceContract?   @relation(fields: [companyId, contractId], references: [companyId, id])
  obligationId String?
  obligation   CommerceObligation? @relation(fields: [companyId, obligationId], references: [companyId, id])
  amount       Decimal             @db.Decimal(18, 4)
  currency     String
  periodId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_budget_reservations")
}

model PaymentSchedule {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  contractId   String?
  contract     CommerceContract?   @relation(fields: [companyId, contractId], references: [companyId, id])
  obligationId String?
  obligation   CommerceObligation? @relation(fields: [companyId, obligationId], references: [companyId, id])
  invoiceId    String?
  invoice      Invoice?            @relation(fields: [companyId, invoiceId], references: [companyId, id])
  dueDate      DateTime
  percentage   Decimal?            @db.Decimal(8, 4)
  amount       Decimal?            @db.Decimal(18, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_payment_schedules")
}

model CommerceFulfillmentEvent {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  obligationId        String
  obligation          CommerceObligation  @relation(fields: [companyId, obligationId], references: [companyId, id])
  eventDomain         CommerceEventDomain
  eventType           CommerceEventType
  eventDate           DateTime
  assetId             String?
  payloadJson         Json?
  proofDocumentId     String?
  regulatoryProfileId String?
  regulatoryProfile   RegulatoryProfile?  @relation(fields: [companyId, regulatoryProfileId], references: [companyId, id])

  stockMoves          StockMove[]
  revenueRecEvents    RevenueRecognitionEvent[]
  invoices            Invoice[]
  regulatoryArtifacts RegulatoryArtifact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@index([companyId, obligationId, eventDomain, eventType])
  @@map("commerce_fulfillment_events")
}

model StockMove {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  fulfillmentEventId String
  fulfillmentEvent   CommerceFulfillmentEvent @relation(fields: [companyId, fulfillmentEventId], references: [companyId, id])
  itemId             String
  uom                String
  qty                Decimal                  @db.Decimal(18, 4)
  fromLocationId     String?
  toLocationId       String?
  batchId            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_stock_moves")
}

model RevenueRecognitionEvent {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  fulfillmentEventId  String
  fulfillmentEvent    CommerceFulfillmentEvent @relation(fields: [companyId, fulfillmentEventId], references: [companyId, id])
  recognitionPolicyId String?
  regulatoryProfileId String?
  regulatoryProfile   RegulatoryProfile?       @relation(fields: [companyId, regulatoryProfileId], references: [companyId, id])
  recognizedAt        DateTime                 @default(now())
  payloadJson         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_revenue_recognition_events")
}

model Invoice {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  contractId         String
  contract           CommerceContract          @relation(fields: [companyId, contractId], references: [companyId, id])
  obligationId       String
  obligation         CommerceObligation        @relation(fields: [companyId, obligationId], references: [companyId, id])
  fulfillmentEventId String?
  fulfillmentEvent   CommerceFulfillmentEvent? @relation(fields: [companyId, fulfillmentEventId], references: [companyId, id])
  direction          InvoiceDirection
  status             InvoiceStatus             @default(DRAFT)
  subtotal           Decimal                   @db.Decimal(18, 4)
  taxTotal           Decimal                   @db.Decimal(18, 4)
  grandTotal         Decimal                   @db.Decimal(18, 4)
  taxSnapshotJson    Json
  ledgerTxId         String?                   @unique

  paymentSchedules    PaymentSchedule[]
  paymentAllocations  PaymentAllocation[]
  regulatoryArtifacts RegulatoryArtifact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_invoices")
}

model Payment {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  payerPartyId  String
  payerParty    Party         @relation("PaymentPayer", fields: [companyId, payerPartyId], references: [companyId, id])
  payeePartyId  String
  payeeParty    Party         @relation("PaymentPayee", fields: [companyId, payeePartyId], references: [companyId, id])
  amount        Decimal       @db.Decimal(18, 4)
  currency      String
  paidAt        DateTime
  paymentMethod String
  status        PaymentStatus @default(DRAFT)
  ledgerTxId    String?       @unique

  allocations PaymentAllocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_payments")
}

model PaymentAllocation {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  paymentId       String
  payment         Payment  @relation(fields: [companyId, paymentId], references: [companyId, id])
  invoiceId       String?
  invoice         Invoice? @relation(fields: [companyId, invoiceId], references: [companyId, id])
  allocatedAmount Decimal  @db.Decimal(18, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_payment_allocations")
}

model RegulatoryArtifact {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  sourceType         ArtifactSourceType
  invoiceId          String?
  invoice            Invoice?                  @relation(fields: [companyId, invoiceId], references: [companyId, id])
  fulfillmentEventId String?
  fulfillmentEvent   CommerceFulfillmentEvent? @relation(fields: [companyId, fulfillmentEventId], references: [companyId, id])
  artifactType       String
  payloadRef         String?
  status             RegulatoryArtifactStatus  @default(PENDING)
  externalRefId      String?
  issuedAt           DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, id])
  @@map("commerce_regulatory_artifacts")
}

model AgroEventDraft {
  id           String   @id @default(cuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id])
  userId       String            // telegram user id or internal principal
  status       String            // 'DRAFT' | 'READY_FOR_CONFIRM' | 'COMMITTED'
  eventType    String
  timestamp    DateTime
  farmRef      String?
  fieldRef     String?
  taskRef      String?
  payloadJson  Json
  evidenceJson Json
  confidence   Float
  missingMust  String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  expiresAt    DateTime          // now + 7 days

  @@index([companyId, userId])
  @@index([expiresAt])
  @@map("agro_event_drafts")
}

model AgroEventCommitted {
  id              String   @id
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])
  farmRef         String?
  fieldRef        String?
  taskRef         String?
  eventType       String
  payloadJson     Json
  evidenceJson    Json
  timestamp       DateTime
  committedAt     DateTime @default(now())
  committedBy     String
  provenanceHash  String

  @@index([companyId, eventType])
  @@index([farmRef, timestamp])
  @@index([fieldRef, timestamp])
  @@map("agro_events_committed")
}

model AgroEscalation {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  
  metricKey  String
  severity   String   // S1..S4
  reason     String
  status     String   @default("OPEN") // OPEN | RESOLVED | CLOSED
  
  references Json     // { taskRef, fieldRef, eventId }
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([companyId, status])
  @@map("agro_escalations")
}
