/**
 * KPI Types - Phase 1.1
 * 
 * Canon: KPI рассчитываются ТОЛЬКО из Events.
 * Принцип: Один и тот же набор Events → всегда один и тот же KPI.
 * 
 * АРХИТЕКТУРНЫЕ ПРАВИЛА:
 * 1. ДЕТЕРМИНИЗМ: calculated_at передаётся извне, не влияет на расчёт
 * 2. РАЗДЕЛЕНИЕ: Engine фильтрует → Formula считает
 * 3. ЧИСТОТА: нет состояния, нет side effects
 */

import { EventType, IEvent } from './event.types';

// =============================================================================
// CALCULATION PERIOD
// =============================================================================

/**
 * Периоды расчёта KPI
 */
export type CalculationPeriod = 'daily' | 'weekly' | 'monthly';

// =============================================================================
// KPI CONTEXT (INPUT)
// =============================================================================

/**
 * Контекст для расчёта KPI
 * 
 * Передаётся в Engine, определяет фильтрацию по периоду и субъекту.
 */
export interface IKPIContext {
    /** ID пользователя для которого считаем KPI */
    user_id: string;
    /** Начало периода (inclusive) */
    period_start: Date;
    /** Конец периода (inclusive) */
    period_end: Date;
    /** ID роли (опционально для контекста) */
    role_id?: string;
    /** ID филиала (опционально для контекста) */
    branch_id?: string;
}

// =============================================================================
// KPI FORMULA (PURE FUNCTION)
// =============================================================================

/**
 * KPI Formula - чистая функция расчёта
 * 
 * ПРАВИЛА:
 * - Получает ТОЛЬКО релевантные Events (уже отфильтрованные)
 * - Выполняет ТОЛЬКО математическую функцию
 * - НЕ фильтрует по датам (это делает Engine)
 * - НЕ обращается к БД, хранилищам, внешним источникам
 * - НЕ генерирует id, timestamps
 */
export interface IKPIFormula {
    /** Уникальное имя формулы */
    name: string;
    /** Описание формулы */
    description: string;
    /** Типы событий, из которых вычисляется KPI */
    source_events: EventType[];
    /** Период расчёта */
    calculation_period: CalculationPeriod;
    /** Единица измерения */
    unit: string;
    /**
     * Чистая функция расчёта
     * 
     * @param events - ТОЛЬКО релевантные события (уже отфильтрованы Engine)
     * @returns Числовое значение KPI
     * 
     * ДЕТЕРМИНИЗМ: одни и те же events → один и тот же result
     */
    calculate: (events: IEvent[]) => number;
}

// =============================================================================
// KPI RESULT (OUTPUT)
// =============================================================================

/**
 * Результат расчёта KPI
 * 
 * Детерминированная часть: kpi_name, value, unit, period_start, period_end, source_event_ids
 * Недетерминированная часть: calculated_at (передаётся извне, не влияет на расчёт)
 */
export interface IKPIResult {
    /** Имя KPI */
    kpi_name: string;
    /** Рассчитанное значение */
    value: number;
    /** Единица измерения */
    unit: string;
    /** Начало периода */
    period_start: Date;
    /** Конец периода */
    period_end: Date;
    /** IDs событий, из которых рассчитан KPI (для трейсинга) */
    source_event_ids: string[];
    /**
     * Время расчёта
     * 
     * ВАЖНО: НЕ используется в расчётах!
     * Передаётся извне только для логирования/аудита.
     */
    calculated_at: Date;
}

// =============================================================================
// KPI CALCULATION INPUT
// =============================================================================

/**
 * Вход для Engine.calculate()
 * 
 * Содержит всё необходимое для детерминированного расчёта.
 */
export interface IKPICalculationInput {
    /** Формула для расчёта */
    formula: IKPIFormula;
    /** Все события (Engine отфильтрует нужные) */
    events: IEvent[];
    /** Контекст расчёта */
    context: IKPIContext;
    /**
     * Время расчёта (для calculated_at в результате)
     * 
     * ВНЕШНИЙ ПАРАМЕТР: передаётся извне, не влияет на расчёт.
     */
    calculated_at: Date;
}

// =============================================================================
// KPI REGISTRY
// =============================================================================

/**
 * Реестр всех доступных формул
 * 
 * Используется для lookup по имени и типу события.
 */
export interface IKPIFormulaRegistry {
    /** Все зарегистрированные формулы */
    formulas: IKPIFormula[];
    /** Получить формулу по имени */
    getByName: (name: string) => IKPIFormula | undefined;
    /** Получить формулы по типу события */
    getByEventType: (eventType: EventType) => IKPIFormula[];
}

// =============================================================================
// TYPE HELPERS
// =============================================================================

/**
 * Input для создания KPIResult без calculated_at (передаётся отдельно)
 */
export type CreateKPIResultInput = Omit<IKPIResult, 'calculated_at'>;

/**
 * Тип функции-калькулятора
 */
export type KPICalculateFn = (events: IEvent[]) => number;
