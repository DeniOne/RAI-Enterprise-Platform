/**
 * Reward Types - Phase 1.3
 * 
 * Canon: Reward — следствие, не причина.
 * Принцип: Одни Events → одни Rewards.
 * 
 * АРХИТЕКТУРНЫЕ ПРАВИЛА:
 * 1. REWARD ≠ РЕШЕНИЕ: Engine рассчитывает, не начисляет
 * 2. ТРИГГЕРЫ: только Events (не KPI thresholds)
 * 3. ДЕТЕРМИНИЗМ: calculated_at передаётся извне
 */

import { EventType, IEvent } from './event.types';

// =============================================================================
// REWARD CURRENCY
// =============================================================================

/**
 * Reward Currency - тип валюты вознаграждения
 */
export type RewardCurrency = 'MC' | 'GMC' | 'RUB';

// =============================================================================
// REWARD TRIGGER
// =============================================================================

/**
 * Reward Trigger - триггер вознаграждения
 * 
 * Триггеры реагируют ТОЛЬКО на Events.
 * НЕ на KPI thresholds напрямую.
 */
export interface IRewardTrigger {
    /** Тип события-триггера */
    event_type: EventType;
}

// =============================================================================
// REWARD INPUT
// =============================================================================

/**
 * Reward Input - вход для расчёта вознаграждений
 */
export interface IRewardInput {
    /** Событие, для которого рассчитываем вознаграждения */
    event: IEvent;
    /** ID пользователя */
    user_id: string;
    /**
     * Время расчёта
     * 
     * ВНЕШНИЙ ПАРАМЕТР: передаётся извне, не влияет на расчёт.
     */
    calculated_at: Date;
}

// =============================================================================
// REWARD RULE
// =============================================================================

/**
 * Reward Rule - правило вознаграждения
 * 
 * ЧИСТАЯ ФУНКЦИЯ:
 * - check() проверяет только дополнительные условия
 * - Не дублирует trigger
 * - Не читает БД
 * - Нет side effects
 */
export interface IRewardRule {
    /** Уникальное имя правила */
    name: string;
    /** Описание правила */
    description: string;
    /** Триггер (тип события) */
    trigger: IRewardTrigger;
    /** Сумма вознаграждения */
    amount: number;
    /** Валюта */
    currency: RewardCurrency;
    /**
     * Чистая функция проверки дополнительных условий
     * 
     * @param input - Входные данные
     * @returns true если все условия выполнены
     * 
     * ВАЖНО: trigger уже проверен Engine.
     * check() проверяет ДОПОЛНИТЕЛЬНЫЕ условия (payload и т.д.)
     */
    check: (input: IRewardInput) => boolean;
}

// =============================================================================
// REWARD CALCULATION (OUTPUT)
// =============================================================================

/**
 * Reward Calculation - результат расчёта вознаграждения
 * 
 * Это РАСЧЁТ, не начисление.
 * Engine только рассчитывает — решение о начислении принимается отдельно.
 */
export interface IRewardCalculation {
    /** Имя правила */
    rule_name: string;
    /** Сумма */
    amount: number;
    /** Валюта */
    currency: RewardCurrency;
    /** Причина (описание правила) */
    reason: string;
    /** ID пользователя */
    user_id: string;
    /** ID исходного события (для трейсинга) */
    source_event_id: string;
    /**
     * Время расчёта
     * 
     * ВАЖНО: НЕ используется в расчётах!
     * Передаётся извне только для логирования.
     */
    calculated_at: Date;
}

// =============================================================================
// TYPE HELPERS
// =============================================================================

/**
 * Input для создания RewardCalculation без calculated_at
 */
export type CreateRewardCalculationInput = Omit<IRewardCalculation, 'calculated_at'>;
